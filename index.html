<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FCI - Sistema de Gesti贸n Documental</title>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
<script src="https://widget.cloudinary.com/v2.0/global/all.js" type="text/javascript"></script>

<style>
    /* ... (Mismos estilos anteriores) ... */
    body{font-family:'Segoe UI', sans-serif; margin:0; padding:0; background:#f0f2f5; color:#333;}
    .hidden { display: none !important; }
    .app-container { max-width: 1200px; margin: 20px auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 0 15px rgba(0,0,0,0.05); }
    header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #f0f0f0; padding-bottom: 15px; margin-bottom: 20px; }
    
    /* ESTILOS DEL BOTN DE NOTIFICACIONES */
    .nav-actions { display: flex; align-items: center; gap: 20px; }
    .notification-btn { position: relative; background: none; border: none; cursor: pointer; font-size: 24px; padding: 5px; }
    .badge { position: absolute; top: 0; right: 0; background: red; color: white; border-radius: 50%; padding: 2px 6px; font-size: 10px; font-weight: bold; }
    
    /* PANEL DE NOTIFICACIONES */
    .notif-dropdown { position: absolute; top: 60px; right: 20px; width: 300px; background: white; border: 1px solid #ddd; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); z-index: 1000; max-height: 400px; overflow-y: auto; }
    .notif-item { padding: 12px; border-bottom: 1px solid #eee; font-size: 13px; cursor: pointer; }
    .notif-item:hover { background: #f8f9fa; }
    .notif-item.unread { border-left: 4px solid #007bff; background: #ebf5ff; }
    .notif-header { padding: 10px; background: #007bff; color: white; border-radius: 8px 8px 0 0; font-weight: bold; display: flex; justify-content: space-between; }

    /* ESTILOS MODAL Y TABLAS (Igual que antes) */
    .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 10000; }
    .modal-content { background: white; padding: 25px; border-radius: 10px; width: 90%; max-width: 800px; max-height: 90vh; overflow-y: auto; }
    .btn-action { padding: 8px 12px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
    .status-rechazado { background: #dc3545; color: white; padding: 2px 6px; border-radius: 4px; font-size: 12px; }
</style>
</head>
<body>

<div id="view-app" class="app-container hidden">
    <header>
        <div>
            <h1>Panel de Control</h1>
            <small>Bienvenido, <span id="userNameDisplay"></span></small>
        </div>
        
        <div class="nav-actions">
            <button class="notification-btn" onclick="toggleNotificaciones()">
                 <span id="notif-count" class="badge hidden">0</span>
            </button>
            
            <button onclick="logout()" class="btn-logout">Cerrar Sesi贸n</button>
        </div>
    </header>

    <div id="notif-panel" class="notif-dropdown hidden">
        <div class="notif-header">
            <span>Notificaciones</span>
            <button onclick="toggleNotificaciones()" style="background:none; border:none; color:white; cursor:pointer;">&times;</button>
        </div>
        <div id="notif-list">
            <p style="padding:15px; color:#888;">No tienes notificaciones nuevas.</p>
        </div>
    </div>

    <section>
        <h2>Listado de Solicitudes</h2>
        <table id="tablaSolicitudes">
            <thead><tr><th>ID</th><th>T铆tulo</th><th>Estado</th><th>Solicitante</th><th>Acci贸n</th></tr></thead>
            <tbody></tbody>
        </table>
    </section>
</div>

<div id="modalDetalle" class="modal hidden">
    </div>

<script>
// --- CONFIGURACIN FIREBASE (Usa tus credenciales) ---
const firebaseConfig = { /* ... tus credenciales ... */ };
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

let currentUser = null;
let notificacionesVisibles = false;

// --- SISTEMA DE NOTIFICACIONES ---

function toggleNotificaciones() {
    notificacionesVisibles = !notificacionesVisibles;
    document.getElementById("notif-panel").classList.toggle("hidden", !notificacionesVisibles);
    if(notificacionesVisibles) marcarNotificacionesComoLeidas();
}

function escucharNotificaciones() {
    // Escuchamos notificaciones dirigidas al usuario actual
    db.collection("Notificaciones")
      .where("destinatario", "==", currentUser.nombre)
      .orderBy("fecha", "desc")
      .limit(10)
      .onSnapshot(snap => {
          let count = 0;
          let html = "";
          
          if(snap.empty) {
              html = '<p style="padding:15px; color:#888;">No hay notificaciones.</p>';
          }

          snap.forEach(doc => {
              const n = doc.data();
              if(!n.leido) count++;
              
              html += `
                <div class="notif-item ${!n.leido ? 'unread' : ''}" onclick="verDetalle('${n.solicitudId}')">
                    <strong>${n.titulo}</strong><br>
                    <small>${n.mensaje}</small><br>
                    <span style="font-size:10px; color:#999;">${new Date(n.fecha.seconds*1000).toLocaleString()}</span>
                </div>`;
          });

          document.getElementById("notif-list").innerHTML = html;
          const badge = document.getElementById("notif-count");
          if(count > 0) {
              badge.innerText = count;
              badge.classList.remove("hidden");
          } else {
              badge.classList.add("hidden");
          }
      });
}

async function marcarNotificacionesComoLeidas() {
    const snap = await db.collection("Notificaciones")
        .where("destinatario", "==", currentUser.nombre)
        .where("leido", "==", false).get();
    
    let batch = db.batch();
    snap.forEach(doc => batch.update(doc.ref, { leido: true }));
    await batch.commit();
}

// --- LGICA DE ENVO DE NOTIFICACIN ---

async function enviarNotificacion(destinatario, titulo, mensaje, solicitudId) {
    await db.collection("Notificaciones").add({
        destinatario: destinatario,
        titulo: titulo,
        mensaje: mensaje,
        solicitudId: solicitudId,
        leido: false,
        fecha: new Date()
    });
    
    // Aqu铆 podr铆as integrar EmailJS para enviar el correo real
    console.log(`Simulando env铆o de correo a ${destinatario}: ${mensaje}`);
}

// --- ACTUALIZACIN DE ESTADO CON NOTIFICACIN ---

async function cambiarEstado(nuevoEstado, comentario) {
    const snap = await db.collection("solicitudes").doc(currentSolId).get();
    const d = snap.data();
    let historial = d.historial || [];
    
    historial.push({ fecha: new Date(), accion: nuevoEstado, msg: comentario });

    await db.collection("solicitudes").doc(currentSolId).update({
        estado: nuevoEstado,
        historial: historial
    });

    // NOTIFICAR AL USUARIO
    let tituloNotif = `Actualizaci贸n de Solicitud ${d.fciId}`;
    let msgNotif = `Tu solicitud ha cambiado a: ${nuevoEstado}. Comentario: ${comentario}`;
    
    if(nuevoEstado === "Rechazado Gerencia") {
        tituloNotif = ` Solicitud Rechazada: ${d.fciId}`;
        msgNotif = `Gerencia ha rechazado la solicitud. Motivo: ${comentario}. Puedes corregirla y reenviarla.`;
    }

    await enviarNotificacion(d.usuarioNom, tituloNotif, msgNotif, currentSolId);

    cerrarModal();
    alert("Estado actualizado y usuario notificado.");
}

// --- INICIO ---
function mostrarApp() {
    document.getElementById("view-login").classList.add("hidden");
    document.getElementById("view-app").classList.remove("hidden");
    document.getElementById("userNameDisplay").innerText = currentUser.nombre;
    
    cargarDatos(); // Carga tablas
    escucharNotificaciones(); // Inicia el listener de la campana
}

// ... Resto de funciones (crearSolicitud, login, etc.) ...
</script>
</body>
</html>
