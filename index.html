<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Gesti√≥n</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script> <style>
        :root {
            --primary: #1e40af; --accent: #3b82f6; --bg: #f8fafc;
            --success: #059669; --warning: #d97706; --danger: #dc2626;
            --info: #0891b2; --white: #ffffff; --border: #e2e8f0; --sidebar: #0f172a;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Inter', sans-serif; }
        body { background: var(--bg); color: #1e293b; height: 100vh; display: flex; overflow: hidden; }

        /* Login */
        #login-screen { position: fixed; inset: 0; background: var(--sidebar); display: flex; align-items: center; justify-content: center; z-index: 5000; }
        .login-box { background: var(--white); padding: 40px; border-radius: 24px; max-width: 400px; width: 90%; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5); text-align: center; }

        /* Sidebar Overlay para M√≥viles */
        .sidebar-overlay { display: none; position: fixed; inset: 0; background: rgba(15, 23, 42, 0.6); z-index: 8000; backdrop-filter: blur(2px); opacity: 0; transition: opacity 0.3s ease; }
        .sidebar-overlay.active { display: block; opacity: 1; }

        /* Sidebar */
        .sidebar { width: 280px; background: var(--sidebar); color: white; display: none; flex-direction: column; padding: 20px; border-right: 1px solid rgba(255,255,255,0.1); }
        .nav-link { 
            display: none; align-items: center; padding: 12px; color: #94a3b8; border: none; 
            background: none; cursor: pointer; width: 100%; border-radius: 12px; margin-bottom: 5px; transition: 0.3s; font-size: 14px; text-align: left;
        }
        .nav-link.visible { display: flex; }
        .nav-link:hover { background: rgba(255,255,255,0.05); color: white; }
        .nav-link.active { background: var(--accent); color: white; font-weight: 600; }
        .nav-link span { margin-right: 12px; }

        /* Main Content */
        .main { flex: 1; padding: 30px; overflow-y: auto; display: none; }
        .section { display: none; animation: fadeIn 0.3s ease-out; }
        .section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* Header M√≥vil */
        .mobile-header { display: none; align-items: center; justify-content: space-between; margin-bottom: 20px; }
        .menu-btn { background: var(--white); border: 1px solid var(--border); padding: 8px 12px; border-radius: 8px; color: var(--primary); cursor: pointer; display: flex; align-items: center; gap: 5px; font-weight: 600; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }

        /* UI Elements */
        .card { background: white; padding: 25px; border-radius: 20px; border: 1px solid var(--border); margin-bottom: 20px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; }
        
        label { font-size: 11px; font-weight: 700; color: #64748b; text-transform: uppercase; margin-bottom: 6px; display: block; letter-spacing: 0.5px; }
        input, select, textarea { width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 10px; margin-bottom: 15px; font-size: 14px; background: #fdfdfd; color: inherit; outline:none; transition: 0.2s; }
        input:focus, select:focus, textarea:focus { border-color: var(--accent); box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); }
        input:disabled { background: #e2e8f0; color: #475569; cursor: not-allowed; font-weight: 600; }

        .btn { padding: 12px 20px; border-radius: 10px; border: none; font-weight: 700; cursor: pointer; display: inline-flex; align-items: center; justify-content: center; gap: 8px; transition: 0.2s; font-size: 13px; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-success { background: var(--success); color: white; }
        .btn-warning { background: var(--warning); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-info { background: var(--info); color: white; }
        .btn-ghost { background: #f1f5f9; color: #475569; }
        .btn:hover { filter: brightness(1.1); transform: translateY(-1px); }

        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; padding: 15px; background: #f8fafc; border-bottom: 2px solid var(--border); font-size: 11px; color: #64748b; text-transform: uppercase; white-space: nowrap; }
        td { padding: 15px; border-bottom: 1px solid #f1f5f9; font-size: 13px; }
        
        .table-responsive { overflow-x: auto; width: 100%; }

        .badge { padding: 4px 10px; border-radius: 10px; font-size: 10px; font-weight: 700; text-transform: uppercase; white-space: nowrap; }
        .badge-info { background: #e0f2fe; color: #0369a1; }
        .badge-success { background: #d1fae5; color: #065f46; }
        .badge-warning { background: #fef3c7; color: #92400e; }
        .badge-danger { background: #fee2e2; color: #991b1b; }
        .badge-dark { background: #475569; color: #ffffff; }

        /* Switches & Permisos */
        .access-item { display: flex; align-items: center; justify-content: space-between; padding: 10px; background: #f8fafc; border-radius: 8px; margin-bottom: 5px; border: 1px solid #eee; }
        .switch { position: relative; display: inline-block; width: 34px; height: 18px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; inset: 0; background-color: #cbd5e1; transition: .4s; border-radius: 18px; }
        .slider:before { position: absolute; content: ""; height: 12px; width: 12px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--accent); }
        input:checked + .slider:before { transform: translateX(16px); }

        /* Dise√±o Corporativo para Ajustes/Estructura */
        .settings-list { max-height: 250px; overflow-y: auto; border: 1px solid var(--border); border-radius: 8px; background: #fdfdfd; margin-top: 10px; }
        .settings-item { display: flex; justify-content: space-between; align-items: center; padding: 10px 15px; border-bottom: 1px solid var(--border); font-size: 13px; font-weight: 500; transition: background 0.2s; color: #334155; }
        .settings-item:last-child { border-bottom: none; }
        .settings-item:hover { background: #f1f5f9; }
        .btn-icon-danger { background: none; border: none; color: var(--danger); cursor: pointer; display: flex; align-items: center; justify-content: center; padding: 4px; border-radius: 6px; transition: 0.2s; }
        .btn-icon-danger:hover { background: #fee2e2; }

        /* Modal */
        .modal-overlay { position: fixed; inset: 0; background: rgba(15, 23, 42, 0.8); display: none; align-items: center; justify-content: center; z-index: 4000; backdrop-filter: blur(4px); }
        .modal-content { background: white; width: 95%; max-width: 1200px; height: 90vh; border-radius: 24px; display: grid; grid-template-columns: 1fr 380px; overflow: hidden; }
        
        #chat-box { flex: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 12px; padding: 10px; margin-bottom: 10px; }
        .chat-msg { padding: 10px; background: white; border-radius: 8px; border-left: 4px solid var(--accent); box-shadow: 0 1px 2px rgba(0,0,0,0.05); font-size: 12px; }

        /* Steps */
        .step-container { display: flex; justify-content: space-between; margin: 20px 0; position: relative; }
        .step-container::before { content: ''; position: absolute; top: 12px; left: 0; width: 100%; height: 2px; background: #e2e8f0; z-index: 1; }
        .step { position: relative; z-index: 2; text-align: center; flex: 1; }
        .step-dot { width: 25px; height: 25px; background: white; border: 3px solid #e2e8f0; border-radius: 50%; margin: 0 auto 5px; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: 800; }
        .step.active .step-dot { border-color: var(--primary); background: var(--primary); color: white; }
        .step.done .step-dot { border-color: var(--success); background: var(--success); color: white; }
        .step label { font-size: 9px; text-transform: uppercase; color: #94a3b8; }
        .step.active label { color: var(--primary); font-weight: 800; }
        .completed .step-dot { background: var(--success); border-color: var(--success); color: white; }

        /* Efecto de Datos Bloqueados / Grises */
        .locked-data {
            opacity: 0.55;
            pointer-events: none;
            background-color: #f1f5f9;
            border-radius: 12px;
            padding: 15px;
            border: 1px dashed #94a3b8;
            filter: grayscale(80%);
        }
        .locked-title {
            color: #475569;
            font-size: 12px;
            font-weight: 800;
            text-transform: uppercase;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        #loading-overlay { position: fixed; inset: 0; background: rgba(255,255,255,0.9); z-index: 6000; display: none; align-items: center; justify-content: center; flex-direction: column; }
        .spinner { width: 40px; height: 40px; border: 4px solid #e2e8f0; border-top: 4px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .file-link { color: var(--accent); text-decoration: none; font-weight: 600; display: inline-flex; align-items: center; gap: 5px; }
        .file-link:hover { text-decoration: underline; }
        
        .search-bar { background: #f1f5f9; border: 1px solid #cbd5e1; border-radius: 8px; padding: 10px 15px; width: 100%; max-width: 350px; font-size: 13px; outline: none; margin-bottom: 0; }
        .search-bar:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(30, 64, 175, 0.1); }

        /* =======================================
           DISE√ëO RESPONSIVO (M√ìVILES Y TABLETS)
           ======================================= */
        @media (max-width: 768px) {
            body { flex-direction: column; overflow-y: auto; }
            
            .sidebar { 
                position: fixed !important; 
                left: -300px; 
                top: 0; 
                bottom: 0; 
                z-index: 9000; 
                transition: left 0.3s ease; 
                box-shadow: 5px 0 15px rgba(0,0,0,0.2); 
            }
            .sidebar.open { left: 0; }
            
            .mobile-header { display: flex; }
            
            .main { padding: 15px; overflow-y: visible; }
            
            .grid-2, .grid-3 { grid-template-columns: 1fr; gap: 15px; }
            
            .modal-content { display: flex; flex-direction: column; height: 95vh; max-height: 95vh; overflow-y: auto; width: 95%; padding: 0; }
            .modal-main { padding: 20px; border-right: none; border-bottom: 1px solid var(--border); flex: none; height: auto; }
            .modal-side { border-left: none; height: auto; }
            #chat-box { height: 350px; }
            
            .step label { font-size: 8px; line-height: 1.2; display: inline-block; padding: 0 2px; }
            .step-container::before { top: 10px; }
            .step-dot { width: 20px; height: 20px; font-size: 9px; border-width: 2px; }
            
            h1 { font-size: 22px; }
            .card { padding: 15px; }
            
            /* Ajuste botones top en listados */
            .btn { width: 100%; justify-content: center; }
            .search-bar { max-width: 100%; margin-bottom: 10px; }
            #sec-listado > div:first-child, #sec-hist > div:first-child, #sec-gest > div:first-child { flex-direction: column; align-items: stretch; }
            #sec-listado > div:first-child > div, #sec-hist > .card > div:first-child, #sec-gest > .card > div:first-child { flex-direction: column; align-items: stretch; }
        }
    </style>
</head>
<body>

    <div id="loading-overlay">
        <div class="spinner" style="margin-bottom: 15px;"></div>
        <h4 style="color:var(--primary)">Procesando...</h4>
    </div>

    <div class="sidebar-overlay" id="sidebar-overlay" onclick="toggleMenu()"></div>

    <div id="login-screen">
        <div class="login-box">
            <h1 style="color:var(--primary); margin-bottom: 10px; font-weight: 800;">SISTEMA DE GESTI√ìN DE SEGURIDAD</h1>
            <p style="color:#64748b; font-size:13px; margin-bottom:30px;">Certificaci√≥n OEA - FCI Logistic</p>
            <div style="text-align: left;">
                <label>Usuario</label>
                <input type="text" id="login-user" placeholder="Ej: admin">
                <label>Contrase√±a</label>
                <input type="password" id="login-pass" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
            </div>
            <button class="btn btn-primary" id="btnLogin" style="width: 100%; padding: 15px; margin-top: 10px;">INICIAR SESI√ìN</button>
        </div>
    </div>

    <aside class="sidebar" id="sidebar">
        <div style="padding: 10px 0 30px; display:flex; align-items:center; gap:10px;">
            <span class="material-icons-round" style="color: var(--accent); font-size: 32px;">verified_user</span>
            <h2 style="font-weight: 800; font-size: 18px;">PANEL PRINCIPAL</h2>
        </div>
        
        <nav style="flex:1">
            <button class="nav-link" id="nav-dash" onclick="cambiarVista('sec-dash', this)">
                <span class="material-icons-round">dashboard</span> Dashboard
            </button>
            <button class="nav-link" id="nav-crear" onclick="cambiarVista('sec-crear', this)">
                <span class="material-icons-round">add_box</span> Crear Solicitud
            </button>
            <button class="nav-link" id="nav-hist" onclick="cambiarVista('sec-hist', this)">
                <span class="material-icons-round">history</span> Mis Solicitudes
            </button>
            <button class="nav-link" id="nav-gest" onclick="cambiarVista('sec-gest', this)">
                <span class="material-icons-round">fact_check</span> Gestionar Solicitudes
            </button>

            <button class="nav-link" id="nav-listado" onclick="cambiarVista('sec-listado', this)">
                <span class="material-icons-round">library_books</span> Listado Maestro
            </button>
            
            <div id="admin-only" style="display:none; border-top: 1px solid rgba(255,255,255,0.1); margin-top: 20px; padding-top: 20px;">
                <p style="font-size:10px; color:#64748b; font-weight:800; margin-left:12px; margin-bottom:10px;">ADMINISTRACI√ìN</p>
                <button class="nav-link" id="nav-users" onclick="cambiarVista('sec-usuarios', this)">
                    <span class="material-icons-round">people</span> Usuarios
                </button>
                <button class="nav-link" id="nav-struct" onclick="cambiarVista('sec-estructura', this)">
                    <span class="material-icons-round">account_tree</span> Estructura
                </button>
            </div>
        </nav>
        
        <div style="background: rgba(255,255,255,0.05); padding: 15px; border-radius: 16px;">
            <p id="curr-name" style="font-weight: 700; font-size: 13px;"></p>
            <p id="curr-ger" style="font-size: 10px; color: #94a3b8; margin-top:5px;"></p>
            <button onclick="logout()" style="background:none; border:none; color:var(--danger); font-size:11px; font-weight:700; cursor:pointer; margin-top:10px; display:flex; align-items:center; gap:5px; padding:0;">
                <span class="material-icons-round" style="font-size:16px;">logout</span> Salir
            </button>
        </div>
    </aside>

    <main class="main" id="main">
        
        <div class="mobile-header">
            <h2 style="font-size: 18px; color: var(--primary); margin:0; display:flex; align-items:center; gap:5px; font-weight:800;">
                <span class="material-icons-round">verified_user</span> SGC PRO
            </h2>
            <button class="menu-btn" onclick="toggleMenu()">
                <span class="material-icons-round">menu</span> Men√∫
            </button>
        </div>

        <section id="sec-dash" class="section">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:30px;">
                <div>
                    <h1 style="font-size: 28px; font-weight: 800; color: var(--sidebar);">Resumen Operativo</h1>
                    <p style="color: #64748b;">Control de Calidad y Certificaci√≥n OEA</p>
                </div>
                <div style="text-align:right;">
                    <p id="dash-date" style="font-size: 12px; font-weight: 600; color: var(--primary); background: #e0e7ff; padding: 5px 12px; border-radius: 20px;"></p>
                </div>
            </div>

            <div class="stats-grid grid-3" style="gap: 25px;">
                <div class="card" style="position:relative; overflow:hidden; border:none; background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%); color:white;">
                    <label style="color: rgba(255,255,255,0.8);">Total Solicitudes</label>
                    <h2 id="dash-total" style="font-size:42px; margin:10px 0;">0</h2>
                    <span class="material-icons-round" style="position:absolute; right:-10px; bottom:-10px; font-size:90px; opacity:0.2;">folder</span>
                </div>

                <div class="card" style="border-left: 6px solid var(--warning);">
                    <div style="display:flex; justify-content:space-between;">
                        <div>
                            <label>En Proceso</label>
                            <h2 id="dash-pend" style="font-size:38px; color: #92400e;">0</h2>
                        </div>
                        <div style="text-align:right;">
                            <span class="badge badge-warning">Atenci√≥n Req.</span>
                        </div>
                    </div>
                    <div style="width:100%; background:#f1f5f9; height:8px; border-radius:4px; margin-top:15px;">
                        <div id="bar-pend" style="width:0%; background:var(--warning); height:100%; border-radius:4px; transition:1s;"></div>
                    </div>
                </div>

                <div class="card" style="border-left: 6px solid var(--success);">
                    <div style="display:flex; justify-content:space-between;">
                        <div>
                            <label>Aprobados SGC</label>
                            <h2 id="dash-ok" style="font-size:38px; color: #065f46;">0</h2>
                        </div>
                        <div style="text-align:right;">
                            <span class="badge badge-success">Meta OEA</span>
                        </div>
                    </div>
                    <div style="width:100%; background:#f1f5f9; height:8px; border-radius:4px; margin-top:15px;">
                        <div id="bar-ok" style="width:0%; background:var(--success); height:100%; border-radius:4px; transition:1s;"></div>
                    </div>
                </div>
            </div>

            <div class="grid-2" style="margin-top: 25px;">
                <div class="card">
                    <h3 style="margin-bottom: 15px; color: var(--primary); display: flex; align-items: center; gap: 8px;">
                        <span class="material-icons-round">pie_chart</span> Distribuci√≥n de Estados
                    </h3>
                    <div style="position: relative; height: 300px; width: 100%; display: flex; justify-content: center;">
                        <canvas id="estadosChart"></canvas>
                    </div>
                </div>
                <div class="card" style="background: #f8fafc; border: 1px dashed #cbd5e1;">
                    <h3 style="margin-bottom: 15px; color: var(--primary); display: flex; align-items: center; gap: 8px;">
                        <span class="material-icons-round">info</span> Actividad del Sistema
                    </h3>
                    <p style="font-size: 13px; color: #475569; line-height: 1.6;">
                        El panel central consolida el estado de los documentos de tu sistema de gesti√≥n. 
                        Aseg√∫rate de vigilar los <b>estados pendientes</b> para evitar estancamientos en las validaciones, as√≠ como responder las solicitudes <b>en consulta</b>.
                    </p>
                    <div style="margin-top:20px; padding:15px; background:white; border-radius:8px; box-shadow:0 1px 2px rgba(0,0,0,0.05);">
                        <label style="color:var(--info);">Atajos R√°pidos</label>
                        <button class="btn btn-ghost" onclick="document.getElementById('nav-crear').click()" style="width:100%; margin-top:10px; text-align:left; justify-content:flex-start;">+ Registrar Nueva Solicitud</button>
                        <button class="btn btn-ghost" onclick="document.getElementById('nav-gest').click()" style="width:100%; margin-top:5px; text-align:left; justify-content:flex-start;">‚Üí Ir a Bandeja de Gesti√≥n</button>
                    </div>
                </div>
            </div>
        </section>

        <section id="sec-crear" class="section">
            <div class="card" style="max-width: 900px; margin: auto;">
                <h2 style="margin-bottom:20px;">Registrar Solicitud FCI-SOL</h2>
                
                <div class="grid-2">
                    <div>
                        <label>Acci√≥n Requerida</label>
                        <select id="sol-accion" onchange="toggleModPanel(this.value)">
                            <option value="Creaci√≥n">Creaci√≥n</option>
                            <option value="Modificaci√≥n">Modificaci√≥n</option>
                            <option value="Inactivaci√≥n">Inactivaci√≥n</option>
                        </select>
                    </div>
                    <div>
                        <label>Tipo Documento</label>
                        <select id="sol-tipo-doc">
                            <option>Gu√≠a</option><option>Manual</option><option>Instructivo</option><option>Procedimiento</option><option>Formato</option>
                        </select>
                    </div>
                </div>

                <div id="panel-mod" class="grid-3" style="display:none; background:#f8fafc; padding:15px; border-radius:10px; margin-bottom:15px;">
                    <div><label>C√≥digo Actual</label><input type="text" id="sol-cod-prev"></div>
                    <div><label>Versi√≥n</label><input type="text" id="sol-ver-prev"></div>
                    <div><label>Fecha Ult. Ver.</label><input type="date" id="sol-fecha-prev"></div>
                </div>

                <label>T√≠tulo del Documento</label>
                <input type="text" id="sol-tit">
                
                <div class="grid-2">
                    <div>
                        <label>Gerencia (Selecciona para ver Gerente y filtrar Depto)</label>
                        <select id="sol-ger"></select>
                    </div>
                    <div>
                        <label>Departamento</label>
                        <select id="sol-dep">
                            <option value="">-- Seleccione Gerencia Primero --</option>
                        </select>
                    </div>
                </div>

                <div class="grid-2" style="background:#f0fdf4; padding:15px; border-radius:10px; margin-bottom:15px; border:1px solid #bbf7d0;">
                    <div>
                        <label style="color:#166534">Gerente Responsable</label>
                        <input type="text" id="sol-gerente-display" disabled style="background:transparent; border:none; font-weight:bold; color:#15803d; padding:0;">
                    </div>
                    <div>
                        <label style="color:#166534">Email Notificaci√≥n</label>
                        <input type="text" id="sol-email-gerente" disabled style="background:transparent; border:none; font-weight:bold; color:#15803d; padding:0;">
                    </div>
                </div>

                <div style="background: #f8fafc; padding: 15px; border-radius: 12px; border: 1px solid var(--border); margin-bottom: 15px;">
                    <label style="display:flex; justify-content:space-between; align-items:center; margin-bottom:0;">
                        A√±adir Personas Involucradas / Co-solicitantes
                        <button type="button" class="btn btn-info" style="padding: 4px 10px; font-size:11px;" onclick="addInvolucrado()"><span class="material-icons-round" style="font-size:14px; margin-right:4px;">person_add</span> A√±adir Persona</button>
                    </label>
                    <p style="font-size:10px; color:#64748b; margin-top:5px; margin-bottom:0;">A√±ade correos electr√≥nicos de quienes necesiten ser notificados de los avances y resoluciones de este documento.</p>
                    <div id="lista-involucrados" style="display:flex; flex-direction:column; gap:10px; margin-top:10px;"></div>
                </div>
                
                <label>Justificaci√≥n / Motivo</label>
                <textarea id="sol-motivo" rows="4"></textarea>

                <div style="background: #eff6ff; padding: 20px; border-radius: 12px; border: 1px dashed var(--accent); margin-bottom: 20px;">
                    <label style="color:var(--primary)">Adjuntar Archivo Inicial (Opcional si es creaci√≥n, obligatorio en modificaci√≥n)</label>
                    <input type="file" id="sol-file" accept=".pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx,.jpg,.png" style="margin-bottom:0; background:white;">
                </div>

                <button class="btn btn-primary" id="btnSendSol" style="width:100%; padding: 15px;">ENVIAR A REVISI√ìN</button>
            </div>
        </section>

        <section id="sec-hist" class="section">
            <div style="display:flex; justify-content:space-between; align-items:flex-end; margin-bottom:20px;">
                <h1>Mis Solicitudes</h1>
            </div>
            <div class="card" style="padding:0; padding-top:15px; overflow:hidden; margin-top:20px;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 15px; padding: 0 15px; gap: 10px; flex-wrap: wrap;">
                    <input type="text" id="search-hist" class="search-bar" placeholder="üîç Buscar por ID, T√≠tulo o Estado..." onkeyup="filtrarTabla('search-hist', 'tbody-historial')">
                    <button id="btn-export-hist" class="btn btn-success" onclick="exportarReporteSolicitudes()" style="display:none;"><span class="material-icons-round" style="font-size:16px;">table_view</span> Exportar Reporte</button>
                </div>
                <div class="table-responsive">
                    <table id="tabla-mis-solicitudes"><thead><tr><th>ID</th><th>Solicitante</th><th>Documento</th><th>Estado</th><th class="no-export">Acci√≥n</th></tr></thead><tbody id="tbody-historial"></tbody></table>
                </div>
            </div>
        </section>

        <section id="sec-gest" class="section">
            <div style="display:flex; justify-content:space-between; align-items:flex-end; margin-bottom:25px;">
                <div>
                    <h1 style="font-size: 26px; font-weight: 800;">Bandeja de Gesti√≥n Administrativa</h1>
                    <p style="color:#64748b; font-size:13px;">Documentos esperando revisi√≥n, firma o publicaci√≥n final.</p>
                </div>
                <button id="btn-export-gest" class="btn btn-success" onclick="exportarReporteSolicitudes()" style="display:none;">
                    <span class="material-icons-round">download</span> Reporte Excel
                </button>
            </div>

            <div class="card" style="padding:0; border-radius: 16px; overflow:hidden;">
                <div style="background: #f8fafc; padding: 20px; border-bottom: 1px solid var(--border); display:flex; gap:15px; align-items:center; flex-wrap:wrap;">
                    <div style="flex:1; min-width:250px;">
                        <input type="text" id="search-gest" class="search-bar" style="max-width:100%; margin-bottom:0;" 
                               placeholder="üîç Buscar por ID, Solicitante o Documento..." 
                               onkeyup="filtrarTabla('search-gest', 'tbody-gestionar')">
                    </div>
                    <div style="display:flex; gap:8px;">
                        <span class="badge badge-dark" style="cursor:pointer;" onclick="setFilterGest('')">Todos</span>
                        <span class="badge badge-warning" style="cursor:pointer;" onclick="setFilterGest('Pendiente')">Pendientes</span>
                        <span class="badge badge-info" style="cursor:pointer;" onclick="setFilterGest('Consulta')">En Consulta</span>
                        <span class="badge badge-danger" style="cursor:pointer;" onclick="setFilterGest('Rechazado')">Rechazados</span>
                    </div>
                </div>

                <div class="table-responsive">
                    <table id="tabla-gestion-solicitudes">
                        <thead>
                            <tr>
                                <th style="width: 120px;">ID Sistema</th>
                                <th>Origen / Solicitante</th>
                                <th>Documento y Tipo</th>
                                <th>Etapa Actual</th>
                                <th style="text-align: center;" class="no-export">Gesti√≥n</th>
                            </tr>
                        </thead>
                        <tbody id="tbody-gestionar">
                            </tbody>
                    </table>
                </div>
            </div>
        </section>

        <section id="sec-listado" class="section">
            <div style="display:flex; justify-content:space-between; align-items:flex-end; margin-bottom:20px; flex-wrap:wrap; gap:10px;">
                <div>
                    <h1>Listado Maestro</h1>
                    <p style="color:#64748b; font-size:12px;">Control centralizado de documentos aprobados</p>
                </div>
                <div style="display:flex; gap:10px; flex-wrap:wrap;">
                    <button id="btn-export-list" class="btn btn-success" onclick="exportarExcelListado()" style="display:none;">
                        <span class="material-icons-round" style="font-size:16px;">table_view</span> Exportar a Excel
                    </button>
                    <input type="file" id="import-excel-file" accept=".xlsx, .xls" style="display:none;">
                    <label for="import-excel-file" class="btn btn-warning" id="btn-import-maestro" style="display:none; cursor:pointer; margin:0;">
                        <span class="material-icons-round" style="font-size:16px;">upload_file</span> Cargar Excel
                    </label>
                    <button class="btn btn-primary" id="btn-nuevo-maestro" onclick="abrirModalListadoMaestro()" style="display:none;">
                        <span class="material-icons-round" style="font-size:16px;">add</span> Nuevo Registro
                    </button>
                </div>
            </div>

            <div class="card" style="padding:0; padding-top:15px; margin-top:20px;">
                <div style="padding: 0 15px;">
                    <input type="text" id="search-maestro" class="search-bar" placeholder="üîç Buscar en el listado maestro..." onkeyup="filtrarTabla('search-maestro', 'tbody-listado-maestro')">
                </div>
                <div class="table-responsive">
                    <table id="tabla-listado-maestro" style="white-space:nowrap;">
                        <thead id="thead-listado-maestro"></thead>
                        <tbody id="tbody-listado-maestro"></tbody>
                    </table>
                </div>
            </div>
        </section>
        
        <section id="sec-usuarios" class="section">
            <div class="grid-2">
                <div class="card">
                    <h3 id="user-form-title">Registrar / Editar Usuario</h3>
                    <div class="grid-2">
                        <div><label>Nombre Completo</label><input type="text" id="u-nom"></div>
                        <div><label>Usuario ID (Login)</label><input type="text" id="u-usr" placeholder="usuario123"></div>
                    </div>
                    <div class="grid-2">
                        <div><label>Contrase√±a</label><input type="text" id="u-pas" value="123"></div>
                        <div><label>Gerencia</label><select id="u-ger-sel"></select></div>
                    </div>
                    <div class="grid-2">
                        <div><label>Rol (Etiqueta Visual)</label><input type="text" id="u-rol" placeholder="Ej: Especialista SGC"></div>
                        <div><label>Email Corporativo</label><input type="email" id="u-email" placeholder="ejemplo@fcipty.com"></div>
                    </div>

                    <label style="margin-top:10px;">Permisos de Acceso del Usuario</label>
                    <div style="border:1px solid var(--border); padding:15px; border-radius:10px; margin-bottom:15px; display:grid; grid-template-columns: 1fr 1fr; gap:10px; background:#f8fafc;">
                        <div class="access-item"><span>Solicitar (Crear)</span><label class="switch"><input type="checkbox" id="p-solicitar"><span class="slider"></span></label></div>
                        <div class="access-item"><span>Ver Mis Solicitudes</span><label class="switch"><input type="checkbox" id="p-ver-propias" checked><span class="slider"></span></label></div>
                        <div class="access-item"><span>Ver Solicitudes de Gerencia</span><label class="switch"><input type="checkbox" id="p-ver-ger"><span class="slider"></span></label></div>
                        <div class="access-item"><span>Gestor SGC (Eval√∫a pasos 1,2,3)</span><label class="switch"><input type="checkbox" id="p-gest-sgc"><span class="slider"></span></label></div>
                        <div class="access-item"><span>Gerente (Aprueba final)</span><label class="switch"><input type="checkbox" id="p-ger-apr"><span class="slider"></span></label></div>
                        <div class="access-item"><span>Admin Usuarios</span><label class="switch"><input type="checkbox" id="p-users"><span class="slider"></span></label></div>
                        <div class="access-item"><span>Admin Estructura</span><label class="switch"><input type="checkbox" id="p-struct"><span class="slider"></span></label></div>
                        <div class="access-item"><span>Ver Listado Maestro</span><label class="switch"><input type="checkbox" id="p-ver-listado"><span class="slider"></span></label></div>
                        <div class="access-item" style="grid-column:span 2; border:1px dashed var(--danger); background:#fff5f5;">
                            <span style="color:var(--danger); font-weight:bold;">Admin Total (Acceso completo)</span><label class="switch"><input type="checkbox" id="p-admin"><span class="slider"></span></label>
                        </div>
                    </div>
                    
                    <button class="btn btn-primary" id="btnSaveUser" style="width:100%">GUARDAR USUARIO</button>
                    <button class="btn btn-ghost" id="btnCancelEdit" style="width:100%; margin-top:5px; display:none;" onclick="resetUserForm()">CANCELAR EDICI√ìN</button>
                </div>
                <div class="card table-responsive" style="padding:0;">
                    <table id="table-users"><thead><tr><th>Usuario</th><th>Email</th><th>Rol/Gerencia</th><th>Acciones</th></tr></thead><tbody id="tbody-users"></tbody></table>
                </div>
            </div>
        </section>

        <section id="sec-estructura" class="section">
            <h2 style="margin-bottom: 20px; color:var(--primary); display:flex; align-items:center; gap:8px;">
                <span class="material-icons-round">settings_suggest</span> Configuraci√≥n del Sistema
            </h2>
            
            <div class="grid-2">
                <div class="card" style="border-top: 4px solid var(--accent);">
                    <h3 style="display:flex; align-items:center; gap:5px;"><span class="material-icons-round" style="color:var(--accent);">domain</span> Gerencias</h3>
                    <p style="font-size:11px; color:#64748b; margin-bottom:10px;">Departamentos principales que eval√∫an solicitudes.</p>
                    <div style="display:flex; gap:0; margin-bottom:15px;">
                        <input type="text" id="g-nom" placeholder="Nueva Gerencia..." style="margin:0; border-radius: 8px 0 0 8px; border-right:none;">
                        <button class="btn btn-success" id="btnSaveGer" style="border-radius: 0 8px 8px 0;"><span class="material-icons-round">add</span></button>
                    </div>
                    <div id="list-ger" class="settings-list"></div>
                </div>

                <div class="card" style="border-top: 4px solid var(--info);">
                    <h3 style="display:flex; align-items:center; gap:5px;"><span class="material-icons-round" style="color:var(--info);">groups</span> Departamentos</h3>
                    <p style="font-size:11px; color:#64748b; margin-bottom:10px;">Sub-√°reas ligadas a una Gerencia.</p>
                    <div style="display:flex; gap:0; margin-bottom:15px;">
                        <select id="d-ger-sel" style="margin:0; border-radius: 8px 0 0 8px; border-right:1px solid #cbd5e1; width:40%; padding:12px;"></select>
                        <input type="text" id="d-nom" placeholder="Nuevo Depto..." style="margin:0; border-radius: 0; border-right:none; width:60%;">
                        <button class="btn btn-success" id="btnSaveDep" style="border-radius: 0 8px 8px 0;"><span class="material-icons-round">add</span></button>
                    </div>
                    <div id="list-dep" class="settings-list"></div>
                </div>
            </div>
            
            <h3 style="margin:35px 0 15px; color:var(--primary); display:flex; align-items:center; gap:8px; border-bottom:1px solid #e2e8f0; padding-bottom:10px;">
                <span class="material-icons-round">view_column</span> Configuraci√≥n Din√°mica (Listado Maestro)
            </h3>
            
            <div class="grid-2">
                <div class="card" style="border-top: 4px solid #8b5cf6;">
                    <h3 style="display:flex; align-items:center; gap:5px;"><span class="material-icons-round" style="color:#8b5cf6;">table_chart</span> Columnas de Tabla</h3>
                    <p style="font-size:11px; color:#64748b; margin-bottom:10px;">Agrega/elimina columnas de la base central.</p>
                    <div style="display:flex; gap:0; margin-bottom:15px;">
                        <input type="text" id="col-nom" placeholder="Ej: Nueva Columna" style="margin:0; border-radius: 8px 0 0 8px; border-right:none;">
                        <button class="btn btn-success" onclick="agregarColumna()" style="border-radius: 0 8px 8px 0;"><span class="material-icons-round">add</span></button>
                    </div>
                    <div id="list-columnas" class="settings-list"></div>
                </div>

                <div class="card" style="border-top: 4px solid var(--warning);">
                    <h3 style="display:flex; align-items:center; gap:5px;"><span class="material-icons-round" style="color:var(--warning);">label</span> Estatus de Documentos</h3>
                    <p style="font-size:11px; color:#64748b; margin-bottom:10px;">Las opciones de ciclo de vida (Ej: Vigente, Obsoleto).</p>
                    <div style="display:flex; gap:0; margin-bottom:15px;">
                        <input type="text" id="est-nom" placeholder="Ej: Archivo Muerto" style="margin:0; border-radius: 8px 0 0 8px; border-right:none;">
                        <button class="btn btn-success" onclick="agregarEstatus()" style="border-radius: 0 8px 8px 0;"><span class="material-icons-round">add</span></button>
                    </div>
                    <div id="list-estatus" class="settings-list"></div>
                </div>
            </div>
        </section>
    </main>

    <div class="modal-overlay" id="modal">
        <div class="modal-content">
            <div class="modal-main" style="padding:30px; overflow-y:auto; position: relative;">
                
                <div style="display:flex; justify-content:space-between; margin-bottom:20px; align-items: flex-start;">
                    <div>
                        <span id="m-id" style="font-weight:800; color:var(--primary);"></span>
                        <h2 id="m-tit" style="margin-top:5px; font-size:20px;"></h2>
                    </div>
                    <div style="display:flex; gap:10px;">
                        <button class="btn btn-danger" id="btn-anular" onclick="anularSolicitud()" style="display:none; padding: 8px 15px;">Anular</button>
                        <button class="btn btn-dark" onclick="closeModal()" style="background:#475569; color:white; padding: 8px 15px;">Cerrar</button>
                    </div>
                </div>
                
                <div class="step-container">
                    <div class="step" id="s1"><div class="step-dot">1</div><label>Pendiente Documentado</label></div>
                    <div class="step" id="s2"><div class="step-dot">2</div><label>Pendiente Verificado</label></div>
                    <div class="step" id="s3"><div class="step-dot">3</div><label>Pendiente Aprobaci√≥n Gerencia</label></div>
                    <div class="step" id="s4"><div class="step-dot">4</div><label>Pendiente Aprobaci√≥n SGC</label></div>
                </div>

                <div id="m-display-final" style="display:none; margin-bottom:20px; background:#f0fdf4; padding:20px; border-radius:12px; border: 1px solid #bbf7d0;">
                    <h4 style="color:#166534; margin-bottom:15px; display:flex; align-items:center; gap:8px;"><span class="material-icons-round">verified</span> Documento Finalizado y Publicado</h4>
                    <div class="grid-3">
                        <div><label>C√≥digo Final Asignado</label><p id="m-disp-cod" style="font-weight:bold;"></p></div>
                        <div><label>Versi√≥n Final</label><p id="m-disp-ver" style="font-weight:bold;"></p></div>
                        <div>
                            <label>Fecha √öltima Versi√≥n</label>
                            <div style="display:flex; align-items:center; gap:5px;">
                                <p id="m-disp-fecha" style="font-weight:bold; margin:0;"></p>
                                <button id="btn-edit-fecha-final" style="display:none; background:none; border:none; cursor:pointer; color:var(--accent);"><span class="material-icons-round" style="font-size:16px;">edit</span></button>
                            </div>
                            <div id="edit-fecha-final-container" style="display:none; margin-top:5px; background:white; padding:10px; border-radius:8px; border:1px solid #ccc;">
                                <input type="date" id="in-edit-fecha-final" style="width:100%; margin-bottom:5px;">
                                <div style="display:flex; gap:5px;">
                                    <button class="btn btn-success" id="btn-save-fecha-final" style="padding:5px; font-size:11px; flex:1;">Guardar</button>
                                    <button class="btn btn-dark" id="btn-cancel-fecha-final" style="padding:5px; font-size:11px; flex:1;">Cancelar</button>
                                </div>
                            </div>
                        </div>
                        <div style="grid-column: span 3;"><label>Documento Oficial</label><div id="m-disp-file"></div></div>
                        <div style="grid-column: span 3;"><label>Comentario SGC de Cierre</label><p id="m-disp-com"></p></div>
                    </div>
                </div>

                <div id="m-panel-update-sgc" style="display:none; margin-bottom:20px; background:#f8fafc; padding:20px; border-radius:12px; border: 1px dashed var(--info);">
                    <h4 style="color:var(--info); margin-bottom:15px; display:flex; align-items:center; gap:8px;"><span class="material-icons-round">edit</span> Actualizar Datos de Solicitud (SGC)</h4>
                    <p style="font-size:11px; color:#64748b; margin-bottom:15px;">Corrige o reemplaza el documento antes de enviarlo a Gerencia para evitar confusiones.</p>
                    <div class="grid-2">
                        <div><label>T√≠tulo del Documento</label><input type="text" id="m-upd-tit" style="background:white; margin-bottom:10px;"></div>
                        <div><label>C√≥digo Referencia</label><input type="text" id="m-upd-cod" style="background:white; margin-bottom:10px;"></div>
                        <div><label>Versi√≥n</label><input type="text" id="m-upd-ver" style="background:white; margin-bottom:10px;"></div>
                        <div><label>Reemplazar Adjunto (Opcional)</label><input type="file" id="m-upd-file" accept=".pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx,.jpg,.jpeg,.png" style="background:white; margin-bottom:10px;"></div>
                    </div>
                    <button class="btn btn-info" onclick="actualizarDatosSGC()" style="width:100%; margin-top:10px;">GUARDAR ACTUALIZACI√ìN</button>
                </div>

                <div id="m-panel-final-sgc" style="display:none; margin-bottom:20px; background:#eff6ff; padding:20px; border-radius:12px; border: 1px dashed var(--primary);">
                    <h4 style="color:var(--primary); margin-bottom:15px; display:flex; align-items:center; gap:8px;"><span class="material-icons-round">publish</span> Cierre T√©cnico y Publicaci√≥n (Admin SGC)</h4>
                    <div class="grid-3">
                        <div>
                            <label>C√≥digo Final Asignado</label>
                            <input type="text" id="m-final-cod" placeholder="Ej: FCI-GOP-F-032" style="background:white; margin-bottom:10px;">
                        </div>
                        <div>
                            <label>Versi√≥n Final Asignada</label>
                            <input type="text" id="m-final-ver" placeholder="Ej: V-02" style="background:white; margin-bottom:10px;">
                        </div>
                        <div>
                            <label>Fecha √öltima Versi√≥n</label>
                            <input type="date" id="m-final-fecha" style="background:white; margin-bottom:10px;">
                        </div>
                    </div>
                    <div style="margin-bottom:10px;">
                        <label>Adjuntar Documento Oficial (Aprobado)</label>
                        <input type="file" id="m-final-file" accept=".pdf,.doc,.docx,.xls,.xlsx" style="background:white; margin-bottom:0;">
                    </div>
                    <label>Comentarios del Cierre</label>
                    <input type="text" id="m-final-comentario" placeholder="Observaciones finales de la publicaci√≥n..." style="background:white;">
                    <button class="btn btn-primary" onclick="guardarCierreFinal()" style="width:100%; margin-top:10px;">GUARDAR Y PUBLICAR VERSI√ìN FINAL</button>
                </div>

                <div id="m-original-data">
                    <h4 id="m-orig-title" class="locked-title" style="display:none;"><span class="material-icons-round">lock</span> Datos de la Solicitud (Hist√≥rico)</h4>
                    <div class="grid-2" style="margin-top:20px;">
                        <div><label>Solicitante</label><p id="m-sol"></p></div>
                        <div><label>Gerencia</label><p id="m-ger"></p></div>
                        <div><label>Estado</label><span id="m-est" class="badge"></span></div>
                        <div><label>Tipo Documento</label><p id="m-tipo" style="font-weight:bold;"></p></div>
                        <div><label>Acci√≥n</label><p id="m-accion"></p></div>
                        <div><label>Adjunto Original</label><div id="m-file-link"></div></div>
                    </div>

                    <div id="m-extra-panel" style="display:none; background:#fffbeb; padding:15px; border-radius:10px; margin-top:15px;">
                        <div class="grid-3">
                            <div><label>C√≥d. Ref Original</label><p id="m-cod"></p></div>
                            <div><label>Versi√≥n Anterior</label><p id="m-ver"></p></div>
                            <div><label>Fecha Ult. Ver.</label><p id="m-fecha-ult"></p></div>
                        </div>
                    </div>

                    <div style="margin-top:20px; background:#f8fafc; padding:15px; border-radius:10px;">
                        <label>Justificaci√≥n / Motivo Inicial</label>
                        <p id="m-jus" style="font-size:13px;"></p>
                    </div>

                    <div id="m-involucrados-container" style="background:#f8fafc; padding:15px; border-radius:10px; margin-top:15px; border:1px solid var(--border);">
                        <label style="color:var(--primary); display:flex; justify-content:space-between; align-items:center;">
                            Personas Involucradas (Notificadas)
                        </label>
                        <p id="m-involucrados-list" style="font-size:13px; font-weight:600; color:#0369a1; word-break:break-all; margin-bottom: 10px;"></p>
                        
                        <div id="m-add-involucrado-section" style="display:flex; gap:10px; border-top: 1px dashed #cbd5e1; padding-top: 10px;">
                            <input type="email" id="m-new-involucrado" placeholder="A√±adir nuevo correo (ej: juan@fcipty.com)" style="margin:0; padding:8px; font-size:12px; flex:1; background:white;">
                            <button class="btn btn-info" onclick="guardarNuevoInvolucrado()" style="padding:8px 12px; font-size:11px;">A√±adir</button>
                        </div>
                    </div>
                </div>

                <div id="m-actions" style="margin-top:30px; display:none; border-top:1px solid #eee; padding-top:20px;">
                    <p style="font-weight:800; font-size:11px; color:#64748b; margin-bottom:10px;">ACCIONES DE GESTI√ìN (Avanzar/Rechazar):</p>
                    <div id="action-buttons" style="display:flex; gap:10px; flex-wrap:wrap;">
                        <button class="btn btn-info" onclick="gestionar('Consulta')">Consultar</button>
                        <button class="btn btn-warning" onclick="gestionar('Reuni√≥n')">Reuni√≥n</button>
                        <button class="btn btn-primary" id="btn-firma-next" onclick="firmarPaso()">Firmar Etapa</button>
                        <button class="btn btn-danger" onclick="rechazar()">Rechazar</button>
                    </div>
                </div>

                <div id="applicant-actions" style="margin-top:20px; display:none;">
                    <p style="font-weight:800; font-size:11px; color:#64748b; margin-bottom:10px;">ACCIONES DEL SOLICITANTE:</p>
                    <button class="btn btn-info" style="background:var(--accent);" onclick="responderSolicitante()"> Responder / Enviar Correcci√≥n</button>
                </div>

                <div id="m-input-area" style="display:none; margin-top:15px;">
                    <div id="reunion-container" style="display:none; margin-bottom:10px;">
                        <label style="color:var(--warning)">Fecha y Hora de Reuni√≥n</label>
                        <input type="datetime-local" id="m-date-meeting">
                    </div>
                    <input type="text" id="m-extra-input" placeholder="Motivo / Consulta / Comentario" style="margin-bottom:5px;">
                    
                    <div style="background:#f0fdf4; padding:10px; border-radius:8px; border:1px solid #bbf7d0;">
                            <label style="color:#15803d; margin-bottom:5px;">Adjuntar Archivo / Correcci√≥n (Opcional)</label>
                            <input type="file" id="m-file-gestion" accept=".pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx,.jpg,.jpeg,.png" style="margin-bottom:0; background:white;">
                    </div>
                    <button class="btn btn-success" id="btnConfirmAction" style="width:100%; margin-top:10px;">CONFIRMAR ESTADO</button>
                    <button class="btn btn-ghost" onclick="document.getElementById('m-input-area').style.display='none'" style="width:100%; margin-top:5px;">Cancelar</button>
                </div>

                <div id="general-comment-area" style="margin-top:30px; border-top:2px solid #e2e8f0; padding-top:20px;">
                    <p style="font-weight:800; font-size:11px; color:#64748b; margin-bottom:10px;">DEJAR UN COMENTARIO EN LA BIT√ÅCORA:</p>
                    <textarea id="m-comentario-libre" rows="2" placeholder="Escribe un comentario o consulta directa..." style="width:100%; padding:10px; border:1px solid #cbd5e1; border-radius:8px; margin-bottom:10px; resize:vertical;"></textarea>
                    <div style="display:flex; gap:10px; align-items:center;">
                        <div style="flex:1;">
                            <label style="font-size:10px;">Adjuntar Referencia (Opcional)</label>
                            <input type="file" id="m-file-comentario" accept=".pdf,.doc,.docx,.xls,.xlsx,.png,.jpg" style="margin-bottom:0; padding:8px;">
                        </div>
                        <button class="btn btn-success" onclick="enviarComentarioLibre()" style="height:40px; margin-top:14px;">ENVIAR COMENTARIO</button>
                    </div>
                </div>

            </div>
            <div class="modal-side" style="background:#f8fafc; border-left:1px solid #e2e8f0;">
                <h4 style="padding:20px; border-bottom:1px solid #e2e8f0;">Bit√°cora de Eventos</h4>
                <div id="chat-box" style="height:calc(90vh - 60px);"></div>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="modal-form-listado">
        <div class="modal-content" style="max-width: 800px; display:block; padding: 30px; height:auto; max-height:90vh; overflow-y:auto;">
           <h2 style="color:var(--primary); margin-bottom: 20px; display:flex; align-items:center; gap:8px;">
               <span class="material-icons-round">edit_document</span> 
               <span id="lm-modal-title">Agregar Registro al Listado Maestro</span>
           </h2>
           
           <div class="grid-2" id="dinamic-form-maestro"></div>
           
           <div style="background:#eff6ff; padding:15px; border-radius:10px; margin-top:15px; border:1px dashed var(--primary);">
               <label style="color:var(--primary); font-size:11px;">Herramienta R√°pida: Subir archivo y generar URL</label>
               <div style="display:flex; gap:10px; align-items:center; margin-top:5px;">
                   <input type="file" id="lm-generic-file" style="margin:0; background:white; flex:1;">
                   <button class="btn btn-info" onclick="subirArchivoGenericoLM()">Subir y Llenar Campo</button>
               </div>
           </div>

           <div style="display:flex; gap:10px; margin-top:20px;">
               <button class="btn btn-primary" onclick="guardarRegistroMaestro()" style="flex:1;">Guardar Documento</button>
               <button class="btn btn-dark" onclick="document.getElementById('modal-form-listado').style.display='none'" style="flex:1;">Cancelar</button>
           </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, getDoc, updateDoc, setDoc, query, where, getDocs, arrayUnion, runTransaction, deleteDoc } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";

        const firebaseConfig = {
          apiKey: "AIzaSyDdzCiachuhbE9jATz-TesPI2vUVIJrHjM",
          authDomain: "sistemadegestion-7400d.firebaseapp.com",
          projectId: "sistemadegestion-7400d",
          storageBucket: "sistemadegestion-7400d.firebasestorage.app",
          messagingSenderId: "709030283072",
          appId: "1:709030283072:web:5997837b36a448e9515ca5"
        };

        const EMAIL_SERVICE_ID = "service_a7yozqh"; 
        const EMAIL_TEMPLATE_ID = "template_7hlhnt8"; 
        const EMAIL_PUBLIC_KEY = "2jVnfkJKKG0bpKN-U"; 

        const EMAIL_ADMIN_SGC = "sistemadegestion@fcipty.com"; 
        const EMAIL_GRUPO_SGC = "actualizacion@fcipty.com"; 

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = 'sgc-final-v6';
        
        (function() { emailjs.init(EMAIL_PUBLIC_KEY); })();

        const CLOUD_NAME = "df79cjklp";
        const UPLOAD_PRESET = "fci_documentos";

        let currentUser = null;
        let selectedId = null;
        let selectedDocData = null; 
        let tempAction = "";
        let allUsers = []; 
        let allDepartamentos = []; 
        
        let columnasMaestro = [];
        let estatusMaestro = [];
        let dataMaestro = [];
        let editandoMaestroId = null;
        
        let globalSolicitudes = [];
        let chartEstados = null; // Variable para manejar la gr√°fica

        const PASOS_NOMBRES = ["Pendiente Documentado", "Pendiente Verificado", "Pendiente Aprobaci√≥n Gerencia", "Pendiente Aprobaci√≥n SGC"];

        // FUNCION PARA AGREGAR CAMPOS DE INVOLUCRADOS DIN√ÅMICAMENTE
        window.addInvolucrado = () => {
            const container = document.getElementById('lista-involucrados');
            const div = document.createElement('div');
            div.style.display = 'flex';
            div.style.gap = '10px';
            div.innerHTML = `
                <input type="email" placeholder="Correo de la persona (ej: juan@fcipty.com)" class="extra-email" style="margin-bottom:0; flex:1;">
                <button type="button" class="btn btn-danger" onclick="this.parentElement.remove()" style="padding:8px 12px;"><span class="material-icons-round" style="font-size:16px; margin:0;">delete</span></button>
            `;
            container.appendChild(div);
        };

        // FUNCION PARA A√ëADIR INVOLUCRADOS A UNA SOLICITUD YA CREADA DESDE EL MODAL
        window.guardarNuevoInvolucrado = async () => {
            const newEmail = document.getElementById('m-new-involucrado').value.trim().toLowerCase();
            if(!newEmail || !newEmail.includes('@')) return alert('Ingresa un correo v√°lido.');
            
            document.getElementById('loading-overlay').style.display = 'flex';
            
            let currentInv = selectedDocData.involucrados || [];
            if(currentInv.includes(newEmail)) {
                document.getElementById('loading-overlay').style.display = 'none';
                return alert('Este correo ya est√° en la lista de involucrados.');
            }
            
            currentInv.push(newEmail);
            
            await updateDoc(doc(db, "artifacts", appId, "public", "data", "Solicitudes", selectedId), {
                involucrados: currentInv,
                chat: arrayUnion({u: currentUser.nombre, m: `üë• A√±adi√≥ a ${newEmail} como persona involucrada a esta solicitud.`, t: new Date().toLocaleString()})
            });
            
            document.getElementById('m-new-involucrado').value = '';
            document.getElementById('loading-overlay').style.display = 'none';
            verDetalle(selectedId); 
        };

        window.filtrarTabla = (inputId, tbodyId) => {
            const input = document.getElementById(inputId);
            if (!input) return;
            const filter = input.value.toLowerCase();
            const tbody = document.getElementById(tbodyId);
            if (!tbody) return;
            const trs = tbody.getElementsByTagName('tr');

            for (let i = 0; i < trs.length; i++) {
                let rowText = trs[i].textContent || trs[i].innerText;
                if (rowText.toLowerCase().indexOf(filter) > -1) {
                    trs[i].style.display = "";
                } else {
                    trs[i].style.display = "none";
                }
            }
        };

        // FILTRO R√ÅPIDO PARA BANDEJA DE GESTI√ìN
        window.setFilterGest = (estado) => {
            const tbody = document.getElementById('tbody-gestionar');
            if (!tbody) return;
            const trs = tbody.getElementsByTagName('tr');
            for (let i = 0; i < trs.length; i++) {
                let text = trs[i].innerText || trs[i].textContent;
                if (estado === '') {
                    trs[i].style.display = "";
                } else {
                    if (text.toLowerCase().includes(estado.toLowerCase())) {
                        trs[i].style.display = "";
                    } else {
                        trs[i].style.display = "none";
                    }
                }
            }
        };

        window.toggleMenu = () => {
            const sb = document.getElementById('sidebar');
            const ov = document.getElementById('sidebar-overlay');
            sb.classList.toggle('open');
            if(sb.classList.contains('open')) {
                ov.classList.add('active');
            } else {
                ov.classList.remove('active');
            }
        };

        window.formatearFechaAbreviada = (fechaStr) => {
            if (!fechaStr) return "";
            let dateVal = fechaStr;
            
            if (typeof fechaStr === 'string' && fechaStr.length === 10 && fechaStr.includes("-")) {
                dateVal = fechaStr + "T12:00:00"; 
            } 
            else if (typeof fechaStr === 'string' && fechaStr.includes("/")) {
                let p = fechaStr.split("/");
                if(p.length === 3) {
                    if (p[2].length === 4) { 
                        dateVal = `${p[2]}-${p[1].padStart(2,'0')}-${p[0].padStart(2,'0')}T12:00:00`;
                    }
                }
            }

            let dObj = new Date(dateVal);
            if (isNaN(dObj.getTime())) return fechaStr; 

            const meses = ["ene.", "feb.", "mar.", "abr.", "may.", "jun.", "jul.", "ago.", "sep.", "oct.", "nov.", "dic."];
            const d = String(dObj.getDate()).padStart(2, '0');
            const m = meses[dObj.getMonth()];
            const y = dObj.getFullYear();
            
            return `${d} ${m} ${y}`;
        };

        window.exportarReporteSolicitudes = () => {
            if(globalSolicitudes.length === 0) {
                alert("No hay solicitudes para exportar."); 
                return;
            }
            
            let dataExport = globalSolicitudes.map(s => {
                let est = (s.estado || '').toUpperCase();
                let estadoFormat = est.includes('APROBADO FINAL') ? 'APROBADO FINAL' : (est !== 'ANULADO' && est !== 'RECHAZADO' ? `${s.estado} (Etapa: ${PASOS_NOMBRES[s.idx] || ''})` : s.estado);
                
                return {
                    "ID Solicitud": s.customId || '',
                    "T√≠tulo del Documento": s.titulo || '',
                    "Solicitante": s.solicitante || '',
                    "Gerencia": s.gerencia || '',
                    "Departamento": s.departamento || '',
                    "Tipo de Documento": s.tipoDoc || '',
                    "Acci√≥n Requerida": s.accion || '',
                    "Motivo / Justificaci√≥n": s.motivo || '',
                    "Estado Actual": estadoFormat,
                    "Fecha de Creaci√≥n": s.fecha ? new Date(s.fecha).toLocaleString() : '',
                    "C√≥digo Ref. Original": s.cod_ref || '',
                    "Versi√≥n Original": s.ver_ref || '',
                    "C√≥digo Final Asignado": s.codigo_final || '',
                    "Versi√≥n Final Asignada": s.version_final || '',
                    "Fecha Final": s.fecha_final || ''
                }
            });

            let wb = XLSX.utils.book_new();
            let ws = XLSX.utils.json_to_sheet(dataExport);
            XLSX.utils.book_append_sheet(wb, ws, "Reporte Solicitudes");
            XLSX.writeFile(wb, "Reporte_General_Solicitudes.xlsx");
        };

        async function getDatosEnvio(solicitudData) {
            let managerEmail = "";
            if(solicitudData.gerencia) {
                try {
                    const q = query(collection(db, "artifacts", appId, "public", "data", "Usuarios"), where("gerencia", "==", solicitudData.gerencia), where("permisos.p_ger_apr", "==", true));
                    const snap = await getDocs(q);
                    if(!snap.empty) managerEmail = snap.docs[0].data().email || "";
                } catch(e) { console.error("Error buscando gerente", e); }
            }
            
            const toEmails = new Set([EMAIL_ADMIN_SGC, EMAIL_GRUPO_SGC, solicitudData.solicitante_email]);
            
            if(solicitudData.involucrados && Array.isArray(solicitudData.involucrados)) {
                solicitudData.involucrados.forEach(e => { if(e) toEmails.add(e); });
            }

            const toList = Array.from(toEmails).filter(e => e && e.includes('@')).join(',');
            return { to: toList, cc: managerEmail };
        }

        function sendNotification(destinatarios, title, message) {
            if(!destinatarios.to) return;
            const templateParams = {
                title: title, name: "Sistema SGC", message: message,   
                to_email: destinatarios.to, cc_email: destinatarios.cc,   
                time: new Date().toLocaleString()
            };
            emailjs.send(EMAIL_SERVICE_ID, EMAIL_TEMPLATE_ID, templateParams).catch(err => console.log('ERROR EMAIL', err));
        }

        const initAuth = async () => {
            try {
                await signInAnonymously(auth);
                const savedUser = localStorage.getItem('sgc_session_user');
                if(savedUser) {
                    const q = query(collection(db, "artifacts", appId, "public", "data", "Usuarios"), where("usuario", "==", savedUser));
                    const snap = await getDocs(q);
                    if(!snap.empty) {
                        currentUser = snap.docs[0].data();
                        setupUI();
                        document.getElementById('loading-overlay').style.display = 'none';
                        return;
                    }
                }
                document.getElementById('loading-overlay').style.display = 'none';
            } catch (e) { document.getElementById('loading-overlay').style.display = 'none'; }
        };
        initAuth();

        async function uploadToCloudinary(file) {
            if(!file) return null;
            const fd = new FormData(); 
            fd.append('file', file); 
            fd.append('upload_preset', UPLOAD_PRESET);

            let fileName = file.name || "documento";
            let baseName = fileName.includes('.') ? fileName.substring(0, fileName.lastIndexOf('.')) : fileName;
            let cleanName = baseName.normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/[^a-zA-Z0-9\-_]/g, '_').replace(/_+/g, '_');
            if(!cleanName) cleanName = 'doc';
            
            fd.append('public_id', cleanName + '_' + Date.now().toString().slice(-4)); 

            try {
                const res = await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/upload`, { method: 'POST', body: fd });
                const data = await res.json();
                if (!res.ok) return null;
                return data.secure_url || null; 
            } catch(e) { 
                return null; 
            }
        }

        function getDownloadUrl(cloudUrl) {
            if(!cloudUrl) return "#";
            if(!cloudUrl.includes('/upload/')) return cloudUrl;
            
            let urlLimpia = cloudUrl.replace(/\/fl_attachment:[^/]+\//, '/').replace(/\/fl_attachment\//, '/');
            return urlLimpia.replace('/upload/', `/upload/fl_attachment/`);
        }

        async function getNextFCI() {
            const ref = doc(db, "artifacts", appId, "public", "data", "Contadores", "solicitudes");
            let id = "";
            await runTransaction(db, async (t) => {
                const snap = await t.get(ref);
                let count = 1;
                if (snap.exists()) count = snap.data().count + 1;
                t.set(ref, { count });
                id = `FCI-SOL-${String(count).padStart(4, '0')}`;
            });
            return id;
        }

        document.getElementById('btnLogin').onclick = async () => {
            const u = document.getElementById('login-user').value.toLowerCase().trim();
            const p = document.getElementById('login-pass').value.trim();

            if(u === 'admin' && p === '1130') {
                const adminRef = doc(db, "artifacts", appId, "public", "data", "Usuarios", "admin");
                const snap = await getDoc(adminRef);
                if(!snap.exists()) {
                    await setDoc(adminRef, {
                        nombre: "Admin Maestro", usuario: "admin", pass: "1130", gerencia: "SGC", email: EMAIL_ADMIN_SGC,
                        permisos: { can_solicit:true, p_gest_sgc:true, p_ger_apr:true, p_ver_propias:true, p_ver_ger:true, p_ver_all:true, p_users:true, p_struct:true, p_ver_listado:true, admin:true }
                    });
                }
            }

            const q = query(collection(db, "artifacts", appId, "public", "data", "Usuarios"), where("usuario", "==", u), where("pass", "==", p));
            onSnapshot(q, snap => {
                if(!snap.empty) {
                    localStorage.setItem('sgc_session_user', u);
                    currentUser = snap.docs[0].data();
                    setupUI();
                } else { alert("Credenciales incorrectas"); }
            });
        };

        window.logout = () => {
            if(confirm("¬øSeguro que deseas cerrar sesi√≥n?")) {
                localStorage.removeItem('sgc_session_user');
                location.reload();
            }
        };

        function setupUI() {
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('sidebar').style.display = 'flex';
            document.getElementById('main').style.display = 'block';
            document.getElementById('curr-name').innerText = currentUser.nombre;
            document.getElementById('curr-ger').innerText = currentUser.gerencia;

            const p = currentUser.permisos || {};
            if(p.can_solicit) document.getElementById('nav-crear').classList.add('visible');
            if(p.p_ver_propias || p.p_ver_ger || p.p_ver_all) document.getElementById('nav-hist').classList.add('visible');
            if(p.p_gest_sgc || p.p_ger_apr) document.getElementById('nav-gest').classList.add('visible');
            if(p.p_ver_listado || p.admin || p.p_gest_sgc) document.getElementById('nav-listado').classList.add('visible');

            if(p.p_users || p.p_struct) document.getElementById('admin-only').style.display = 'block';
            if(p.p_users) document.getElementById('nav-users').classList.add('visible');
            if(p.p_struct) document.getElementById('nav-struct').classList.add('visible');
            
            if(p.p_gest_sgc || p.admin) { 
                document.getElementById('btn-nuevo-maestro').style.display = 'inline-block'; 
                document.getElementById('btn-import-maestro').style.display = 'inline-flex'; 
            }

            const esAdminTotal = p.admin === true;
            if(document.getElementById('btn-export-hist')) document.getElementById('btn-export-hist').style.display = esAdminTotal ? 'inline-flex' : 'none';
            if(document.getElementById('btn-export-gest')) document.getElementById('btn-export-gest').style.display = esAdminTotal ? 'inline-flex' : 'none';
            if(document.getElementById('btn-export-list')) document.getElementById('btn-export-list').style.display = esAdminTotal ? 'inline-flex' : 'none';

            cargarDatos();
            document.getElementById('nav-dash').click();
        }

        function cargarDatos() {
            const path = (c) => collection(db, "artifacts", appId, "public", "data", c);

            onSnapshot(path("Gerencias"), s => {
                let h = "<option value=''>-- Seleccionar Gerencia --</option>", l = "";
                s.forEach(d => {
                    const g = d.data();
                    h += `<option value="${g.nombre}">${g.nombre}</option>`;
                    l += `<div class="settings-item"><span>${g.nombre}</span><button class="btn-icon-danger" onclick="del('Gerencias','${d.id}')"><span class="material-icons-round" style="font-size:16px;">delete</span></button></div>`;
                });
                if(document.getElementById('sol-ger')) document.getElementById('sol-ger').innerHTML = h;
                if(document.getElementById('lm-gerencia')) document.getElementById('lm-gerencia').innerHTML = h;
                if(document.getElementById('u-ger-sel')) document.getElementById('u-ger-sel').innerHTML = h;
                if(document.getElementById('d-ger-sel')) document.getElementById('d-ger-sel').innerHTML = h; 
                if(document.getElementById('list-ger')) document.getElementById('list-ger').innerHTML = l;
                
                if(document.getElementById('sol-ger') && document.getElementById('sol-ger').value) {
                    document.getElementById('sol-ger').dispatchEvent(new Event('change'));
                }
            });

            onSnapshot(path("Departamentos"), s => {
                let l = "";
                allDepartamentos = [];
                s.forEach(d => {
                    const dep = d.data();
                    dep.docId = d.id;
                    allDepartamentos.push(dep);
                    l += `<div class="settings-item"><span>${dep.nombre} <small style="color:#94a3b8; margin-left:5px;">(${dep.gerencia || 'Sin Gerencia'})</small></span><button class="btn-icon-danger" onclick="del('Departamentos','${d.id}')"><span class="material-icons-round" style="font-size:16px;">delete</span></button></div>`;
                });
                if(document.getElementById('list-dep')) document.getElementById('list-dep').innerHTML = l;
                if(document.getElementById('sol-ger')) document.getElementById('sol-ger').dispatchEvent(new Event('change'));
            });

            onSnapshot(path("Usuarios"), s => {
                const tb = document.getElementById('tbody-users');
                if(!tb) return;
                tb.innerHTML = "";
                allUsers = []; 
                s.forEach(d => {
                    const u = d.data();
                    u.docId = d.id;
                    allUsers.push(u); 
                    tb.innerHTML += `<tr>
                        <td><b>${u.nombre}</b><br><span style="font-size:10px;color:#64748b">${u.usuario}</span></td>
                        <td>${u.email || '-'}</td>
                        <td>${u.gerencia}<br><span class="badge badge-info">${u.role || 'N/A'}</span></td>
                        <td>
                            <button class="btn btn-info" style="padding:5px 10px; font-size:10px;" onclick="cargarUsuarioParaEditar('${u.usuario}')">EDITAR</button> 
                            <button class="btn btn-danger" style="padding:5px 10px; font-size:10px;" onclick="del('Usuarios','${u.docId}')">X</button>
                        </td>
                    </tr>`;
                });
            });

            const docConfigMaestro = doc(db, "artifacts", appId, "public", "data", "Configuracion", "MaestroSettings");
            onSnapshot(docConfigMaestro, d => {
                if(d.exists()) {
                    columnasMaestro = d.data().columnas || ['C√≥digo', 'Gerencia', 'Departamento', 'Tipo de documento', 'Nombre del documento', 'Fecha de Creaci√≥n', 'Fecha √∫ltima versi√≥n', 'Versi√≥n', 'Ubicaci√≥n del Documento', 'Estatus', 'C√≥digo Anterior'];
                    estatusMaestro = d.data().estatus || ['Vigente', 'Obsoleto', 'En Revisi√≥n'];
                } else {
                    columnasMaestro = ['C√≥digo', 'Gerencia', 'Departamento', 'Tipo de documento', 'Nombre del documento', 'Fecha de Creaci√≥n', 'Fecha √∫ltima versi√≥n', 'Versi√≥n', 'Ubicaci√≥n del Documento', 'Estatus', 'C√≥digo Anterior'];
                    estatusMaestro = ['Vigente', 'Obsoleto', 'En Revisi√≥n'];
                    setDoc(docConfigMaestro, { columnas: columnasMaestro, estatus: estatusMaestro }, {merge: true});
                }
                renderListasConfig();
                renderTablaMaestro();
            });

            onSnapshot(path("Solicitudes"), s => {
                const tbHist = document.getElementById('tbody-historial');
                const tbGest = document.getElementById('tbody-gestionar');
                if(!tbHist || !tbGest) return;
                
                tbHist.innerHTML = ""; tbGest.innerHTML = "";
                let solicitudesList = [];
                s.forEach(d => { let data = d.data(); data.docId = d.id; solicitudesList.push(data); });

                solicitudesList.sort((a, b) => { return a.customId > b.customId ? 1 : -1; });
                globalSolicitudes = solicitudesList; 

                // L√≥gica de KPIs (Dashboard)
                let totalStats = solicitudesList.length;
                let aprobadosStats = solicitudesList.filter(x => (x.estado || '').toUpperCase().includes('APROBADO FINAL')).length;
                let pendientesStats = solicitudesList.filter(x => (x.estado || '').toUpperCase().includes('PENDIENTE')).length;

                if(document.getElementById('dash-total')) document.getElementById('dash-total').innerText = totalStats;
                if(document.getElementById('dash-pend')) document.getElementById('dash-pend').innerText = pendientesStats;
                if(document.getElementById('dash-ok')) document.getElementById('dash-ok').innerText = aprobadosStats;

                if(totalStats > 0) {
                    if(document.getElementById('bar-pend')) document.getElementById('bar-pend').style.width = (pendientesStats / totalStats * 100) + "%";
                    if(document.getElementById('bar-ok')) document.getElementById('bar-ok').style.width = (aprobadosStats / totalStats * 100) + "%";
                }
                if(document.getElementById('dash-date')) document.getElementById('dash-date').innerText = new Date().toLocaleDateString('es-PA', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });

                // Gr√°fico de Estados
                let conteoEstados = {};
                solicitudesList.forEach(s => {
                    let e = s.estado || 'Desconocido';
                    if(e.toUpperCase().includes('APROBADO FINAL')) e = 'Aprobado Final';
                    conteoEstados[e] = (conteoEstados[e] || 0) + 1;
                });

                const labelsChart = Object.keys(conteoEstados);
                const dataChart = Object.values(conteoEstados);
                const bgColors = labelsChart.map(l => {
                    let lUp = l.toUpperCase();
                    if(lUp.includes('APROBADO')) return '#10b981'; // success
                    if(lUp.includes('PENDIENTE')) return '#f59e0b'; // warning
                    if(lUp.includes('ANULADO') || lUp.includes('RECHAZADO')) return '#ef4444'; // danger
                    return '#3b82f6'; // info
                });

                if(chartEstados) {
                    chartEstados.data.labels = labelsChart;
                    chartEstados.data.datasets[0].data = dataChart;
                    chartEstados.data.datasets[0].backgroundColor = bgColors;
                    chartEstados.update();
                } else {
                    const ctx = document.getElementById('estadosChart');
                    if(ctx) {
                        chartEstados = new Chart(ctx, {
                            type: 'doughnut',
                            data: {
                                labels: labelsChart,
                                datasets: [{
                                    data: dataChart,
                                    backgroundColor: bgColors,
                                    borderWidth: 1
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: {
                                    legend: { position: 'right', labels: { boxWidth: 12, font: {size: 11} } }
                                }
                            }
                        });
                    }
                }

                // Generaci√≥n de Tablas
                solicitudesList.forEach(sol => {
                    const p = currentUser.permisos || {};
                    let estadoStr = (sol.estado || "").toUpperCase();
                    let isAprobadoFinal = estadoStr.includes('APROBADO FINAL');

                    let ver = p.p_ver_all || (p.p_ver_ger && sol.gerencia === currentUser.gerencia) || (p.p_ver_propias && sol.uid === currentUser.usuario);
                    
                    let badgeClass = 'badge-info';
                    if(estadoStr.includes('APROBADO')) badgeClass = 'badge-success';
                    if(estadoStr === 'ANULADO' || estadoStr === 'RECHAZADO') badgeClass = 'badge-danger';
                    if(estadoStr.includes('PENDIENTE')) badgeClass = 'badge-warning';

                    let faseActual = PASOS_NOMBRES[sol.idx] || "";
                    let estadoMostrar = sol.estado;
                    let infoFase = "";
                    
                    if (isAprobadoFinal) {
                        estadoMostrar = "APROBADO FINAL";
                    } else if (estadoStr !== 'ANULADO' && estadoStr !== 'RECHAZADO' && faseActual) {
                        infoFase = `<br><span style="font-size:10px; color:#64748b; font-weight:700; display:inline-block; margin-top:5px;">üìç Etapa: ${faseActual}</span>`;
                    }

                    if(ver) tbHist.innerHTML += `<tr><td>${sol.customId}</td><td>${sol.solicitante}</td><td>${sol.titulo}</td><td><span class="badge ${badgeClass}">${estadoMostrar}</span>${infoFase}</td><td><button class="btn btn-ghost" onclick="verDetalle('${sol.docId}')">Ver</button></td></tr>`;
                    
                    let gestionar = false;
                    if(p.p_gest_sgc && (sol.idx === 0 || sol.idx === 1 || sol.idx === 3) && estadoStr !== 'RECHAZADO' && !isAprobadoFinal && estadoStr !== 'ANULADO') gestionar = true;
                    if(p.p_ger_apr && sol.idx === 2 && sol.gerencia === currentUser.gerencia && estadoStr !== 'RECHAZADO' && estadoStr !== 'ANULADO' && !isAprobadoFinal) gestionar = true;

                    if(gestionar) tbGest.innerHTML += `<tr><td>${sol.customId}</td><td>${sol.solicitante}</td><td>${sol.titulo}</td><td><span class="badge ${badgeClass}">${estadoMostrar}</span>${infoFase}</td><td style="text-align:center;"><button class="btn btn-primary" onclick="verDetalle('${sol.docId}')">Gestionar</button></td></tr>`;
                });
            });

            onSnapshot(path("ListadoMaestro"), s => {
                dataMaestro = [];
                s.forEach(d => { let data = d.data(); data.docId = d.id; dataMaestro.push(data); });
                renderTablaMaestro();
            });
        }

        window.renderListasConfig = () => {
            let hCol = "";
            columnasMaestro.forEach((c, idx) => {
                hCol += `<div class="settings-item"><span>${c}</span><button class="btn-icon-danger" onclick="eliminarColumna(${idx})"><span class="material-icons-round" style="font-size:16px;">delete</span></button></div>`;
            });
            if(document.getElementById('list-columnas')) document.getElementById('list-columnas').innerHTML = hCol;

            let hEst = "";
            estatusMaestro.forEach((e, idx) => {
                hEst += `<div class="settings-item"><span>${e}</span><button class="btn-icon-danger" onclick="eliminarEstatus(${idx})"><span class="material-icons-round" style="font-size:16px;">delete</span></button></div>`;
            });
            if(document.getElementById('list-estatus')) document.getElementById('list-estatus').innerHTML = hEst;
        }

        window.agregarColumna = async () => {
            let val = document.getElementById('col-nom').value.trim();
            if(!val) return;
            if (columnasMaestro.includes(val)) return alert("Esa columna ya existe.");
            columnasMaestro.push(val);
            await setDoc(doc(db, "artifacts", appId, "public", "data", "Configuracion", "MaestroSettings"), { columnas: columnasMaestro, estatus: estatusMaestro }, {merge: true});
            document.getElementById('col-nom').value = "";
        }

        window.eliminarColumna = async (idx) => {
            if(!confirm("¬øEliminar columna? (Los datos guardados en las solicitudes no se borran, solo se oculta la columna visualmente)")) return;
            columnasMaestro.splice(idx, 1);
            await setDoc(doc(db, "artifacts", appId, "public", "data", "Configuracion", "MaestroSettings"), { columnas: columnasMaestro, estatus: estatusMaestro }, {merge: true});
        }

        window.agregarEstatus = async () => {
            let val = document.getElementById('est-nom').value.trim();
            if(!val) return;
            if (estatusMaestro.includes(val)) return alert("Ese estatus ya existe.");
            estatusMaestro.push(val);
            await setDoc(doc(db, "artifacts", appId, "public", "data", "Configuracion", "MaestroSettings"), { columnas: columnasMaestro, estatus: estatusMaestro }, {merge: true});
            document.getElementById('est-nom').value = "";
        }

        window.eliminarEstatus = async (idx) => {
            if(!confirm("¬øEliminar este estatus?")) return;
            estatusMaestro.splice(idx, 1);
            await setDoc(doc(db, "artifacts", appId, "public", "data", "Configuracion", "MaestroSettings"), { columnas: columnasMaestro, estatus: estatusMaestro }, {merge: true});
        }

        window.renderTablaMaestro = () => {
            const thead = document.getElementById("thead-listado-maestro");
            const tbody = document.getElementById("tbody-listado-maestro");
            if(!thead || !tbody) return;

            let headHTML = "<tr>";
            columnasMaestro.forEach(col => { headHTML += `<th>${col}</th>`; });
            if(currentUser && currentUser.permisos && (currentUser.permisos.p_gest_sgc || currentUser.permisos.admin)) {
                headHTML += `<th class="no-export">Acci√≥n</th>`;
            }
            headHTML += "</tr>";
            thead.innerHTML = headHTML;

            tbody.innerHTML = "";
            let dataSort = [...dataMaestro];
            if(columnasMaestro.length > 0) {
                let firstCol = columnasMaestro[0];
                dataSort.sort((a,b) => (a[firstCol]||"").toString().localeCompare((b[firstCol]||"").toString()));
            }

            dataSort.forEach(item => {
                let rowHTML = "<tr>";
                columnasMaestro.forEach(col => {
                    let val = item[col] || "";
                    if(val.toString().startsWith("http")) {
                        let fName = item['Nombre del documento'] || "Documento_Maestro";
                        let dUrl = getDownloadUrl(val);
                        rowHTML += `<td><a href="${dUrl}" target="_blank" class="file-link" download="${fName}">üìÅ Descargar Archivo</a></td>`;
                    } else if(col.toLowerCase().includes('estatus') || col.toLowerCase().includes('estado')) {
                         let badge = val.toLowerCase().includes('vigente') || val.toLowerCase().includes('activo') ? 'badge-success' : (val.toLowerCase().includes('obsoleto') || val.toLowerCase().includes('inactivo') ? 'badge-danger' : 'badge-warning');
                         rowHTML += `<td><span class="badge ${badge}">${val}</span></td>`;
                    } else if(col.toLowerCase().includes('fecha')) {
                         rowHTML += `<td>${window.formatearFechaAbreviada(val)}</td>`;
                    } else {
                        rowHTML += `<td>${val}</td>`;
                    }
                });
                
                if(currentUser && currentUser.permisos && (currentUser.permisos.p_gest_sgc || currentUser.permisos.admin)) {
                    let btnAcciones = `<button class="btn btn-info" style="padding:5px; font-size:10px; margin-right:5px;" onclick="abrirModalListadoMaestro('${item.docId}')">EDITAR</button>`;
                    btnAcciones += `<button class="btn btn-danger" style="padding:5px 8px; font-size:10px;" onclick="del('ListadoMaestro','${item.docId}')">X</button>`;
                    rowHTML += `<td class="no-export">${btnAcciones}</td>`;
                }
                rowHTML += "</tr>";
                tbody.innerHTML += rowHTML;
            });
        };

        window.abrirModalListadoMaestro = (docId = null) => {
            editandoMaestroId = docId;
            document.getElementById('lm-modal-title').innerText = docId ? "Editar Documento Maestro" : "Nuevo Documento Maestro";
            
            const container = document.getElementById('dinamic-form-maestro');
            container.innerHTML = "";
            
            let datosEdit = {};
            if(docId) {
                const item = dataMaestro.find(x => x.docId === docId);
                if(item) datosEdit = item;
            }

            columnasMaestro.forEach(col => {
                let val = datosEdit[col] || "";
                let html = `<div><label>${col}</label>`;
                
                if(col.toLowerCase().includes('estatus') || col.toLowerCase().includes('estado')) {
                    html += `<select id="in_dyn_${col}">`;
                    html += `<option value="">-- Seleccionar --</option>`;
                    estatusMaestro.forEach(est => {
                        html += `<option value="${est}" ${val===est?'selected':''}>${est}</option>`;
                    });
                    html += `</select>`;
                } else if(col.toLowerCase().includes('fecha')) {
                    html += `<input type="date" id="in_dyn_${col}" value="${val}">`;
                } else {
                    html += `<input type="text" id="in_dyn_${col}" value="${val}" placeholder="Escribe aqu√≠...">`;
                }
                html += `</div>`;
                container.innerHTML += html;
            });

            document.getElementById('modal-form-listado').style.display = 'flex';
        };

        window.guardarRegistroMaestro = async () => {
            let data = {};
            columnasMaestro.forEach(col => {
                let inEl = document.getElementById(`in_dyn_${col}`);
                if(inEl) data[col] = inEl.value;
            });

            document.getElementById('loading-overlay').style.display = 'flex';
            if(editandoMaestroId) {
                await updateDoc(doc(db, "artifacts", appId, "public", "data", "ListadoMaestro", editandoMaestroId), data);
            } else {
                data.registrado_por = currentUser.nombre;
                data.fecha_registro = new Date().toISOString();
                await addDoc(collection(db, "artifacts", appId, "public", "data", "ListadoMaestro"), data);
            }
            document.getElementById('loading-overlay').style.display = 'none';
            document.getElementById('modal-form-listado').style.display = 'none';
        };

        window.subirArchivoGenericoLM = async () => {
            const f = document.getElementById('lm-generic-file').files[0];
            if(!f) return alert("Selecciona un archivo primero.");
            document.getElementById('loading-overlay').style.display = 'flex';
            let url = await uploadToCloudinary(f);
            
            if(!url) {
                document.getElementById('loading-overlay').style.display = 'none';
                return alert("Hubo un error de conexi√≥n al subir el archivo a la nube.");
            }

            document.getElementById('loading-overlay').style.display = 'none';
            const inputs = Array.from(document.querySelectorAll("#dinamic-form-maestro input"));
            const targetInput = inputs.find(el => el.id.toLowerCase().includes('ubicaci') || el.id.toLowerCase().includes('archivo'));
            if(targetInput) {
                targetInput.value = url;
                alert("Archivo subido y enlace colocado en el campo correspondiente autom√°ticamente.");
            } else {
                alert("Archivo subido. Copia este enlace y p√©galo en el campo deseado:\n" + url);
            }
            document.getElementById('lm-generic-file').value = "";
        };

        if(document.getElementById('import-excel-file')){
            document.getElementById('import-excel-file').addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if(!file) return;
                document.getElementById('loading-overlay').style.display = 'flex';
                const reader = new FileReader();
                reader.onload = async (evt) => {
                    try {
                        const data = new Uint8Array(evt.target.result);
                        const workbook = XLSX.read(data, {type: 'array'});
                        const sheetName = workbook.SheetNames[0];
                        const sheet = workbook.Sheets[sheetName];
                        const json = XLSX.utils.sheet_to_json(sheet, {defval: ""});
                        
                        if(json.length > 0) {
                            const colsExcel = Object.keys(json[0]);
                            await setDoc(doc(db, "artifacts", appId, "public", "data", "Configuracion", "MaestroSettings"), { columnas: colsExcel, estatus: estatusMaestro }, {merge: true});
                            
                            for(let row of json) {
                                row.importado_por = currentUser.nombre;
                                row.fecha_importacion = new Date().toISOString();
                                await addDoc(collection(db, "artifacts", appId, "public", "data", "ListadoMaestro"), row);
                            }
                            alert(`Se importaron ${json.length} registros exitosamente.`);
                        }
                    } catch(error) {
                        alert("Hubo un error leyendo el Excel.");
                    }
                    document.getElementById('loading-overlay').style.display = 'none';
                    e.target.value = ''; 
                };
                reader.readAsArrayBuffer(file);
            });
        }

        window.exportarExcelListado = () => {
            let tablaOriginal = document.getElementById("tabla-listado-maestro");
            if(!tablaOriginal) return;
            let tablaClon = tablaOriginal.cloneNode(true);
            let elementsToRemove = tablaClon.querySelectorAll('.no-export');
            elementsToRemove.forEach(el => el.parentNode.removeChild(el));

            let wb = XLSX.utils.table_to_book(tablaClon, {sheet:"Listado Maestro"});
            XLSX.writeFile(wb, "Listado_Maestro_SGC.xlsx");
        };

        if(document.getElementById('sol-ger')){
            document.getElementById('sol-ger').addEventListener('change', (e) => {
                const gSelected = e.target.value;
                const gerente = allUsers.find(u => u.gerencia === gSelected && u.permisos && u.permisos.p_ger_apr === true);
                if (gerente) {
                    document.getElementById('sol-gerente-display').value = gerente.nombre;
                    document.getElementById('sol-email-gerente').value = gerente.email || "Sin Email";
                } else {
                    document.getElementById('sol-gerente-display').value = "No asignado";
                    document.getElementById('sol-email-gerente').value = "";
                }

                const depSelect = document.getElementById('sol-dep');
                depSelect.innerHTML = "<option value=''>-- Seleccionar Departamento --</option>";
                const depsFiltrados = allDepartamentos.filter(d => d.gerencia === gSelected);
                depsFiltrados.forEach(d => {
                    depSelect.innerHTML += `<option value="${d.nombre}">${d.nombre}</option>`;
                });
            });
        }

        window.cargarUsuarioParaEditar = (usuarioId) => {
            const u = allUsers.find(x => x.usuario === usuarioId);
            if(!u) return;

            document.getElementById('user-form-title').innerText = "Editando Usuario: " + u.usuario;
            document.getElementById('u-nom').value = u.nombre || '';
            document.getElementById('u-usr').value = u.usuario || '';
            document.getElementById('u-usr').disabled = true; 
            document.getElementById('u-pas').value = u.pass || '';
            document.getElementById('u-ger-sel').value = u.gerencia || '';
            document.getElementById('u-rol').value = u.role || '';
            document.getElementById('u-email').value = u.email || '';

            const p = u.permisos || {};
            document.getElementById('p-solicitar').checked = p.can_solicit || false;
            document.getElementById('p-ver-propias').checked = p.p_ver_propias || false;
            document.getElementById('p-ver-ger').checked = p.p_ver_ger || false;
            document.getElementById('p-gest-sgc').checked = p.p_gest_sgc || false;
            document.getElementById('p-ger-apr').checked = p.p_ger_apr || false;
            document.getElementById('p-users').checked = p.p_users || false;
            document.getElementById('p-struct').checked = p.p_struct || false;
            document.getElementById('p-ver-listado').checked = p.p_ver_listado || false;
            document.getElementById('p-admin').checked = p.admin || false;

            document.getElementById('btnSaveUser').innerText = "ACTUALIZAR USUARIO";
            document.getElementById('btnCancelEdit').style.display = 'inline-flex';
            window.scrollTo({ top: 0, behavior: 'smooth' });
        };

        window.actualizarDatosSGC = async () => {
            const tit = document.getElementById('m-upd-tit').value;
            const cod = document.getElementById('m-upd-cod').value;
            const ver = document.getElementById('m-upd-ver').value;
            const f = document.getElementById('m-upd-file');
            
            if(!tit) return alert("El t√≠tulo es obligatorio.");

            document.getElementById('loading-overlay').style.display = 'flex';
            
            let updateData = {
                titulo: tit,
                cod_ref: cod,
                ver_ref: ver
            };

            let msjChat = `SGC actualiz√≥ los datos pre-aprobaci√≥n. T√≠tulo: ${tit}, C√≥d: ${cod}, Ver: ${ver}.`;

            if(f.files[0]) {
                let fileUrl = await uploadToCloudinary(f.files[0]);
                
                if(!fileUrl) {
                    document.getElementById('loading-overlay').style.display = 'none';
                    return alert("Hubo un error al tratar de subir el archivo adjunto. Intenta de nuevo.");
                }

                let fileName = f.files[0].name;
                updateData.adjunto = fileUrl;
                updateData.adjunto_nombre = fileName;
                msjChat += ` (Nuevo adjunto subido: ${fileName})`;
            }

            await updateDoc(doc(db, "artifacts", appId, "public", "data", "Solicitudes", selectedId), {
                ...updateData,
                chat: arrayUnion({u: currentUser.nombre, m: `‚úèÔ∏è ${msjChat}`, t: new Date().toLocaleString()})
            });

            document.getElementById('loading-overlay').style.display = 'none';
            alert("Datos actualizados correctamente.");
            closeModal();
        }

        window.verDetalle = async (id) => {
            selectedId = id;
            const docSnap = await getDoc(doc(db, "artifacts", appId, "public", "data", "Solicitudes", id));
            selectedDocData = docSnap.data();
            const s = selectedDocData;
            const p = currentUser.permisos;
            
            document.getElementById('m-id').innerText = s.customId;
            document.getElementById('m-tit').innerText = s.titulo;
            document.getElementById('m-sol').innerText = s.solicitante;
            
            let estadoStr = (s.estado || "").toUpperCase();
            let isAprobadoFinalModal = estadoStr.includes('APROBADO FINAL');

            let badgeClass = 'badge-info';
            if(estadoStr.includes('APROBADO')) badgeClass = 'badge-success';
            if(estadoStr === 'ANULADO' || estadoStr === 'RECHAZADO') badgeClass = 'badge-danger';
            if(estadoStr.includes('PENDIENTE')) badgeClass = 'badge-warning';

            let estadoMostrarModal = isAprobadoFinalModal ? 'APROBADO FINAL' : s.estado;
            document.getElementById('m-est').innerText = estadoMostrarModal;
            document.getElementById('m-est').className = `badge ${badgeClass}`;

            let fActual = PASOS_NOMBRES[s.idx];
            if (!isAprobadoFinalModal && estadoStr !== 'ANULADO' && estadoStr !== 'RECHAZADO' && fActual) {
                document.getElementById('m-est').innerHTML += ` <span style="font-size:10px; color:#64748b; font-weight:700; margin-left:8px; background:transparent; border:none; display:inline-block; vertical-align:middle;">(üìç Etapa: ${fActual})</span>`;
            }

            document.getElementById('m-ger').innerText = s.gerencia;
            document.getElementById('m-tipo').innerText = s.tipoDoc || "N/A"; 
            document.getElementById('m-accion').innerText = s.accion;
            document.getElementById('m-jus').innerText = s.motivo || s.justificacion || "Sin justificaci√≥n";

            let adjOrigName = s.adjunto_nombre || "Descargar Archivo";
            if(adjOrigName.startsWith('http')) {
                try { adjOrigName = decodeURIComponent(adjOrigName.split('/').pop().split('?')[0]); } catch(e){}
            }
            let dlUrl = s.adjunto ? getDownloadUrl(s.adjunto) : "#";
            document.getElementById('m-file-link').innerHTML = s.adjunto ? `<a href="${dlUrl}" target="_blank" class="file-link" download="${adjOrigName}">üìé ${adjOrigName}</a>` : "Sin archivo";
            
            if(s.accion !== 'Creaci√≥n') {
                document.getElementById('m-extra-panel').style.display = 'block';
                document.getElementById('m-cod').innerText = s.cod_ref;
                document.getElementById('m-ver').innerText = s.ver_ref;
                document.getElementById('m-fecha-ult').innerText = window.formatearFechaAbreviada(s.fecha_ref);
            } else document.getElementById('m-extra-panel').style.display = 'none';

            let invList = s.involucrados && s.involucrados.length > 0 ? s.involucrados.join(', ') : "No hay personas extras a√±adidas.";
            document.getElementById('m-involucrados-list').innerText = invList;

            for(let i=1; i<=4; i++) {
                const st = document.getElementById('s'+i);
                st.className = 'step'; 
                if(estadoStr === 'ANULADO' || estadoStr === 'RECHAZADO') continue;
                if(i <= s.idx) st.classList.add('completed'); 
                if(i === s.idx + 1 && !isAprobadoFinalModal) st.classList.add('active');
            }

            const esSGC = p.p_gest_sgc;
            const esGestorSGC = esSGC && (s.idx === 0 || s.idx === 1 || s.idx === 3);
            const esGer = p.p_ger_apr && s.idx === 2 && s.gerencia === currentUser.gerencia;
            const esDuenio = s.uid === currentUser.usuario;
            const activo = !isAprobadoFinalModal && estadoStr !== 'RECHAZADO' && estadoStr !== 'ANULADO';

            document.getElementById('m-add-involucrado-section').style.display = activo ? 'flex' : 'none';
            document.getElementById('m-actions').style.display = (esGestorSGC || esGer) && activo ? 'block' : 'none';
            document.getElementById('applicant-actions').style.display = (esDuenio && activo) ? 'block' : 'none';
            document.getElementById('m-input-area').style.display = 'none';
            document.getElementById('general-comment-area').style.display = estadoStr !== 'ANULADO' ? 'block' : 'none';
            document.getElementById('btn-anular').style.display = (esSGC || esDuenio) && activo ? 'inline-block' : 'none';

            document.getElementById('m-panel-final-sgc').style.display = 'none';
            document.getElementById('m-panel-update-sgc').style.display = 'none';
            document.getElementById('m-display-final').style.display = 'none';
            document.getElementById('m-original-data').classList.remove('locked-data');
            document.getElementById('m-orig-title').style.display = 'none';

            if (esSGC && s.idx === 1 && activo) {
                document.getElementById('m-panel-update-sgc').style.display = 'block';
                document.getElementById('m-upd-tit').value = s.titulo || '';
                document.getElementById('m-upd-cod').value = s.cod_ref || '';
                document.getElementById('m-upd-ver').value = s.ver_ref || '';
            }
            
            if (isAprobadoFinalModal) {
                if (s.version_final) {
                    document.getElementById('m-original-data').classList.add('locked-data');
                    document.getElementById('m-orig-title').style.display = 'flex';
                    
                    document.getElementById('m-display-final').style.display = 'block';
                    document.getElementById('m-disp-cod').innerText = s.codigo_final || s.cod_ref || "N/A";
                    document.getElementById('m-disp-ver').innerText = s.version_final;
                    document.getElementById('m-disp-fecha').innerText = s.fecha_final ? window.formatearFechaAbreviada(s.fecha_final) : "N/A";
                    document.getElementById('m-disp-com').innerText = s.comentario_final || "Sin comentarios adicionales.";
                    
                    let finName = s.documento_final_nombre || "Documento Oficial Final";
                    if(finName.startsWith('http')) {
                        try { finName = decodeURIComponent(finName.split('/').pop().split('?')[0]); } catch(e){} 
                    }
                    let finUrl = s.documento_final ? getDownloadUrl(s.documento_final) : "#";
                    document.getElementById('m-disp-file').innerHTML = s.documento_final ? `<a href="${finUrl}" target="_blank" class="file-link" style="font-size:14px;" download="${finName}">üìÑ ${finName}</a>` : "N/A";

                    if(p.admin) {
                        document.getElementById('btn-edit-fecha-final').style.display = 'inline-block';
                        document.getElementById('btn-edit-fecha-final').onclick = () => {
                            document.getElementById('m-disp-fecha').style.display = 'none';
                            document.getElementById('btn-edit-fecha-final').style.display = 'none';
                            document.getElementById('edit-fecha-final-container').style.display = 'block';
                            if(s.fecha_final) {
                                let df = s.fecha_final;
                                if(df.includes('T')) df = df.split('T')[0];
                                document.getElementById('in-edit-fecha-final').value = df;
                            }
                        };
                        document.getElementById('btn-cancel-fecha-final').onclick = () => {
                            document.getElementById('m-disp-fecha').style.display = 'block';
                            document.getElementById('btn-edit-fecha-final').style.display = 'inline-block';
                            document.getElementById('edit-fecha-final-container').style.display = 'none';
                        };
                        document.getElementById('btn-save-fecha-final').onclick = async () => {
                            const nv = document.getElementById('in-edit-fecha-final').value;
                            if(!nv) return;
                            document.getElementById('loading-overlay').style.display = 'flex';
                            
                            await updateDoc(doc(db, "artifacts", appId, "public", "data", "Solicitudes", selectedId), { fecha_final: nv });
                            
                            const codBusqueda = s.codigo_final || s.cod_ref;
                            if(codBusqueda) {
                                const qMaestro = query(collection(db, "artifacts", appId, "public", "data", "ListadoMaestro"), where("C√≥digo", "==", codBusqueda));
                                const snapM = await getDocs(qMaestro);
                                if(!snapM.empty) {
                                    let idM = snapM.docs[0].id;
                                    let colFech = columnasMaestro.find(c => c.toLowerCase().includes('fecha √∫ltima') || c.toLowerCase().includes('fecha ultima') || c.toLowerCase() === 'fecha');
                                    if(colFech) {
                                        await updateDoc(doc(db, "artifacts", appId, "public", "data", "ListadoMaestro", idM), { [colFech]: nv });
                                    }
                                }
                            }
                            
                            document.getElementById('loading-overlay').style.display = 'none';
                            document.getElementById('edit-fecha-final-container').style.display = 'none';
                            alert("Fecha actualizada correctamente.");
                            verDetalle(selectedId);
                        };
                    } else {
                        document.getElementById('btn-edit-fecha-final').style.display = 'none';
                        document.getElementById('edit-fecha-final-container').style.display = 'none';
                    }

                } else if (esSGC) {
                    document.getElementById('m-panel-final-sgc').style.display = 'block';
                    document.getElementById('m-final-cod').value = s.cod_ref || ""; 
                }
            }

            if(activo) document.getElementById('btn-firma-next').innerText = `Aprobar Etapa (${PASOS_NOMBRES[s.idx] || 'Final'})`;
            
            const cb = document.getElementById('chat-box');
            cb.innerHTML = s.chat ? s.chat.map(c => `
                <div class="chat-msg" style="border-left-color:${c.u===currentUser.nombre?'var(--primary)':'#cbd5e1'}">
                    <b style="font-size:10px">${c.u}</b> <span style="font-size:9px;color:#94a3b8">${c.t}</span><br>${c.m}
                    ${c.archivo ? `<br><a href="${getDownloadUrl(c.archivo)}" target="_blank" style="font-size:10px;color:blue" download="Documento_Adjunto">Ver Adjunto</a>` : ''}
                </div>
            `).join('') : '';

            document.getElementById('modal').style.display = 'flex';
        };

        window.gestionar = (tipo) => {
            tempAction = tipo;
            document.getElementById('m-input-area').style.display = 'block';
            if(tipo === 'Reuni√≥n') {
                document.getElementById('reunion-container').style.display = 'block';
                document.getElementById('m-extra-input').placeholder = 'Tema de la reuni√≥n...';
            } else {
                document.getElementById('reunion-container').style.display = 'none';
                document.getElementById('m-extra-input').placeholder = 'Motivo / Consulta / Comentario';
            }
        };

        window.responderSolicitante = () => {
            tempAction = "Respuesta";
            document.getElementById('m-input-area').style.display = 'block';
            document.getElementById('m-extra-input').placeholder = "Describe tu respuesta o correcci√≥n...";
            document.getElementById('reunion-container').style.display = 'none';
        }

        window.firmarPaso = async () => {
            const s = selectedDocData;
            const nIdx = s.idx + 1;
            const nEst = nIdx < 4 ? PASOS_NOMBRES[nIdx] : "Aprobado Final";
            const faseAprobada = PASOS_NOMBRES[s.idx]; 
            
            await updateDoc(doc(db, "artifacts", appId, "public", "data", "Solicitudes", selectedId), {
                idx: nIdx, estado: nEst,
                chat: arrayUnion({u: currentUser.nombre, m: `‚úÖ FASE COMPLETADA: ${faseAprobada}`, t: new Date().toLocaleString()})
            });

            const dest = await getDatosEnvio(s);
            sendNotification(dest, `Avance: ${s.customId}`, `La solicitud avanz√≥ a: ${nEst}.`);
            closeModal();
        };

        window.enviarComentarioLibre = async () => {
            const txt = document.getElementById('m-comentario-libre').value;
            const f = document.getElementById('m-file-comentario');
            if(!txt && !f.files[0]) return alert("Escribe un mensaje o adjunta un archivo.");
            
            document.getElementById('loading-overlay').style.display = 'flex';
            
            let fileUrl = null;
            if (f.files[0]) {
                fileUrl = await uploadToCloudinary(f.files[0]);
                if (!fileUrl) {
                    document.getElementById('loading-overlay').style.display = 'none';
                    return alert("Error de red al intentar subir el archivo a Cloudinary. Intenta de nuevo.");
                }
            }
            
            let chatPayload = {u: currentUser.nombre, m: `üí¨ Comentario: ${txt}`, t: new Date().toLocaleString()};
            if (fileUrl) chatPayload.archivo = fileUrl; 

            await updateDoc(doc(db, "artifacts", appId, "public", "data", "Solicitudes", selectedId), {
                chat: arrayUnion(chatPayload)
            });

            const dest = await getDatosEnvio(selectedDocData);
            sendNotification(dest, `Nuevo Comentario: ${selectedDocData.customId}`, `${currentUser.nombre} ha dejado un comentario: ${txt}`);

            document.getElementById('m-comentario-libre').value = "";
            f.value = "";
            document.getElementById('loading-overlay').style.display = 'none';
            closeModal();
        }

        window.guardarCierreFinal = async () => {
            const codFinal = document.getElementById('m-final-cod').value;
            const ver = document.getElementById('m-final-ver').value;
            const fecha = document.getElementById('m-final-fecha').value;
            const com = document.getElementById('m-final-comentario').value;
            const f = document.getElementById('m-final-file');
            
            if(!ver || !fecha || !f.files[0]) return alert("La Versi√≥n Final, la Fecha y el Documento son obligatorios.");
            
            document.getElementById('loading-overlay').style.display = 'flex';
            
            let fileUrl = await uploadToCloudinary(f.files[0]);
            
            if (!fileUrl) {
                document.getElementById('loading-overlay').style.display = 'none';
                return alert("Error al subir el documento final. Por favor, intenta de nuevo.");
            }
            
            let fileName = f.files[0].name;
            let chatPayload = {u: "SISTEMA (SGC)", m: `üèÅ SOLICITUD APROBADA FINALMENTE Y PUBLICADA. Ver: ${ver}. Obs: ${com}`, t: new Date().toLocaleString(), archivo: fileUrl};

            await updateDoc(doc(db, "artifacts", appId, "public", "data", "Solicitudes", selectedId), {
                estado: "Aprobado Final", 
                codigo_final: codFinal,
                version_final: ver,
                fecha_final: fecha,
                comentario_final: com,
                documento_final: fileUrl,
                documento_final_nombre: fileName,
                chat: arrayUnion(chatPayload)
            });

            let dataMaestro = {
                estatus: "Vigente",
                registrado_por: "Sistema (Autom√°tico)",
                fecha_registro: new Date().toISOString()
            };
            
            columnasMaestro.forEach(c => {
                let low = c.toLowerCase();
                if(low.includes('c√≥digo') || low === 'codigo') dataMaestro[c] = codFinal || selectedDocData.cod_ref || "POR_ASIGNAR";
                else if(low.includes('gerencia')) dataMaestro[c] = selectedDocData.gerencia;
                else if(low.includes('departamento')) dataMaestro[c] = selectedDocData.departamento;
                else if(low.includes('tipo')) dataMaestro[c] = selectedDocData.tipoDoc;
                else if(low.includes('nombre')) dataMaestro[c] = selectedDocData.titulo;
                else if(low.includes('vers')) dataMaestro[c] = ver;
                else if(low.includes('ubicaci') || low.includes('archivo') || low.includes('documento')) dataMaestro[c] = fileUrl;
                else if(low.includes('fecha √∫ltima') || low.includes('fecha ultima') || low === 'fecha') dataMaestro[c] = fecha;
            });

            await addDoc(collection(db, "artifacts", appId, "public", "data", "ListadoMaestro"), dataMaestro);

            const dest = await getDatosEnvio(selectedDocData);
            sendNotification(dest, `Cierre Exitoso: ${selectedDocData.customId}`, `La solicitud ha sido finalizada y el documento versi√≥n ${ver} est√° publicado y agregado al Listado Maestro.`);

            document.getElementById('loading-overlay').style.display = 'none';
            closeModal();
        }

        window.anularSolicitud = async () => {
            if(!confirm("‚ö†Ô∏è ¬øEst√°s seguro de anular esta solicitud? Esta acci√≥n detendr√° todo el proceso y es irreversible.")) return;
            let motivo = prompt("Describe el motivo de la anulaci√≥n:");
            if(!motivo) return alert("Se requiere un motivo para anular.");

            document.getElementById('loading-overlay').style.display = 'flex';
            await updateDoc(doc(db, "artifacts", appId, "public", "data", "Solicitudes", selectedId), {
                estado: "Anulado",
                chat: arrayUnion({u: currentUser.nombre, m: `üö´ SOLICITUD ANULADA. Motivo: ${motivo}`, t: new Date().toLocaleString()})
            });

            const dest = await getDatosEnvio(selectedDocData);
            sendNotification(dest, `Cancelaci√≥n: ${selectedDocData.customId}`, `La solicitud ha sido ANULADA por ${currentUser.nombre}. Motivo: ${motivo}`);

            document.getElementById('loading-overlay').style.display = 'none';
            closeModal();
        }

        document.getElementById('btnConfirmAction').onclick = async () => {
            const txt = document.getElementById('m-extra-input').value;
            const f = document.getElementById('m-file-gestion');
            let mensajeFinal = "";
            let nEst = "";

            if (tempAction === "Respuesta") {
                mensajeFinal = `Respuesta del Usuario: ${txt}`;
                nEst = "Respuesta Recibida"; 
            } else {
                mensajeFinal = `${tempAction}: ${txt}`;
                if(tempAction === 'Reuni√≥n') {
                    const fechaReunion = document.getElementById('m-date-meeting').value;
                    if(!fechaReunion) { alert("Selecciona fecha y hora"); return; }
                    mensajeFinal += `\nüìÖ Fecha: ${fechaReunion.replace('T', ' ')}`;
                }
                nEst = tempAction === 'Rechazado' ? 'Rechazado' : `En ${tempAction}`;
            }

            document.getElementById('loading-overlay').style.display = 'flex';

            let fileUrl = null;
            if(f.files[0]) {
                fileUrl = await uploadToCloudinary(f.files[0]);
                if (!fileUrl) {
                    document.getElementById('loading-overlay').style.display = 'none';
                    return alert("Error al adjuntar archivo. Verifica tu conexi√≥n a internet e intenta de nuevo.");
                }
            }
            
            let chatPayload = {u: currentUser.nombre, m: mensajeFinal, t: new Date().toLocaleString()};
            if (fileUrl) chatPayload.archivo = fileUrl;

            await updateDoc(doc(db, "artifacts", appId, "public", "data", "Solicitudes", selectedId), {
                estado: nEst,
                chat: arrayUnion(chatPayload)
            });

            const dest = await getDatosEnvio(selectedDocData);
            sendNotification(dest, `Actualizaci√≥n: ${selectedDocData.customId}`, mensajeFinal);

            document.getElementById('m-input-area').style.display = 'none';
            document.getElementById('loading-overlay').style.display = 'none';
            closeModal();
        };

        window.rechazar = () => { tempAction = 'Rechazado'; document.getElementById('m-input-area').style.display='block'; document.getElementById('reunion-container').style.display = 'none'; };

        document.getElementById('btnSendSol').onclick = async () => {
            const tit = document.getElementById('sol-tit').value;
            const gerTarget = document.getElementById('sol-ger').value;
            if(!tit) { alert("El t√≠tulo es obligatorio"); return; }

            document.getElementById('loading-overlay').style.display = 'flex';
            const f = document.getElementById('sol-file');
            
            let fileName = f.files[0] ? f.files[0].name : "";
            let url = null;
            
            if (f.files[0]) {
                url = await uploadToCloudinary(f.files[0]);
                if (!url) {
                    document.getElementById('loading-overlay').style.display = 'none';
                    return alert("Hubo un problema al subir el archivo a Cloudinary. Por favor, intenta de nuevo.");
                }
            }

            const extraEmailsNodes = document.querySelectorAll('.extra-email');
            const extraEmails = Array.from(extraEmailsNodes).map(el => el.value.trim().toLowerCase()).filter(e => e !== "" && e.includes('@'));
            const fci = await getNextFCI();
            const gerenteEmailVisible = document.getElementById('sol-email-gerente').value;

            const data = {
                customId: fci,
                titulo: tit,
                accion: document.getElementById('sol-accion').value,
                tipoDoc: document.getElementById('sol-tipo-doc').value,
                gerencia: gerTarget,
                departamento: document.getElementById('sol-dep').value,
                motivo: document.getElementById('sol-motivo').value,
                cod_ref: document.getElementById('sol-cod-prev').value,
                ver_ref: document.getElementById('sol-ver-prev').value,
                fecha_ref: document.getElementById('sol-fecha-prev').value,
                solicitante: currentUser.nombre,
                solicitante_email: currentUser.email, 
                uid: currentUser.usuario,
                involucrados: extraEmails, 
                idx: 0,
                estado: "Pendiente Documentado",
                adjunto: url,
                adjunto_nombre: fileName, 
                chat: [{u: "SISTEMA", m: "Solicitud creada exitosamente.", t: new Date().toLocaleString()}],
                fecha: new Date().toISOString()
            };

            await addDoc(collection(db, "artifacts", appId, "public", "data", "Solicitudes"), data);
            
            document.getElementById('lista-involucrados').innerHTML = "";

            const toEmails = new Set([EMAIL_ADMIN_SGC, EMAIL_GRUPO_SGC, currentUser.email, ...extraEmails]);
            const destinatarios = {
                to: Array.from(toEmails).join(','),
                cc: gerenteEmailVisible
            };

            sendNotification(destinatarios, "Nueva Solicitud Creada", `El usuario ${currentUser.nombre} ha creado la solicitud ${fci}: ${tit} para la gerencia ${gerTarget}.`);

            document.getElementById('loading-overlay').style.display = 'none';
            alert("Solicitud Creada: " + fci);
            cambiarVista('sec-hist', document.getElementById('nav-hist'));
        };

        // GESTI√ìN DE USUARIOS
        document.getElementById('btnSaveUser').onclick = async () => {
            const u = document.getElementById('u-usr').value.toLowerCase().trim();
            const p = document.getElementById('u-pas').value;
            const email = document.getElementById('u-email').value;
            if(!u || !p) { alert("Usuario y contrase√±a requeridos"); return; }

            const perms = {
                can_solicit: document.getElementById('p-solicitar').checked,
                p_ver_propias: document.getElementById('p-ver-propias').checked,
                p_ver_ger: document.getElementById('p-ver-ger').checked,
                p_ver_all: document.getElementById('p-admin').checked,
                p_gest_sgc: document.getElementById('p-gest-sgc').checked,
                p_ger_apr: document.getElementById('p-ger-apr').checked,
                p_users: document.getElementById('p-users').checked,
                p_struct: document.getElementById('p-struct').checked,
                p_ver_listado: document.getElementById('p-ver-listado').checked, 
                admin: document.getElementById('p-admin').checked
            };
            
            await setDoc(doc(db, "artifacts", appId, "public", "data", "Usuarios", u), {
                nombre: document.getElementById('u-nom').value,
                usuario: u,
                pass: p,
                role: document.getElementById('u-rol').value,
                gerencia: document.getElementById('u-ger-sel').value,
                email: email, 
                permisos: perms
            }, {merge: true});

            alert("Usuario Guardado/Actualizado Correctamente");
            resetUserForm();
        };

        document.getElementById('btnSaveGer').onclick = async () => { await addDoc(collection(db, "artifacts", appId, "public", "data", "Gerencias"), {nombre: document.getElementById('g-nom').value}); document.getElementById('g-nom').value = ""; };
        document.getElementById('btnSaveDep').onclick = async () => { 
            const ger = document.getElementById('d-ger-sel').value;
            const nom = document.getElementById('d-nom').value.trim();
            if(!ger || !nom) return alert("Por favor, seleccione una Gerencia y escriba el nombre del Departamento.");
            await addDoc(collection(db, "artifacts", appId, "public", "data", "Departamentos"), {
                nombre: nom, 
                gerencia: ger
            }); 
            document.getElementById('d-nom').value = ""; 
        };

        window.cambiarVista = (id, btn) => {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            if(btn) btn.classList.add('active');
            
            if(window.innerWidth <= 768) {
                document.getElementById('sidebar').classList.remove('open');
                document.getElementById('sidebar-overlay').classList.remove('active');
            }
        };
        window.toggleModPanel = v => document.getElementById('panel-mod').style.display = v === 'Creaci√≥n' ? 'none' : 'grid';
        window.closeModal = () => document.getElementById('modal').style.display = 'none';
        window.del = async (c, id) => { if(confirm("¬øEliminar este registro?")) await deleteDoc(doc(db, "artifacts", appId, "public", "data", c, id)); };

    </script>
</body>
</html>
