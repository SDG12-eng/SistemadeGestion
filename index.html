<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sistema de Gestión - Dashboard</title>
<style>
body { font-family: Arial, sans-serif; margin:0; padding:0; background:#f4f4f4; }
header { background:#007bff; color:white; padding:10px 20px; }
h1 { margin:0; font-size:24px; }
.container { display:flex; flex-wrap:wrap; padding:20px; }
.card { background:white; border-radius:8px; padding:20px; margin:10px; flex:1 1 300px; box-shadow:0 2px 5px rgba(0,0,0,0.1); }
input, select, textarea, button { width:100%; padding:8px; margin:5px 0; border-radius:4px; border:1px solid #ccc; }
button { background:#007bff; color:white; border:none; cursor:pointer; }
button:hover { background:#0056b3; }
table { width:100%; border-collapse:collapse; margin-top:10px; }
th, td { padding:8px; border:1px solid #ccc; text-align:left; }
.tab { display:none; }
.nav { margin:10px 0; }
.nav button { display:inline-block; width:auto; margin-right:5px; }
</style>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.6.5/axios.min.js"></script>
<script>
// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyDdzCiachuhbE9jATz-TesPI2vUVIJrHjM",
  authDomain: "sistemadegestion-7400d.firebaseapp.com",
  projectId: "sistemadegestion-7400d",
  storageBucket: "sistemadegestion-7400d.appspot.com",
  messagingSenderId: "709030283072",
  appId: "1:709030283072:web:5997837b36a448e9515ca5"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// Variables globales
let usuarioActual = null;
let rolActual = null;

// LOGIN SIMPLE
function login() {
  const usuario = document.getElementById('loginUsuario').value;
  const pass = document.getElementById('loginPassword').value;

  // acceso directo Admin
  if(usuario==='Admin' && pass==='1130'){
    usuarioActual='Admin';
    rolActual='Admin';
    document.getElementById('loginPanel').style.display='none';
    document.getElementById('dashboard').style.display='block';
    cargarDashboard();
    return;
  }

  db.collection('usuarios').doc(usuario).get().then(doc=>{
    if(doc.exists && doc.data().password===pass){
      usuarioActual = usuario;
      rolActual = doc.data().rol;
      document.getElementById('loginPanel').style.display='none';
      document.getElementById('dashboard').style.display='block';
      cargarDashboard();
    } else {
      alert('Usuario o contraseña incorrectos');
    }
  });
}

// DASHBOARD
function cargarDashboard() {
  const adminTabs = ['usuariosTab','gerenciasTab','departamentosTab','solicitudesTab'];
  const gerenteTabs = ['solicitudesTab'];
  const usuarioTabs = ['solicitudesTab'];

  document.querySelectorAll('.tab').forEach(t=>t.style.display='none');
  document.querySelectorAll('.nav button').forEach(b=>b.style.display='none');

  if(rolActual==='Admin'){
    adminTabs.forEach(id=>document.getElementById(id+'Btn').style.display='inline-block');
  } else if(rolActual==='Gerente'){
    gerenteTabs.forEach(id=>document.getElementById(id+'Btn').style.display='inline-block');
  } else {
    usuarioTabs.forEach(id=>document.getElementById(id+'Btn').style.display='inline-block');
  }

  mostrarTab('solicitudesTab');
  cargarSolicitudes();
  cargarUsuarios();
  cargarGerencias();
  cargarDepartamentos();
}

// TAB NAV
function mostrarTab(tabId){
  document.querySelectorAll('.tab').forEach(t=>t.style.display='none');
  document.getElementById(tabId).style.display='block';
}

// CARGAR USUARIOS
function cargarUsuarios(){
  const tbody = document.getElementById('usuariosBody');
  tbody.innerHTML='';
  db.collection('usuarios').get().then(snapshot=>{
    snapshot.forEach(doc=>{
      const u = doc.data();
      tbody.innerHTML+=`<tr>
        <td>${doc.id}</td>
        <td>${u.password}</td>
        <td>${u.rol}</td>
        <td>${u.gerencia||''}</td>
        <td>${u.departamento||''}</td>
      </tr>`;
    });
  });
}

// CREAR USUARIO
function crearUsuario(){
  const u = document.getElementById('nuevoUsuario').value;
  const p = document.getElementById('nuevaPassword').value;
  const r = document.getElementById('nuevoRol').value;
  const g = document.getElementById('nuevoGerencia').value;
  const d = document.getElementById('nuevoDepartamento').value;
  db.collection('usuarios').doc(u).set({
    password:p,
    rol:r,
    gerencia:g,
    departamento:d
  }).then(()=>{ alert('Usuario creado'); cargarUsuarios(); });
}

// CARGAR GERENCIAS
function cargarGerencias(){
  const tbody = document.getElementById('gerenciasBody');
  tbody.innerHTML='';
  db.collection('gerencias').get().then(snapshot=>{
    snapshot.forEach(doc=>{
      tbody.innerHTML+=`<tr><td>${doc.id}</td></tr>`;
    });
  });
}

// CREAR GERENCIA
function crearGerencia(){
  const g = document.getElementById('nuevaGerenciaName').value;
  db.collection('gerencias').doc(g).set({nombre:g}).then(()=>{ alert('Gerencia creada'); cargarGerencias(); });
}

// CARGAR DEPARTAMENTOS
function cargarDepartamentos(){
  const tbody = document.getElementById('departamentosBody');
  tbody.innerHTML='';
  db.collection('departamentos').get().then(snapshot=>{
    snapshot.forEach(doc=>{
      tbody.innerHTML+=`<tr><td>${doc.id}</td></tr>`;
    });
  });
}

// CREAR DEPARTAMENTO
function crearDepartamento(){
  const d = document.getElementById('nuevoDepartamentoName').value;
  db.collection('departamentos').doc(d).set({nombre:d}).then(()=>{ alert('Departamento creado'); cargarDepartamentos(); });
}

// SUBIR A CLOUDINARY
async function subirDocumento(file){
  if(!file) return '';
  const form = new FormData();
  form.append('file',file);
  form.append('upload_preset','documentos'); // Cambiar por tu preset
  const res = await axios.post('https://api.cloudinary.com/v1_1/demo12345/upload',form); // Cambiar demo12345
  return res.data.secure_url;
}

// CREAR SOLICITUD
async function crearSolicitud(){
  const nombre = document.getElementById('solNombre').value;
  const tipo = document.getElementById('solTipo').value;
  const accion = document.getElementById('solAccion').value;
  const gerencia = document.getElementById('solGerencia').value;
  const departamento = document.getElementById('solDepartamento').value;
  const motivo = document.getElementById('solMotivo').value;
  const archivo = document.getElementById('solArchivo').files[0];
  const archivoURL = archivo ? await subirDocumento(archivo) : '';

  const estados = [
    {estado:'Pendiente', comentario:'', fecha:new Date()},
  ];

  db.collection('solicitudes').add({
    usuario:usuarioActual,
    nombre,
    tipo,
    accion,
    gerencia,
    departamento,
    motivo,
    archivo:archivoURL,
    estados
  }).then(()=>{ alert('Solicitud creada'); cargarSolicitudes(); });
}

// CARGAR SOLICITUDES
function cargarSolicitudes(){
  const tbody = document.getElementById('solicitudesBody');
  tbody.innerHTML='';
  db.collection('solicitudes').get().then(snapshot=>{
    snapshot.forEach(doc=>{
      const s = doc.data();
      // Filtrado según rol
      if(rolActual==='Usuario' && s.usuario!==usuarioActual) return;
      if(rolActual==='Gerente' && s.gerencia!==getGerencia(usuarioActual)) return;

      tbody.innerHTML+=`<tr>
        <td>${doc.id}</td>
        <td>${s.usuario}</td>
        <td>${s.nombre}</td>
        <td>${s.tipo}</td>
        <td>${s.accion}</td>
        <td>${s.estados[s.estados.length-1].estado}</td>
        <td><button onclick="verDetalles('${doc.id}')">Ver detalles</button></td>
      </tr>`;
    });
  });
}

// VER DETALLES DE SOLICITUD Y CAMBIAR ESTADOS
function verDetalles(id){
  db.collection('solicitudes').doc(id).get().then(doc=>{
    if(doc.exists){
      const s = doc.data();
      let estadosHtml='';
      s.estados.forEach((e,index)=>{
        estadosHtml+=`Estado: ${e.estado}, Comentario: ${e.comentario || ''}, Fecha: ${new Date(e.fecha.seconds*1000 || e.fecha).toLocaleString()}\n`;
      });
      const nuevoEstado = prompt(`Detalles de solicitud:\nNombre: ${s.nombre}\nUsuario: ${s.usuario}\nGerencia: ${s.gerencia}\nDepartamento: ${s.departamento}\nMotivo: ${s.motivo}\nArchivo: ${s.archivo}\n\nHistorial de estados:\n${estadosHtml}\n\nIngrese nuevo estado si desea cambiar (Pendiente, Solicitud de reunión, Realizar consulta, Solicitud de 3 firmas, Solicitud de aprobación del gerente, Finalizado)`);
      if(nuevoEstado){
        const comentario = prompt('Ingrese comentario para este estado:');
        s.estados.push({estado:nuevoEstado, comentario:comentario, fecha:new Date()});
        db.collection('solicitudes').doc(id).set(s).then(()=>{ alert('Estado actualizado'); cargarSolicitudes(); });
      }
    }
  });
}

// Simulación getGerencia
function getGerencia(userId){ return ''; }
</script>
</head>
<body>
<header><h1>Sistema de Gestión</h1></header>

<div id="loginPanel" class="container">
  <div class="card" style="flex:1 1 400px;">
    <h2>Login</h2>
    <input id="loginUsuario" placeholder="Usuario">
    <input id="loginPassword" placeholder="Contraseña" type="password">
    <button onclick="login()">Ingresar</button>
  </div>
</div>

<div id="dashboard" style="display:none;">
  <div class="nav">
    <button id="usuariosTabBtn" onclick="mostrarTab('usuariosTab')">Usuarios</button>
    <button id="gerenciasTabBtn" onclick="mostrarTab('gerenciasTab')">Gerencias</button>
    <button id="departamentosTabBtn" onclick="mostrarTab('departamentosTab')">Departamentos</button>
    <button id="solicitudesTabBtn" onclick="mostrarTab('solicitudesTab')">Solicitudes</button>
  </div>

  <!-- USUARIOS -->
  <div id="usuariosTab" class="tab card">
    <h2>Usuarios</h2>
    <input id="nuevoUsuario" placeholder="Usuario">
    <input id="nuevaPassword" placeholder="Contraseña">
    <select id="nuevoRol">
      <option value="Usuario">Usuario</option>
      <option value="Gerente">Gerente</option>
      <option value="Admin">Admin</option>
    </select>
    <input id="nuevoGerencia" placeholder="Gerencia">
    <input id="nuevoDepartamento" placeholder="Departamento">
    <button onclick="crearUsuario()">Crear Usuario</button>
    <table><thead><tr><th>Usuario</th><th>Password</th><th>Rol</th><th>Gerencia</th><th>Departamento</th></tr></thead><tbody id="usuariosBody"></tbody></table>
  </div>

  <!-- GERENCIAS -->
  <div id="gerenciasTab" class="tab card">
    <h2>Gerencias</h2>
    <input id="nuevaGerenciaName" placeholder="Nombre Gerencia">
    <button onclick="crearGerencia()">Crear Gerencia</button>
    <table><tbody id="gerenciasBody"></tbody></table>
  </div>

  <!-- DEPARTAMENTOS -->
  <div id="departamentosTab" class="tab card">
    <h2>Departamentos</h2>
    <input id="nuevoDepartamentoName" placeholder="Nombre Departamento">
    <button onclick="crearDepartamento()">Crear Departamento</button>
    <table><tbody id="departamentosBody"></tbody></table>
  </div>

  <!-- SOLICITUDES -->
  <div id="solicitudesTab" class="tab card">
    <h2>Solicitudes</h2>
    <input id="solNombre" placeholder="Nombre Documento">
    <input id="solTipo" placeholder="Tipo (Procedimiento, Guía...)">
    <select id="solAccion">
      <option value="Creación">Creación</option>
      <option value="Modificación">Modificación</option>
      <option value="Inactivación">Inactivación</option>
    </select>
    <input id="solGerencia" placeholder="Gerencia">
    <input id="solDepartamento" placeholder="Departamento">
    <textarea id="solMotivo" placeholder="Motivo"></textarea>
    <input type="file" id="solArchivo">
    <button onclick="crearSolicitud()">Crear Solicitud</button>
    <table>
      <thead><tr><th>ID</th><th>Usuario</th><th>Nombre</th><th>Tipo</th><th>Acción</th><th>Estado</th><th>Detalle</th></tr></thead>
      <tbody id="solicitudesBody"></tbody>
    </table>
  </div>
</div>
</body>
</html>