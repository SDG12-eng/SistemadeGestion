<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>FCI | Sistema de Gesti贸n Documental</title>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

<style>
body { font-family: Arial; background:#f4f6f8; margin:0 }
header { background:#0a2540; color:white; padding:15px }
section { padding:20px }
.card { background:white; padding:15px; margin-bottom:15px; border-radius:6px }
.hidden { display:none }
button { padding:6px 10px; cursor:pointer }
input, select, textarea { width:100%; margin:5px 0; padding:6px }
table { width:100%; border-collapse:collapse }
th, td { border:1px solid #ccc; padding:6px }
th { background:#eee }
</style>
</head>

<body>

<header>
<h2> Sistema de Gesti贸n Documental FCI</h2>
<span id="usuarioActivo"></span>
</header>

<section id="login">
<div class="card">
<h3>Acceso</h3>
<input id="loginUser" placeholder="Usuario">
<input id="loginPass" type="password" placeholder="Contrase帽a">
<button onclick="login()">Ingresar</button>
<p id="loginError" style="color:red"></p>
</div>
</section>

<section id="dashboard" class="hidden">

<div class="card">
<button onclick="mostrar('solicitudes')">Solicitudes</button>
<button onclick="mostrar('usuarios')">Usuarios</button>
<button onclick="mostrar('gerencias')">Gerencias</button>
<button onclick="mostrar('departamentos')">Departamentos</button>
</div>

<!-- SOLICITUDES -->
<div id="solicitudes" class="card hidden">
<h3>Nueva Solicitud</h3>
<select id="tipoDoc">
<option>Procedimiento</option>
<option>Gu铆a</option>
<option>Instructivo</option>
<option>Manual</option>
<option>Formato</option>
</select>
<input id="nombreDoc" placeholder="Nombre del documento">
<select id="accion">
<option>Creaci贸n</option>
<option>Modificaci贸n</option>
<option>Inactivaci贸n</option>
</select>
<textarea id="motivo" placeholder="Motivo"></textarea>
<button onclick="crearSolicitud()">Crear Solicitud</button>

<h3>Solicitudes</h3>
<table>
<thead>
<tr><th>C贸digo</th><th>Documento</th><th>Estado</th></tr>
</thead>
<tbody id="tablaSolicitudes"></tbody>
</table>
</div>

<!-- USUARIOS -->
<div id="usuarios" class="card hidden">
<h3>Crear Usuario</h3>
<input id="uUsuario" placeholder="Usuario">
<input id="uPass" placeholder="Contrase帽a">
<input id="uCorreo" placeholder="Correo">
<select id="uRol">
<option value="usuario">Usuario</option>
<option value="gerente">Gerente</option>
<option value="admin">Admin</option>
</select>
<input id="uGerencia" placeholder="Gerencia">
<input id="uDepto" placeholder="Departamento">
<button onclick="crearUsuario()">Guardar</button>

<h3>Usuarios</h3>
<ul id="listaUsuarios"></ul>
</div>

<!-- GERENCIAS -->
<div id="gerencias" class="card hidden">
<h3>Gerencias</h3>
<input id="nGerencia" placeholder="Nueva gerencia">
<button onclick="addGerencia()">Agregar</button>
<ul id="listaGerencias"></ul>
</div>

<!-- DEPARTAMENTOS -->
<div id="departamentos" class="card hidden">
<h3>Departamentos</h3>
<input id="nDepto" placeholder="Departamento">
<input id="gDepto" placeholder="Gerencia">
<button onclick="addDepto()">Agregar</button>
<ul id="listaDeptos"></ul>
</div>

</section>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyDdzCiachuhbE9jATz-TesPI2vUVIJrHjM",
  authDomain: "sistemadegestion-7400d.firebaseapp.com",
  projectId: "sistemadegestion-7400d"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

let usuarioActual = null;

/* LOGIN */
async function login(){
  const u = loginUser.value;
  const p = loginPass.value;

  const q = await db.collection("usuarios")
    .where("usuario","==",u)
    .where("password","==",p)
    .get();

  if(q.empty){
    loginError.innerText = "Credenciales inv谩lidas";
    return;
  }

  usuarioActual = q.docs[0].data();
  usuarioActivo.innerText = "Usuario: " + usuarioActual.usuario;
  login.classList.add("hidden");
  dashboard.classList.remove("hidden");

  cargarUsuarios();
  cargarSolicitudes();
  cargarGerencias();
  cargarDeptos();
}

/* VISTAS */
function mostrar(id){
  ["solicitudes","usuarios","gerencias","departamentos"].forEach(d=>{
    document.getElementById(d).classList.add("hidden");
  });
  document.getElementById(id).classList.remove("hidden");
}

/* USUARIOS */
async function crearUsuario(){
  await db.collection("usuarios").add({
    usuario: uUsuario.value,
    password: uPass.value,
    correo: uCorreo.value,
    rol: uRol.value,
    gerencia: uGerencia.value,
    departamento: uDepto.value
  });
  cargarUsuarios();
}

async function cargarUsuarios(){
  listaUsuarios.innerHTML="";
  const q = await db.collection("usuarios").get();
  q.forEach(d=>{
    listaUsuarios.innerHTML += `<li>${d.data().usuario} (${d.data().rol})</li>`;
  });
}

/* SOLICITUDES */
async function crearSolicitud(){
  const num = Date.now();
  await db.collection("solicitudes").add({
    codigo: "FCI-SOL-" + num,
    solicitante: usuarioActual.usuario,
    correo: usuarioActual.correo,
    gerencia: usuarioActual.gerencia,
    departamento: usuarioActual.departamento,
    tipo: tipoDoc.value,
    documento: nombreDoc.value,
    accion: accion.value,
    motivo: motivo.value,
    estado: "Pendiente"
  });
  cargarSolicitudes();
}

async function cargarSolicitudes(){
  tablaSolicitudes.innerHTML="";
  let q;

  if(usuarioActual.rol === "admin"){
    q = await db.collection("solicitudes").get();
  }else if(usuarioActual.rol === "gerente"){
    q = await db.collection("solicitudes")
      .where("gerencia","==",usuarioActual.gerencia).get();
  }else{
    q = await db.collection("solicitudes")
      .where("solicitante","==",usuarioActual.usuario).get();
  }

  q.forEach(d=>{
    const s = d.data();
    tablaSolicitudes.innerHTML += `
      <tr>
        <td>${s.codigo}</td>
        <td>${s.documento}</td>
        <td>${s.estado}</td>
      </tr>`;
  });
}

/* GERENCIAS */
async function addGerencia(){
  await db.collection("gerencias").add({ nombre:nGerencia.value });
  cargarGerencias();
}
async function cargarGerencias(){
  listaGerencias.innerHTML="";
  const q = await db.collection("gerencias").get();
  q.forEach(d=>listaGerencias.innerHTML+=`<li>${d.data().nombre}</li>`);
}

/* DEPARTAMENTOS */
async function addDepto(){
  await db.collection("departamentos").add({
    nombre:nDepto.value,
    gerencia:gDepto.value
  });
  cargarDeptos();
}
async function cargarDeptos(){
  listaDeptos.innerHTML="";
  const q = await db.collection("departamentos").get();
  q.forEach(d=>listaDeptos.innerHTML+=`<li>${d.data().nombre}</li>`);
}
</script>
</body>
</html>