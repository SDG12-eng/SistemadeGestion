<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Sistema de Gestión Documental FCI</title>

<!-- Firebase -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getFirestore, collection, addDoc, getDocs, doc, setDoc, updateDoc, query, orderBy
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

window.firebaseApp = initializeApp({
  apiKey: "AIzaSyDdzCiachuhbE9jATz-TesPI2vUVIJrHjM",
  authDomain: "sistemadegestion-7400d.firebaseapp.com",
  projectId: "sistemadegestion-7400d",
  storageBucket: "sistemadegestion-7400d.firebasestorage.app",
  messagingSenderId: "709030283072",
  appId: "1:709030283072:web:5997837b36a448e9515ca5"
});

window.db = getFirestore(firebaseApp);
</script>

<style>
body { font-family: Arial; background:#f4f6f8; margin:0 }
header { background:#0a3d62; color:#fff; padding:15px }
nav button { margin:5px }
section { display:none; padding:20px }
section.active { display:block }
.card { background:#fff; padding:15px; margin-bottom:15px; border-radius:5px }
input, select, textarea { width:100%; margin-bottom:8px }
table { width:100%; border-collapse:collapse }
th, td { border:1px solid #ccc; padding:6px }
</style>
</head>

<body>

<header>
<h2>Sistema de Gestión Documental – FCI</h2>
Usuario activo:
<select id="usuarioActivo"></select>
</header>

<nav>
<button onclick="mostrar('dashboard')">Dashboard</button>
<button onclick="mostrar('usuarios')">Usuarios</button>
<button onclick="mostrar('solicitudes')">Solicitudes</button>
<button onclick="mostrar('crearSolicitud')">Nueva Solicitud</button>
</nav>

<!-- DASHBOARD -->
<section id="dashboard" class="active">
<div class="card">
<h3>Bienvenido</h3>
<p>Sistema sin Auth – Controlado por roles internos</p>
</div>
</section>

<!-- USUARIOS -->
<section id="usuarios">
<div class="card">
<h3>Crear Usuario</h3>
<input id="u_usuario" placeholder="Usuario">
<input id="u_correo" placeholder="Correo">
<select id="u_rol">
<option>admin</option>
<option>gerente</option>
<option>usuario</option>
</select>

<label>Permisos</label>
<label><input type="checkbox" value="crear_solicitud"> Crear solicitudes</label><br>
<label><input type="checkbox" value="ver_propias"> Ver propias</label><br>
<label><input type="checkbox" value="ver_gerencia"> Ver gerencia</label><br>
<label><input type="checkbox" value="aprobar"> Aprobar/Rechazar</label><br>
<label><input type="checkbox" value="gestionar"> Gestionar usuarios</label><br>

<button onclick="crearUsuario()">Guardar</button>
</div>

<div class="card">
<h3>Usuarios</h3>
<table id="tablaUsuarios"></table>
</div>
</section>

<!-- SOLICITUDES -->
<section id="solicitudes">
<div class="card">
<h3>Solicitudes</h3>
<table id="tablaSolicitudes"></table>
</div>
</section>

<!-- CREAR SOLICITUD -->
<section id="crearSolicitud">
<div class="card">
<h3>Nueva Solicitud</h3>
<input id="doc_nombre" placeholder="Nombre del documento">
<select id="doc_tipo">
<option>Procedimiento</option>
<option>Guía</option>
<option>Instructivo</option>
<option>Manual</option>
<option>Formato</option>
</select>

<select id="accion">
<option>Creación</option>
<option>Modificación</option>
<option>Inactivación</option>
</select>

<input id="gerencia" placeholder="Gerencia">
<input id="departamento" placeholder="Departamento">
<textarea id="motivo" placeholder="Motivo"></textarea>

<input type="file" id="archivo">

<button onclick="crearSolicitud()">Enviar Solicitud</button>
</div>
</section>

<script>
let usuarioActual = "Admin";

async function cargarUsuarios() {
  const snap = await getDocs(collection(db, "usuarios"));
  const sel = document.getElementById("usuarioActivo");
  sel.innerHTML = "";
  snap.forEach(d => {
    sel.innerHTML += `<option>${d.data().usuario}</option>`;
  });
  sel.onchange = e => usuarioActual = e.target.value;
}

async function crearUsuario() {
  const permisos = [...document.querySelectorAll("#usuarios input[type=checkbox]:checked")].map(c=>c.value);
  await addDoc(collection(db,"usuarios"),{
    usuario: u_usuario.value,
    correo: u_correo.value,
    rol: u_rol.value,
    permisos
  });
  alert("Usuario creado");
  cargarUsuarios();
  listarUsuarios();
}

async function listarUsuarios() {
  const snap = await getDocs(collection(db,"usuarios"));
  const t = document.getElementById("tablaUsuarios");
  t.innerHTML="<tr><th>Usuario</th><th>Rol</th><th>Permisos</th></tr>";
  snap.forEach(d=>{
    const u=d.data();
    t.innerHTML+=`<tr><td>${u.usuario}</td><td>${u.rol}</td><td>${u.permisos.join(", ")}</td></tr>`;
  });
}

async function crearSolicitud() {
  const snap = await getDocs(collection(db,"solicitudes"));
  const codigo = "FCI-SOL-" + String(snap.size+1).padStart(4,"0");

  let archivoURL = "";
  const f = archivo.files[0];
  if(f){
    const fd = new FormData();
    fd.append("file",f);
    fd.append("upload_preset","fci_documentos");
    const r = await fetch("https://api.cloudinary.com/v1_1/df79cjklp/auto/upload",{method:"POST",body:fd});
    archivoURL = (await r.json()).secure_url;
  }

  await setDoc(doc(db,"solicitudes",codigo),{
    codigo,
    usuario: usuarioActual,
    nombre: doc_nombre.value,
    tipo: doc_tipo.value,
    accion: accion.value,
    gerencia: gerencia.value,
    departamento: departamento.value,
    motivo: motivo.value,
    estado: "Pendiente",
    archivo: archivoURL,
    fecha: new Date().toISOString()
  });

  alert("Solicitud creada");
  listarSolicitudes();
}

async function listarSolicitudes() {
  const snap = await getDocs(query(collection(db,"solicitudes"),orderBy("fecha","desc")));
  const t = document.getElementById("tablaSolicitudes");
  t.innerHTML="<tr><th>Código</th><th>Documento</th><th>Estado</th><th>Usuario</th></tr>";
  snap.forEach(d=>{
    const s=d.data();
    t.innerHTML+=`<tr>
      <td>${s.codigo}</td>
      <td>${s.nombre}</td>
      <td>${s.estado}</td>
      <td>${s.usuario}</td>
    </tr>`;
  });
}

function mostrar(id){
  document.querySelectorAll("section").forEach(s=>s.classList.remove("active"));
  document.getElementById(id).classList.add("active");
}

cargarUsuarios();
listarUsuarios();
listarSolicitudes();
</script>

</body>
</html>