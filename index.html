<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>FCI | Sistema de Gesti√≥n Documental</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

<!-- Cloudinary -->
<script src="https://widget.cloudinary.com/v2.0/global/all.js"></script>

<style>
body{
    margin:0;
    font-family: Arial, sans-serif;
    background:#f4f6f8;
}
header{
    background:#1e293b;
    color:white;
    padding:15px;
    font-size:18px;
}
.container{
    padding:20px;
}
.section{
    background:white;
    padding:15px;
    border-radius:8px;
    margin-bottom:20px;
}
h2{
    margin-top:0;
}
input, select, textarea, button{
    width:100%;
    padding:8px;
    margin-top:5px;
    margin-bottom:10px;
}
button{
    background:#2563eb;
    color:white;
    border:none;
    cursor:pointer;
}
button:hover{
    opacity:0.9;
}
table{
    width:100%;
    border-collapse:collapse;
}
th, td{
    border:1px solid #ddd;
    padding:8px;
}
th{
    background:#e5e7eb;
}
.estado{
    font-weight:bold;
}
.detalle-box{
    background:#f1f5f9;
    padding:10px;
    margin-top:10px;
    border-radius:5px;
}
.hidden{
    display:none;
}
</style>
</head>

<body>
<header>
Sistema de Gesti√≥n Documental ‚Äì Fashion Consult International
</header>

<div class="container">

<!-- USUARIOS -->
<div class="section">
<h2>üë§ Crear Usuario</h2>
<input id="u_usuario" placeholder="Usuario">
<input id="u_password" placeholder="Contrase√±a">
<input id="u_correo" placeholder="Correo">
<select id="u_rol">
    <option>Admin</option>
    <option>Gerente</option>
    <option>Usuario</option>
</select>
<input id="u_gerencia" placeholder="Gerencia">
<input id="u_departamento" placeholder="Departamento">

<label><input type="checkbox" id="p_crear"> Puede crear solicitudes</label>
<label><input type="checkbox" id="p_ver"> Puede ver solicitudes</label>
<label><input type="checkbox" id="p_aprobar"> Puede aprobar</label>
<label><input type="checkbox" id="p_usuarios"> Gestionar usuarios</label>

<button onclick="crearUsuario()">Guardar Usuario</button>
</div>

<!-- SOLICITUD -->
<div class="section">
<h2>üìÑ Nueva Solicitud</h2>

<input id="s_nombre" placeholder="Nombre del documento">
<select id="s_tipo">
    <option>Procedimiento</option>
    <option>Instructivo</option>
    <option>Formato</option>
</select>

<select id="s_accion" onchange="accionChange()">
    <option value="crear">Crear</option>
    <option value="modificar">Modificar</option>
    <option value="inactivar">Inactivar</option>
</select>

<div id="modBox" class="hidden">
<input id="s_version" placeholder="√öltima versi√≥n">
<input id="s_codigo" placeholder="C√≥digo anterior">
</div>

<input id="s_gerencia" placeholder="Gerencia">
<input id="s_departamento" placeholder="Departamento">
<textarea id="s_motivo" placeholder="Motivo"></textarea>

<button onclick="crearSolicitud()">Enviar Solicitud</button>
</div>

<!-- LISTADO -->
<div class="section">
<h2>üìã Solicitudes</h2>
<table>
<thead>
<tr>
<th>C√≥digo</th>
<th>Documento</th>
<th>Gerencia</th>
<th>Estado</th>
<th>Acci√≥n</th>
</tr>
</thead>
<tbody id="tablaSolicitudes"></tbody>
</table>
</div>

<!-- DETALLE -->
<div class="section hidden" id="detalle">
<h2>üîç Detalle Solicitud</h2>
<div id="detalleContenido"></div>

<select id="nuevoEstado" onchange="estadoChange()">
<option>Pendiente</option>
<option>Solicitud de reuni√≥n</option>
<option>Consulta</option>
<option>Firma Documentado</option>
<option>Firma Verificado</option>
<option>Firma Codificado</option>
<option>Solicitud aprobaci√≥n gerente</option>
<option>Aprobado por gerente</option>
<option>Rechazado por gerente</option>
<option>Finalizado</option>
</select>

<div id="estadoExtra"></div>

<button onclick="actualizarEstado()">Actualizar Estado</button>
</div>

</div>

<script>
/* ===============================
   FIREBASE CONFIG (TU PROYECTO)
================================ */
const firebaseConfig = {
    apiKey: "TU_API_KEY",
    authDomain: "TU_PROYECTO.firebaseapp.com",
    projectId: "TU_PROYECTO",
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

/* ===============================
   UTILIDADES
================================ */
function generarCodigo(){
    return "DOC-" + Date.now();
}

function accionChange(){
    const accion = document.getElementById("s_accion").value;
    document.getElementById("modBox").classList.toggle("hidden", accion === "crear");
}

/* ===============================
   CREAR USUARIO
================================ */
function crearUsuario(){
    const data = {
        usuario: u_usuario.value,
        password: u_password.value,
        correo: u_correo.value,
        rol: u_rol.value,
        gerencia: u_gerencia.value,
        departamento: u_departamento.value,
        permisos:{
            crear: p_crear.checked,
            ver: p_ver.checked,
            aprobar: p_aprobar.checked,
            usuarios: p_usuarios.checked
        },
        creado: new Date()
    };

    if(!data.usuario || !data.password){
        alert("Usuario y contrase√±a requeridos");
        return;
    }

    db.collection("usuarios").doc(data.usuario).set(data)
    .then(()=>{
        alert("Usuario creado correctamente");
        document.querySelectorAll("input").forEach(i=>i.value="");
    });
}

/* ===============================
   CREAR SOLICITUD
================================ */
function crearSolicitud(){
    const codigo = generarCodigo();
    const data = {
        codigo,
        nombre: s_nombre.value,
        tipo: s_tipo.value,
        accion: s_accion.value,
        versionAnterior: s_version.value || "",
        codigoAnterior: s_codigo.value || "",
        gerencia: s_gerencia.value,
        departamento: s_departamento.value,
        motivo: s_motivo.value,
        estado: "Pendiente",
        fecha: new Date(),
        historial:[
            {
                estado:"Pendiente",
                fecha:new Date(),
                comentario:"Solicitud creada"
            }
        ],
        adjuntos:[]
    };

    db.collection("solicitudes").doc(codigo).set(data)
    .then(()=>{
        alert("Solicitud enviada");
        cargarSolicitudes();
        document.querySelectorAll("input, textarea").forEach(i=>i.value="");
    });
}

/* ===============================
   LISTAR SOLICITUDES
================================ */
function cargarSolicitudes(){
    tablaSolicitudes.innerHTML="";
    db.collection("solicitudes").orderBy("fecha","desc").onSnapshot(snap=>{
        tablaSolicitudes.innerHTML="";
        snap.forEach(doc=>{
            const d = doc.data();
            tablaSolicitudes.innerHTML += `
            <tr>
                <td>${d.codigo}</td>
                <td>${d.nombre}</td>
                <td>${d.gerencia}</td>
                <td class="estado">${d.estado}</td>
                <td><button onclick="verDetalle('${d.codigo}')">Ver</button></td>
            </tr>`;
        });
    });
}
cargarSolicitudes();
</script>


<script>
/* ===============================
   VARIABLES GLOBALES
================================ */
let solicitudActual = null;

/* ===============================
   VER DETALLE SOLICITUD
================================ */
function verDetalle(codigo){
    db.collection("solicitudes").doc(codigo).get().then(doc=>{
        if(!doc.exists) return;
        solicitudActual = codigo;
        const d = doc.data();

        document.getElementById("detalleBox").classList.remove("hidden");

        det_codigo.innerText = d.codigo;
        det_nombre.innerText = d.nombre;
        det_tipo.innerText = d.tipo;
        det_accion.innerText = d.accion;
        det_gerencia.innerText = d.gerencia;
        det_departamento.innerText = d.departamento;
        det_estado.innerText = d.estado;
        det_motivo.innerText = d.motivo;

        /* HISTORIAL */
        historialBox.innerHTML="";
        d.historial.forEach(h=>{
            historialBox.innerHTML+=`
            <div style="border-left:3px solid #0a2a66;padding:5px;margin:5px">
                <b>${h.estado}</b><br>
                ${h.comentario || ""}<br>
                <small>${new Date(h.fecha.seconds*1000).toLocaleString()}</small>
            </div>`;
        });

        /* ADJUNTOS */
        adjuntosBox.innerHTML="";
        if(d.adjuntos){
            d.adjuntos.forEach(a=>{
                adjuntosBox.innerHTML+=`
                <a href="${a.url}" target="_blank">üìé ${a.nombre}</a><br>`;
            });
        }
    });
}

/* ===============================
   CAMBIAR ESTADO
================================ */
function cambiarEstado(){
    const nuevo = estadoNuevo.value;
    const comentario = estadoComentario.value;

    if(!solicitudActual || !nuevo) return;

    const ref = db.collection("solicitudes").doc(solicitudActual);

    ref.update({
        estado: nuevo,
        historial: firebase.firestore.FieldValue.arrayUnion({
            estado:nuevo,
            comentario,
            fecha:new Date()
        })
    }).then(()=>{
        alert("Estado actualizado");
        estadoComentario.value="";
        verDetalle(solicitudActual);
        cargarSolicitudes();
    });
}

/* ===============================
   SUBIR DOCUMENTO (CLOUDINARY)
================================ */
function subirDocumento(){
    const file = archivoAdjunto.files[0];
    if(!file || !solicitudActual) return;

    const formData = new FormData();
    formData.append("file", file);
    formData.append("upload_preset", "TU_UPLOAD_PRESET");

    fetch("https://api.cloudinary.com/v1_1/TU_CLOUD_NAME/auto/upload",{
        method:"POST",
        body:formData
    })
    .then(r=>r.json())
    .then(data=>{
        return db.collection("solicitudes").doc(solicitudActual).update({
            adjuntos: firebase.firestore.FieldValue.arrayUnion({
                nombre:file.name,
                url:data.secure_url
            })
        });
    })
    .then(()=>{
        alert("Documento adjuntado");
        verDetalle(solicitudActual);
    });
}
</script>

<!-- ===============================
     DETALLE SOLICITUD UI
================================ -->
<div id="detalleBox" class="hidden card">
    <h2>Detalle de Solicitud</h2>

    <p><b>C√≥digo:</b> <span id="det_codigo"></span></p>
    <p><b>Nombre:</b> <span id="det_nombre"></span></p>
    <p><b>Tipo:</b> <span id="det_tipo"></span></p>
    <p><b>Acci√≥n:</b> <span id="det_accion"></span></p>
    <p><b>Gerencia:</b> <span id="det_gerencia"></span></p>
    <p><b>Departamento:</b> <span id="det_departamento"></span></p>
    <p><b>Estado actual:</b> <span id="det_estado"></span></p>
    <p><b>Motivo:</b> <span id="det_motivo"></span></p>

    <h3>Historial</h3>
    <div id="historialBox"></div>

    <h3>Adjuntar documento</h3>
    <input type="file" id="archivoAdjunto">
    <button onclick="subirDocumento()">Subir</button>
    <div id="adjuntosBox"></div>

    <h3>Cambiar estado</h3>
    <select id="estadoNuevo">
        <option value="">-- Seleccionar --</option>
        <option>Pendiente</option>
        <option>Solicitud de reuni√≥n</option>
        <option>Consulta</option>
        <option>Firma documentado</option>
        <option>Firma verificado</option>
        <option>Firma codificado</option>
        <option>Aprobaci√≥n gerente</option>
        <option>Finalizado</option>
    </select>

    <textarea id="estadoComentario" placeholder="Comentario"></textarea>
    <button onclick="cambiarEstado()">Actualizar estado</button>
</div>


<style>
.tabs { display:flex; gap:10px; margin-bottom:10px }
.tab-btn { padding:10px; background:#0a2a66; color:white; border:none; cursor:pointer }
.tab { display:none }
.tab.active { display:block }
.card { background:#fff; padding:15px; border-radius:8px; margin-bottom:15px }
table { width:100%; border-collapse:collapse }
td,th { border:1px solid #ccc; padding:5px }
.hidden{display:none}
</style>

<div class="tabs">
    <button class="tab-btn" onclick="abrirTab('usuariosTab')">Usuarios</button>
    <button class="tab-btn" onclick="abrirTab('gerenciasTab')">Gerencias</button>
    <button class="tab-btn" onclick="abrirTab('deptosTab')">Departamentos</button>
    <button class="tab-btn" onclick="abrirTab('solicitudesTab')">Solicitudes</button>
</div>

<script>
function abrirTab(id){
    document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
    document.getElementById(id).classList.add('active');
}
</script>


<div id="usuariosTab" class="tab active card">
    <h2>Usuarios</h2>

    <input id="u_usuario" placeholder="Usuario">
    <input id="u_pass" placeholder="Contrase√±a">
    <input id="u_correo" placeholder="Correo">
    <select id="u_rol">
        <option>usuario</option>
        <option>gerente</option>
        <option>admin</option>
    </select>
    <select id="u_gerencia"></select>
    <select id="u_departamento"></select>

    <h4>Permisos</h4>
    <label><input type="checkbox" id="p_solicitar"> Realizar solicitudes</label><br>
    <label><input type="checkbox" id="p_verpropias"> Ver solicitudes propias</label><br>
    <label><input type="checkbox" id="p_vergerencia"> Ver solicitudes gerencia</label><br>
    <label><input type="checkbox" id="p_aprobar"> Aprobar/Rechazar</label><br>
    <label><input type="checkbox" id="p_users"> Gestionar usuarios</label><br>

    <button onclick="crearUsuario()">Crear usuario</button>

    <h3>Listado</h3>
    <table>
        <thead>
            <tr><th>Usuario</th><th>Rol</th><th>Gerencia</th><th>Acciones</th></tr>
        </thead>
        <tbody id="usuariosTabla"></tbody>
    </table>
</div>



<script>
function crearUsuario(){
    const data={
        usuario:u_usuario.value,
        password:u_pass.value,
        correo:u_correo.value,
        rol:u_rol.value,
        gerencia:u_gerencia.value,
        departamento:u_departamento.value,
        permisos:{
            solicitar:p_solicitar.checked,
            verPropias:p_verpropias.checked,
            verGerencia:p_vergerencia.checked,
            aprobar:p_aprobar.checked,
            users:p_users.checked
        }
    };
    db.collection("usuarios").doc(data.usuario).set(data).then(()=>{
        alert("Usuario creado");
        cargarUsuarios();
    });
}

function cargarUsuarios(){
    usuariosTabla.innerHTML="";
    db.collection("usuarios").get().then(q=>{
        q.forEach(d=>{
            const u=d.data();
            usuariosTabla.innerHTML+=`
            <tr>
                <td>${u.usuario}</td>
                <td>${u.rol}</td>
                <td>${u.gerencia}</td>
                <td>
                    <button onclick="eliminarUsuario('${d.id}')">Eliminar</button>
                </td>
            </tr>`;
        });
    });
}

function eliminarUsuario(id){
    if(confirm("Eliminar usuario?")){
        db.collection("usuarios").doc(id).delete().then(cargarUsuarios);
    }
}
</script>


<div id="gerenciasTab" class="tab card">
    <h2>Gerencias</h2>
    <input id="g_nombre" placeholder="Nombre">
    <button onclick="crearGerencia()">Agregar</button>
    <ul id="gerenciasLista"></ul>
</div>

<script>
function crearGerencia(){
    db.collection("gerencias").add({nombre:g_nombre.value}).then(cargarGerencias);
}
function cargarGerencias(){
    gerenciasLista.innerHTML="";
    u_gerencia.innerHTML="";
    db.collection("gerencias").get().then(q=>{
        q.forEach(d=>{
            gerenciasLista.innerHTML+=`<li>${d.data().nombre}</li>`;
            u_gerencia.innerHTML+=`<option>${d.data().nombre}</option>`;
        });
    });
}
</script>

<div id="deptosTab" class="tab card">
    <h2>Departamentos</h2>
    <input id="d_nombre" placeholder="Nombre">
    <button onclick="crearDepto()">Agregar</button>
    <ul id="deptosLista"></ul>
</div>

<script>
function crearDepto(){
    db.collection("departamentos").add({nombre:d_nombre.value}).then(cargarDeptos);
}
function cargarDeptos(){
    deptosLista.innerHTML="";
    u_departamento.innerHTML="";
    db.collection("departamentos").get().then(q=>{
        q.forEach(d=>{
            deptosLista.innerHTML+=`<li>${d.data().nombre}</li>`;
            u_departamento.innerHTML+=`<option>${d.data().nombre}</option>`;
        });
    });
}
</script>

<script>
cargarUsuarios();
cargarGerencias();
cargarDeptos();
</script>
