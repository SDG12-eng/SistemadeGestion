<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SGC PRO - Sistema de Gestión Integrado</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
    
    <style>
        :root {
            --primary: #1e40af; --accent: #3b82f6; --bg: #f0f2f5;
            --success: #059669; --warning: #d97706; --danger: #dc2626;
            --info: #0891b2; --white: #ffffff; --border: #e2e8f0; --sidebar: #0f172a;
            --text-dark: #1e293b; --text-light: #64748b;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Inter', sans-serif; }
        body { background: var(--bg); color: var(--text-dark); height: 100vh; display: flex; overflow: hidden; }

        /* Login */
        #login-screen { position: fixed; inset: 0; background: var(--sidebar); display: flex; align-items: center; justify-content: center; z-index: 5000; }
        .login-box { background: var(--white); padding: 40px; border-radius: 24px; max-width: 400px; width: 90%; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5); text-align: center; }

        /* Layout Principal */
        .sidebar-overlay { display: none; position: fixed; inset: 0; background: rgba(15, 23, 42, 0.7); z-index: 8000; backdrop-filter: blur(3px); opacity: 0; transition: opacity 0.3s ease; }
        .sidebar-overlay.active { display: block; opacity: 1; }

        .sidebar { width: 280px; background: var(--sidebar); color: white; display: none; flex-direction: column; padding: 20px; border-right: 1px solid rgba(255,255,255,0.05); transition: all 0.3s ease; }
        .main { flex: 1; padding: 30px; overflow-y: auto; display: none; background: var(--bg); }

        /* Navegación */
        .nav-link { 
            display: none; align-items: center; padding: 12px 15px; color: #94a3b8; border: none; 
            background: none; cursor: pointer; width: 100%; border-radius: 10px; margin-bottom: 5px; transition: 0.2s; font-size: 14px; text-align: left; font-weight: 500;
        }
        .nav-link.visible { display: flex; }
        .nav-link:hover { background: rgba(255,255,255,0.08); color: white; }
        .nav-link.active { background: var(--accent); color: white; font-weight: 600; box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3); }
        .nav-link span { margin-right: 12px; }

        /* Secciones y Animaciones */
        .section { display: none; animation: fadeIn 0.3s ease-out; }
        .section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* UI Elements Genéricos */
        .card { background: white; padding: 25px; border-radius: 16px; border: 1px solid var(--border); margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.02); transition: transform 0.2s, box-shadow 0.2s; }
        /* .card:hover { box-shadow: 0 10px 15px -3px rgba(0,0,0,0.05); } */
        
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; }
        .grid-4 { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; }
        
        label { font-size: 11px; font-weight: 700; color: var(--text-light); text-transform: uppercase; margin-bottom: 6px; display: block; letter-spacing: 0.5px; }
        input, select, textarea { width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 10px; margin-bottom: 15px; font-size: 14px; background: #fff; color: inherit; outline:none; transition: 0.2s; }
        input:focus, select:focus, textarea:focus { border-color: var(--accent); box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); }
        
        .btn { padding: 12px 20px; border-radius: 10px; border: none; font-weight: 700; cursor: pointer; display: inline-flex; align-items: center; justify-content: center; gap: 8px; transition: 0.2s; font-size: 13px; }
        .btn-primary { background: var(--primary); color: white; } .btn-success { background: var(--success); color: white; }
        .btn-warning { background: var(--warning); color: white; } .btn-danger { background: var(--danger); color: white; }
        .btn-info { background: var(--info); color: white; } .btn-ghost { background: #f1f5f9; color: var(--text-light); }
        .btn:hover { filter: brightness(1.1); transform: translateY(-1px); }

        /* Tablas */
        .table-container { background: white; border-radius: 16px; border: 1px solid var(--border); overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.02); }
        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; padding: 15px 20px; background: #f8fafc; border-bottom: 2px solid var(--border); font-size: 11px; color: var(--text-light); text-transform: uppercase; white-space: nowrap; font-weight: 700; }
        td { padding: 15px 20px; border-bottom: 1px solid var(--border); font-size: 13px; vertical-align: middle; }
        tr:hover td { background: #fcfcfc; }
        .table-responsive { overflow-x: auto; width: 100%; }

        /* Badges y Estados */
        .badge { padding: 4px 10px; border-radius: 20px; font-size: 10px; font-weight: 800; text-transform: uppercase; white-space: nowrap; letter-spacing: 0.3px; }
        .badge-info { background: #e0f2fe; color: #0369a1; } .badge-success { background: #dcfce7; color: #15803d; }
        .badge-warning { background: #fef3c7; color: #92400e; } .badge-danger { background: #fee2e2; color: #991b1b; }

        /* Dashboard Cards V2 */
        .dash-card { cursor: pointer; transition: all 0.2s ease; border-left: 4px solid transparent; }
        .dash-card:hover { transform: translateY(-3px); box-shadow: 0 10px 20px -5px rgba(0,0,0,0.1); }
        .dash-card h2 { font-size: 28px; margin: 5px 0 0; font-weight: 800; }
        .dash-icon { float: right; opacity: 0.2; font-size: 40px; margin-top: -10px; }

        /* Quill Editor Personalización */
        .ql-toolbar.ql-snow { border-top-left-radius: 10px; border-top-right-radius: 10px; border-color: var(--border); background: #f8fafc; }
        .ql-container.ql-snow { border-bottom-left-radius: 10px; border-bottom-right-radius: 10px; border-color: var(--border); background: white; font-family: 'Inter', sans-serif; font-size: 14px; }
        .quill-wrapper { margin-bottom: 15px; }

        /* Modal Mejorado */
        .modal-overlay { position: fixed; inset: 0; background: rgba(15, 23, 42, 0.85); display: none; align-items: center; justify-content: center; z-index: 4000; backdrop-filter: blur(4px); padding: 20px; }
        .modal-content { background: white; width: 100%; max-width: 1280px; height: 95vh; border-radius: 24px; display: grid; grid-template-columns: 1fr 400px; overflow: hidden; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25); }
        .modal-main { padding: 30px; overflow-y: auto; background: #fff; }
        .modal-side { background: #f8fafc; border-left: 1px solid var(--border); display: flex; flex-direction: column; height: 100%; }
        
        #chat-box { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 15px; }
        .chat-msg { padding: 15px; background: white; border-radius: 12px; border: 1px solid var(--border); box-shadow: 0 2px 4px rgba(0,0,0,0.02); font-size: 13px; position: relative; }
        .chat-msg b { color: var(--primary); }
        /* Estilos para el contenido HTML dentro del chat */
        .chat-msg ul, .chat-msg ol { padding-left: 20px; margin-top: 5px; }
        .chat-msg p { margin-bottom: 5px; }

        /* Steps Visuales */
        .step-container { display: flex; justify-content: space-between; margin: 25px 0 35px; position: relative; padding: 0 20px; }
        .step-container::before { content: ''; position: absolute; top: 15px; left: 30px; right: 30px; height: 3px; background: #e2e8f0; z-index: 1; }
        .step { position: relative; z-index: 2; text-align: center; flex: 1; display: flex; flex-direction: column; align-items: center; }
        .step-dot { width: 32px; height: 32px; background: white; border: 4px solid #e2e8f0; border-radius: 50%; margin-bottom: 8px; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 800; color: var(--text-light); transition: 0.3s; }
        .step.active .step-dot { border-color: var(--primary); background: var(--primary); color: white; box-shadow: 0 0 0 4px rgba(30, 64, 175, 0.2); }
        .step.done .step-dot { border-color: var(--success); background: var(--success); color: white; }
        .step label { font-size: 10px; color: var(--text-light); font-weight: 600; max-width: 120px; }
        .step.active label { color: var(--primary); font-weight: 800; }
        
        /* Utilidades */
        .search-bar { background: white; border: 1px solid var(--border); border-radius: 10px; padding: 12px 20px; width: 100%; max-width: 400px; font-size: 14px; outline: none; transition: 0.2s; }
        .search-bar:focus { border-color: var(--accent); box-shadow: 0 4px 12px rgba(59, 130, 246, 0.1); }
        .locked-data { opacity: 0.6; pointer-events: none; filter: grayscale(1); }

        /* Loading & Notificaciones */
        #loading-overlay { position: fixed; inset: 0; background: rgba(255,255,255,0.95); z-index: 6000; display: none; align-items: center; justify-content: center; flex-direction: column; backdrop-filter: blur(5px); }
        .spinner { width: 50px; height: 50px; border: 4px solid rgba(30, 64, 175, 0.1); border-top: 4px solid var(--primary); border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Responsive */
        @media (max-width: 1024px) {
            .grid-3, .grid-4 { grid-template-columns: repeat(2, 1fr); }
            .modal-content { grid-template-columns: 1fr; height: 100vh; max-height: none; border-radius: 0; }
            .modal-side { border-left: none; border-top: 1px solid var(--border); height: 400px; flex: none; }
        }
        @media (max-width: 768px) {
            body { flex-direction: column; overflow-y: auto; }
            .sidebar { position: fixed; left: -300px; top: 0; bottom: 0; z-index: 9000; box-shadow: 10px 0 25px rgba(0,0,0,0.1); }
            .sidebar.open { left: 0; }
            .mobile-header { display: flex; padding: 15px 20px; background: white; border-bottom: 1px solid var(--border); align-items: center; justify-content: space-between; }
            .main { padding: 20px; }
            .grid-2, .grid-3, .grid-4 { grid-template-columns: 1fr; }
            .dash-card h2 { font-size: 24px; }
            .step label { font-size: 8px; } .step-dot { width: 24px; height: 24px; font-size: 10px; border-width: 3px; } .step-container::before { top: 12px; left: 15px; right: 15px; }
        }
    </style>
</head>
<body>

    <div id="loading-overlay">
        <div class="spinner" style="margin-bottom: 20px;"></div>
        <h3 style="color:var(--primary); font-weight: 800;">Procesando...</h3>
        <p style="color:var(--text-light); font-size:13px;">Por favor espere.</p>
    </div>

    <div class="sidebar-overlay" id="sidebar-overlay" onclick="toggleMenu()"></div>

    <div id="login-screen">
        <div class="login-box">
            <div style="display:flex; justify-content:center; margin-bottom:15px;">
                <span class="material-icons-round" style="font-size: 50px; color: var(--primary);">verified_user</span>
            </div>
            <h1 style="color:var(--primary); margin-bottom: 10px; font-weight: 800; font-size: 24px;">SGC PRO V7</h1>
            <p style="color:var(--text-light); font-size:14px; margin-bottom:30px;">Sistema de Gestión de Calidad Integrado</p>
            <div style="text-align: left;">
                <label>Usuario</label>
                <input type="text" id="login-user" placeholder="Ej: admin.sgc">
                <label>Contraseña</label>
                <input type="password" id="login-pass" placeholder="••••••">
            </div>
            <button class="btn btn-primary" id="btnLogin" style="width: 100%; padding: 15px; margin-top: 10px; font-size: 14px;">INICIAR SESIÓN SEGURO</button>
        </div>
    </div>

    <aside class="sidebar" id="sidebar">
        <div style="padding: 10px 0 30px; display:flex; align-items:center; gap:12px;">
            <div style="background: rgba(255,255,255,0.1); padding: 8px; border-radius: 10px; display:flex;">
                <span class="material-icons-round" style="color: var(--accent); font-size: 28px;">verified_user</span>
            </div>
            <div>
                <h2 style="font-weight: 800; font-size: 16px; letter-spacing: 0.5px;">SGC PRO</h2>
                <p style="font-size: 10px; opacity: 0.6;">Panel Principal</p>
            </div>
        </div>
        
        <nav style="flex:1; overflow-y: auto;">
            <p style="font-size:10px; color:var(--text-light); font-weight:700; margin: 15px 0 10px 10px; text-transform:uppercase; letter-spacing:1px;">Navegación</p>
            <button class="nav-link" id="nav-dash" onclick="cambiarVista('sec-dash', this)">
                <span class="material-icons-round">dashboard</span> Dashboard General
            </button>
            <button class="nav-link" id="nav-crear" onclick="cambiarVista('sec-crear', this)">
                <span class="material-icons-round">add_circle</span> Crear Solicitud
            </button>
            <button class="nav-link" id="nav-hist" onclick="cambiarVista('sec-hist', this)">
                <span class="material-icons-round">history_edu</span> Mis Solicitudes
            </button>
            <button class="nav-link" id="nav-gest" onclick="cambiarVista('sec-gest', this)">
                <span class="material-icons-round">fact_check</span> Bandeja de Gestión
            </button>
            <button class="nav-link" id="nav-listado" onclick="cambiarVista('sec-listado', this)">
                <span class="material-icons-round">inventory_2</span> Listado Maestro
            </button>
            
            <div id="admin-only" style="display:none; margin-top: 25px;">
                <p style="font-size:10px; color:var(--text-light); font-weight:700; margin: 0 0 10px 10px; text-transform:uppercase; letter-spacing:1px;">Administración</p>
                <button class="nav-link" id="nav-users" onclick="cambiarVista('sec-usuarios', this)">
                    <span class="material-icons-round">manage_accounts</span> Usuarios y Roles
                </button>
                <button class="nav-link" id="nav-struct" onclick="cambiarVista('sec-estructura', this)">
                    <span class="material-icons-round">domain_add</span> Estructura y Config.
                </button>
            </div>
        </nav>
        
        <div style="background: rgba(0,0,0,0.2); padding: 15px; border-radius: 14px; margin-top: 20px;">
            <div style="display:flex; align-items:center; gap:10px;">
                <span class="material-icons-round" style="background: var(--accent); padding: 6px; border-radius: 50%; font-size: 18px;">person</span>
                <div>
                    <p id="curr-name" style="font-weight: 700; font-size: 13px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 160px;"></p>
                    <p id="curr-ger" style="font-size: 10px; color: rgba(255,255,255,0.7); margin-top:2px;"></p>
                </div>
            </div>
            <button onclick="logout()" style="background: rgba(220, 38, 38, 0.15); border:none; color: #fca5a5; font-size:11px; font-weight:700; cursor:pointer; margin-top:15px; display:flex; align-items:center; justify-content:center; gap:6px; padding: 10px; width: 100%; border-radius: 8px; transition: 0.2s;">
                <span class="material-icons-round" style="font-size:16px;">logout</span> CERRAR SESIÓN
            </button>
        </div>
    </aside>

    <main class="main" id="main">
        
        <div class="mobile-header">
            <h2 style="font-size: 18px; color: var(--primary); margin:0; display:flex; align-items:center; gap:8px; font-weight:800;">
                <span class="material-icons-round">verified_user</span> SGC PRO
            </h2>
            <button class="menu-btn" onclick="toggleMenu()" style="background: #f1f5f9; border:none;">
                <span class="material-icons-round" style="color: var(--primary);">menu</span>
            </button>
        </div>

        <section id="sec-dash" class="section">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:25px; flex-wrap: wrap; gap: 15px;">
                <div>
                    <h1 style="font-size: 26px; font-weight: 800; color: var(--primary);">Dashboard General</h1>
                    <p style="color:var(--text-light); margin-top:5px;">Resumen métrico del sistema de gestión.</p>
                </div>
                <div style="display:flex; gap:10px; background: white; padding: 10px; border-radius: 12px; border: 1px solid var(--border); align-items: flex-end;">
                    <div>
                        <label style="margin-bottom:2px;">Fecha Desde</label>
                        <input type="date" id="dash-date-from" style="margin-bottom:0; padding: 8px;">
                    </div>
                    <div>
                        <label style="margin-bottom:2px;">Fecha Hasta</label>
                        <input type="date" id="dash-date-to" style="margin-bottom:0; padding: 8px;">
                    </div>
                    <button class="btn btn-primary" onclick="aplicarFiltroFechasDash()" style="padding: 9px 15px;"><span class="material-icons-round" style="font-size:18px;">filter_alt</span> Filtrar</button>
                    <button class="btn btn-ghost" onclick="limpiarFiltroFechasDash()" style="padding: 9px;"><span class="material-icons-round" style="font-size:18px;">close</span></button>
                </div>
            </div>

            <div class="grid-4">
                <div class="card dash-card" style="border-left-color: var(--primary);" onclick="dashFilterClick('')">
                    <span class="material-icons-round dash-icon" style="color:var(--primary)">folder_open</span>
                    <label>Total Solicitudes</label>
                    <h2 id="d-total">0</h2>
                    <p style="font-size:11px; color:var(--text-light); margin-top:5px;">Registradas en periodo</p>
                </div>
                <div class="card dash-card" style="border-left-color: var(--info);" onclick="dashFilterClick('Pendiente Documentado')">
                    <span class="material-icons-round dash-icon" style="color:var(--info)">create_new_folder</span>
                    <label>Pend. Documentar (E1)</label>
                    <h2 id="d-p1">0</h2>
                     <p style="font-size:11px; color:var(--text-light); margin-top:5px;">Inicio del flujo</p>
                </div>
                 <div class="card dash-card" style="border-left-color: var(--warning);" onclick="dashFilterClick('Pendiente Verificado')">
                    <span class="material-icons-round dash-icon" style="color:var(--warning)">rule</span>
                    <label>Pend. Verificar (E2)</label>
                    <h2 id="d-p2">0</h2>
                    <p style="font-size:11px; color:var(--text-light); margin-top:5px;">Revisión inicial SGC</p>
                </div>
                <div class="card dash-card" style="border-left-color: #8b5cf6;" onclick="dashFilterClick('Pendiente Aprobación Gerencia')">
                    <span class="material-icons-round dash-icon" style="color:#8b5cf6">supervisor_account</span>
                    <label>Pend. Gerencia (E3)</label>
                    <h2 id="d-p3">0</h2>
                     <p style="font-size:11px; color:var(--text-light); margin-top:5px;">Validación del área</p>
                </div>
                <div class="card dash-card" style="border-left-color: var(--danger);" onclick="dashFilterClick('Pendiente Aprobación SGC')">
                    <span class="material-icons-round dash-icon" style="color:var(--danger)">policy</span>
                    <label>Pend. Final SGC (E4)</label>
                    <h2 id="d-p4">0</h2>
                     <p style="font-size:11px; color:var(--text-light); margin-top:5px;">Control de calidad final</p>
                </div>
                <div class="card dash-card" style="border-left-color: var(--success);" onclick="dashFilterClick('APROBADO FINAL')">
                    <span class="material-icons-round dash-icon" style="color:var(--success)">verified</span>
                    <label>Finalizadas OK</label>
                    <h2 id="d-ok">0</h2>
                     <p style="font-size:11px; color:var(--text-light); margin-top:5px;">Publicadas en Maestro</p>
                </div>
            </div>
        </section>

        <section id="sec-crear" class="section">
            <div class="card" style="max-width: 950px; margin: auto;">
                <h2 style="margin-bottom:25px; font-weight:800; color:var(--primary);">Registrar Nueva Solicitud (FCI-SOL)</h2>
                
                <div class="grid-2">
                    <div>
                        <label>Acción Requerida</label>
                        <select id="sol-accion" onchange="toggleModPanel(this.value)">
                            <option value="Creación">Creación de Nuevo Documento</option>
                            <option value="Modificación">Modificación de Existente</option>
                            <option value="Inactivación">Inactivación/Obsoletar</option>
                        </select>
                    </div>
                    <div>
                        <label>Tipo de Documento</label>
                        <select id="sol-tipo-doc">
                            <option>Procedimiento</option><option>Instructivo</option><option>Formato</option><option>Manual</option><option>Guía</option><option>Política</option>
                        </select>
                    </div>
                </div>

                <div id="panel-mod" class="grid-3" style="display:none; background:#f8fafc; padding:20px; border-radius:12px; margin-bottom:20px; border:1px solid var(--border);">
                    <div style="grid-column: span 3; margin-bottom: -10px;"><h4 style="color:var(--primary); font-size:14px;">Datos del Documento a Modificar/Inactivar</h4></div>
                    <div><label>Código Actual</label><input type="text" id="sol-cod-prev" placeholder="Ej: FCI-PRO-001"></div>
                    <div><label>Versión Actual</label><input type="text" id="sol-ver-prev" placeholder="Ej: V-02"></div>
                    <div><label>Fecha Última Versión</label><input type="date" id="sol-fecha-prev"></div>
                </div>

                <label style="font-size: 12px;">Título Completo del Documento</label>
                <input type="text" id="sol-tit" placeholder="Ej: Procedimiento de Control de Accesos..." style="font-size: 16px; font-weight: 600; padding: 15px;">
                
                <div class="grid-2">
                    <div>
                        <label>Gerencia Responsable (Define quién aprueba en Etapa 3)</label>
                        <select id="sol-ger"></select>
                    </div>
                    <div>
                        <label>Departamento Específico</label>
                        <select id="sol-dep"><option value="">-- Seleccione Gerencia Primero --</option></select>
                    </div>
                </div>

                <div class="grid-2" style="background:#f0fdf4; padding:15px; border-radius:12px; margin-bottom:20px; border:1px solid #bbf7d0;">
                    <div><label style="color:#166534">Gerente Aprobador Identificado</label><input type="text" id="sol-gerente-display" disabled style="background:transparent; border:none; font-weight:bold; color:#15803d; padding:0;"></div>
                    <div><label style="color:#166534">Email de Notificación</label><input type="text" id="sol-email-gerente" disabled style="background:transparent; border:none; font-weight:bold; color:#15803d; padding:0;"></div>
                </div>

                 <div style="background: #f8fafc; padding: 20px; border-radius: 12px; border: 1px solid var(--border); margin-bottom: 20px;">
                    <label style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; font-size:12px;">
                        <div style="display:flex; align-items:center; gap:5px;"><span class="material-icons-round" style="color:var(--info)">group_add</span> Personas Involucradas / Co-solicitantes (Notificaciones)</div>
                        <button type="button" class="btn btn-info" style="padding: 6px 12px; font-size:11px;" onclick="addInvolucrado()"><span class="material-icons-round" style="font-size:16px;">add</span> Añadir Email</button>
                    </label>
                    <div id="lista-involucrados" style="display:flex; flex-direction:column; gap:10px;"></div>
                </div>
                
                <label style="font-size:12px;">Justificación / Motivo Detallado (Usa el editor para dar formato)</label>
                <div class="quill-wrapper">
                    <div id="quill-motivo" style="height: 150px;"></div>
                </div>

                <div style="background: #eff6ff; padding: 25px; border-radius: 16px; border: 2px dashed var(--accent); margin-bottom: 25px; text-align: center;">
                    <span class="material-icons-round" style="font-size: 40px; color: var(--accent);">cloud_upload</span>
                    <h4 style="color:var(--primary); margin: 10px 0;">Adjuntar Documento Inicial / Borrador</h4>
                    <p style="font-size:12px; color:var(--text-light); margin-bottom:15px;">Obligatorio para Modificaciones. Formatos: PDF, Word, Excel, e Imágenes.</p>
                    <input type="file" id="sol-file" accept=".pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx,.jpg,.png" style="margin: auto; width: auto; background: white; padding: 10px;">
                </div>

                <button class="btn btn-primary" id="btnSendSol" style="width:100%; padding: 18px; font-size: 16px; gap: 10px;">
                    <span class="material-icons-round">send</span> REGISTRAR Y ENVIAR A REVISIÓN
                </button>
            </div>
        </section>

        <section id="sec-hist" class="section">
            <div style="display:flex; justify-content:space-between; align-items:flex-end; margin-bottom:25px;">
                <h1 style="font-weight:800; color:var(--primary);">Mis Solicitudes Creadas</h1>
            </div>
            <div class="table-container">
                <div style="padding: 20px; background: #f8fafc; border-bottom: 1px solid var(--border); display:flex; gap:15px; align-items:center; flex-wrap: wrap;">
                    <div class="search-bar-container" style="flex:1;">
                        <span class="material-icons-round" style="position: absolute; margin: 14px; color: var(--text-light);">search</span>
                        <input type="text" id="search-hist" class="search-bar" style="padding-left: 45px; max-width: 100%;" placeholder="Buscar por ID, Título, Estado..." onkeyup="filtrarTabla('search-hist', 'tbody-historial')">
                    </div>
                    <button id="btn-export-hist" class="btn btn-success" onclick="exportarReporteSolicitudes()" style="display:none;"><span class="material-icons-round">sim_card_download</span> Exportar Reporte con KPIs de Tiempo</button>
                </div>
                <div class="table-responsive">
                    <table id="tabla-mis-solicitudes"><thead><tr><th>ID Control</th><th>Título del Documento</th><th>Gerencia Destino</th><th>Estado Actual & Etapa</th><th class="no-export" style="text-align:center;">Acción</th></tr></thead><tbody id="tbody-historial"></tbody></table>
                </div>
            </div>
        </section>

        <section id="sec-gest" class="section">
            <div style="display:flex; justify-content:space-between; align-items:flex-end; margin-bottom:25px;">
                 <div>
                    <h1 style="font-weight:800; color:var(--primary);">Bandeja de Gestión Pendiente</h1>
                    <p style="color:var(--text-light); margin-top:5px;">Solicitudes que requieren tu revisión o aprobación.</p>
                </div>
            </div>
            <div class="table-container" style="border-top: 4px solid var(--warning);">
                <div style="padding: 20px; background: #f8fafc; border-bottom: 1px solid var(--border); display:flex; gap:15px; align-items:center; flex-wrap: wrap;">
                     <div class="search-bar-container" style="flex:1;">
                        <span class="material-icons-round" style="position: absolute; margin: 14px; color: var(--text-light);">search</span>
                        <input type="text" id="search-gest" class="search-bar" style="padding-left: 45px; max-width: 100%;" placeholder="Buscar por ID, Solicitante, Título..." onkeyup="filtrarTabla('search-gest', 'tbody-gestionar')">
                    </div>
                    <button id="btn-export-gest" class="btn btn-success" onclick="exportarReporteSolicitudes()" style="display:none;"><span class="material-icons-round">sim_card_download</span> Exportar Reporte con KPIs de Tiempo</button>
                </div>
                <div class="table-responsive">
                    <table id="tabla-gestion-solicitudes"><thead><tr><th>ID Control</th><th>Solicitante</th><th>Título del Documento</th><th>Estado Actual & Etapa</th><th class="no-export" style="text-align:center;">Gestión</th></tr></thead><tbody id="tbody-gestionar"></tbody></table>
                </div>
            </div>
        </section>

        <section id="sec-listado" class="section">
            <div style="display:flex; justify-content:space-between; align-items:flex-end; margin-bottom:25px; flex-wrap:wrap; gap:20px;">
                <div>
                    <h1 style="font-weight:800; color:var(--primary);">Listado Maestro de Documentos</h1>
                    <p style="color:var(--text-light); margin-top:5px;">Repositorio centralizado de documentación oficial aprobada.</p>
                </div>
                <div style="display:flex; gap:10px; flex-wrap:wrap;">
                    <button id="btn-export-list" class="btn btn-success" onclick="exportarExcelListado()" style="display:none;">
                        <span class="material-icons-round">file_download</span> Exportar Excel
                    </button>
                    <input type="file" id="import-excel-file" accept=".xlsx, .xls" style="display:none;">
                    <label for="import-excel-file" class="btn btn-warning" id="btn-import-maestro" style="display:none; cursor:pointer; margin:0;">
                        <span class="material-icons-round">file_upload</span> Importar Masivo
                    </label>
                    <button class="btn btn-primary" id="btn-nuevo-maestro" onclick="abrirModalListadoMaestro()" style="display:none;">
                        <span class="material-icons-round">add</span> Registro Manual
                    </button>
                </div>
            </div>

            <div class="table-container" style="border-top: 4px solid var(--success);">
                <div style="padding: 20px; background: #f8fafc; border-bottom: 1px solid var(--border);">
                     <div class="search-bar-container">
                        <span class="material-icons-round" style="position: absolute; margin: 14px; color: var(--text-light);">search</span>
                        <input type="text" id="search-maestro" class="search-bar" style="padding-left: 45px; max-width: 100%;" placeholder="Buscar en todo el listado maestro..." onkeyup="filtrarTabla('search-maestro', 'tbody-listado-maestro')">
                    </div>
                </div>
                <div class="table-responsive">
                    <table id="tabla-listado-maestro" style="white-space:nowrap;">
                        <thead id="thead-listado-maestro"></thead>
                        <tbody id="tbody-listado-maestro"></tbody>
                    </table>
                </div>
            </div>
        </section>
        
        <section id="sec-usuarios" class="section">
            <div class="grid-2">
                <div class="card">
                    <h2 style="margin-bottom:20px; color:var(--primary);">Gestión de Usuarios y Permisos</h2>
                    <h3 id="user-form-title" style="font-size:14px; margin-bottom:15px; color:var(--text-light);">Registrar Nuevo / Editar Existente</h3>
                    
                    <div class="grid-2">
                        <div><label>Nombre Completo</label><input type="text" id="u-nom"></div>
                        <div><label>Usuario ID (Login)</label><input type="text" id="u-usr" placeholder="usuario.apellido"></div>
                    </div>
                    <div class="grid-2">
                        <div><label>Contraseña Inicial</label><input type="text" id="u-pas" value="Fci2024."></div>
                        <div><label>Gerencia Pertenencia</label><select id="u-ger-sel"></select></div>
                    </div>
                    <div class="grid-2">
                        <div><label>Cargo/Rol Visible</label><input type="text" id="u-rol" placeholder="Ej: Analista de Calidad"></div>
                        <div><label>Email Corporativo (Importante)</label><input type="email" id="u-email" placeholder="usuario@fcipty.com"></div>
                    </div>

                    <label style="margin-top:15px; font-size:12px;">Configuración de Permisos y Roles de Acceso</label>
                    <div style="border:1px solid var(--border); padding:15px; border-radius:12px; margin-bottom:20px; display:grid; grid-template-columns: 1fr 1fr; gap:12px; background:#f8fafc;">
                        <div class="access-item"><span>Solicitar (Crear)</span><label class="switch"><input type="checkbox" id="p-solicitar"><span class="slider"></span></label></div>
                        <div class="access-item"><span>Ver Propias</span><label class="switch"><input type="checkbox" id="p-ver-propias" checked><span class="slider"></span></label></div>
                        <div class="access-item"><span>Ver Su Gerencia</span><label class="switch"><input type="checkbox" id="p-ver-ger"><span class="slider"></span></label></div>
                        <div class="access-item" style="background:#eff6ff; border-color: var(--accent);"><span>Rol: Gestor SGC (Fases 1,2,4)</span><label class="switch"><input type="checkbox" id="p-gest-sgc"><span class="slider"></span></label></div>
                        <div class="access-item" style="background:#fefce8; border-color: var(--warning);"><span>Rol: Gerente Aprobador (Fase 3)</span><label class="switch"><input type="checkbox" id="p-ger-apr"><span class="slider"></span></label></div>
                        <div class="access-item"><span>Admin Usuarios</span><label class="switch"><input type="checkbox" id="p-users"><span class="slider"></span></label></div>
                        <div class="access-item"><span>Admin Estructura</span><label class="switch"><input type="checkbox" id="p-struct"><span class="slider"></span></label></div>
                        <div class="access-item"><span>Modificar Listado M.</span><label class="switch"><input type="checkbox" id="p-ver-listado"><span class="slider"></span></label></div>
                        <div class="access-item" style="grid-column:span 2; border:2px dashed var(--danger); background:#fef2f2;">
                            <span style="color:var(--danger); font-weight:800;">SUPER ADMIN (Acceso Total)</span><label class="switch"><input type="checkbox" id="p-admin"><span class="slider"></span></label>
                        </div>
                    </div>
                    
                    <button class="btn btn-primary" id="btnSaveUser" style="width:100%; padding:15px;">GUARDAR USUARIO</button>
                    <button class="btn btn-ghost" id="btnCancelEdit" style="width:100%; margin-top:10px; display:none;" onclick="resetUserForm()">CANCELAR EDICIÓN</button>
                </div>
                <div class="table-container" style="height: fit-content;">
                    <div style="padding:15px; background:#f8fafc; border-bottom:1px solid var(--border); font-weight:700; color:var(--primary);">Directorio de Usuarios</div>
                    <div class="table-responsive">
                        <table id="table-users"><thead><tr><th>Usuario</th><th>Info Contacto</th><th>Rol & Gerencia</th><th></th></tr></thead><tbody id="tbody-users"></tbody></table>
                    </div>
                </div>
            </div>
        </section>

        <section id="sec-estructura" class="section">
            <h2 style="margin-bottom: 25px; color:var(--primary); display:flex; align-items:center; gap:10px; font-weight:800;">
                <span class="material-icons-round">settings_suggest</span> Configuración del Sistema
            </h2>
            
            <div class="grid-2">
                <div class="card" style="border-top: 4px solid var(--accent);">
                    <h3 style="display:flex; align-items:center; gap:8px; font-size:16px;"><span class="material-icons-round" style="color:var(--accent);">domain</span> Gerencias (Áreas Principales)</h3>
                    <p style="font-size:11px; color:var(--text-light); margin-bottom:15px;">Definen los flujos de aprobación gerencial.</p>
                    <div style="display:flex; gap:0; margin-bottom:15px;">
                        <input type="text" id="g-nom" placeholder="Nombre de la Gerencia..." style="margin:0; border-radius: 10px 0 0 10px; border-right:none;">
                        <button class="btn btn-success" id="btnSaveGer" style="border-radius: 0 10px 10px 0; padding: 0 20px;"><span class="material-icons-round">add</span></button>
                    </div>
                    <div id="list-ger" class="settings-list"></div>
                </div>

                <div class="card" style="border-top: 4px solid var(--info);">
                    <h3 style="display:flex; align-items:center; gap:8px; font-size:16px;"><span class="material-icons-round" style="color:var(--info);">groups</span> Departamentos (Sub-áreas)</h3>
                    <p style="font-size:11px; color:var(--text-light); margin-bottom:15px;">Unidades funcionales dentro de una gerencia.</p>
                    <div style="display:flex; gap:0; margin-bottom:15px;">
                        <select id="d-ger-sel" style="margin:0; border-radius: 10px 0 0 10px; border-right:1px solid var(--border); width:40%; padding:12px;"></select>
                        <input type="text" id="d-nom" placeholder="Nombre del Depto..." style="margin:0; border-radius: 0; border-right:none; width:60%;">
                        <button class="btn btn-success" id="btnSaveDep" style="border-radius: 0 10px 10px 0; padding: 0 20px;"><span class="material-icons-round">add</span></button>
                    </div>
                    <div id="list-dep" class="settings-list"></div>
                </div>
            </div>
            
            <h3 style="margin:35px 0 20px; color:var(--primary); display:flex; align-items:center; gap:10px; border-bottom:2px solid var(--border); padding-bottom:15px; font-weight:800;">
                <span class="material-icons-round">view_column</span> Configuración del Listado Maestro
            </h3>
            
            <div class="grid-2">
                <div class="card" style="border-top: 4px solid #8b5cf6;">
                    <h3 style="display:flex; align-items:center; gap:8px; font-size:16px;"><span class="material-icons-round" style="color:#8b5cf6;">table_chart</span> Columnas Personalizadas</h3>
                    <p style="font-size:11px; color:var(--text-light); margin-bottom:15px;">Campos adicionales para la base de datos central.</p>
                    <div style="display:flex; gap:0; margin-bottom:15px;">
                        <input type="text" id="col-nom" placeholder="Ej: Normativa Asociada" style="margin:0; border-radius: 10px 0 0 10px; border-right:none;">
                        <button class="btn btn-success" onclick="agregarColumna()" style="border-radius: 0 10px 10px 0; padding: 0 20px;"><span class="material-icons-round">add</span></button>
                    </div>
                    <div id="list-columnas" class="settings-list"></div>
                </div>

                <div class="card" style="border-top: 4px solid var(--warning);">
                    <h3 style="display:flex; align-items:center; gap:8px; font-size:16px;"><span class="material-icons-round" style="color:var(--warning);">label</span> Estatus Documentales</h3>
                    <p style="font-size:11px; color:var(--text-light); margin-bottom:15px;">Ciclo de vida del documento (Vigente, Obsoleto, etc.)</p>
                    <div style="display:flex; gap:0; margin-bottom:15px;">
                        <input type="text" id="est-nom" placeholder="Ej: En Revisión Anual" style="margin:0; border-radius: 10px 0 0 10px; border-right:none;">
                        <button class="btn btn-success" onclick="agregarEstatus()" style="border-radius: 0 10px 10px 0; padding: 0 20px;"><span class="material-icons-round">add</span></button>
                    </div>
                    <div id="list-estatus" class="settings-list"></div>
                </div>
            </div>
        </section>
    </main>

    <div class="modal-overlay" id="modal">
        <div class="modal-content">
            <div class="modal-main">
                
                <div style="display:flex; justify-content:space-between; margin-bottom:25px; align-items: flex-start; border-bottom: 1px solid var(--border); padding-bottom: 20px;">
                    <div>
                        <div style="display:flex; align-items:center; gap:10px; margin-bottom:5px;">
                             <span id="m-id" style="font-weight:800; color:var(--primary); font-size:18px; background: #e0f2fe; padding: 4px 12px; border-radius: 8px;"></span>
                             <span id="m-est" class="badge"></span>
                        </div>
                        <h2 id="m-tit" style="margin-top:10px; font-size:22px; font-weight:800; color:var(--text-dark);"></h2>
                    </div>
                    <div style="display:flex; gap:10px;">
                        <button class="btn btn-danger" id="btn-anular" onclick="anularSolicitud()" style="display:none; padding: 10px 20px;"><span class="material-icons-round">block</span> Anular Proceso</button>
                        <button class="btn btn-ghost" onclick="closeModal()" style="background:var(--border); color:var(--text-dark); padding: 10px 20px;"><span class="material-icons-round">close</span> Cerrar</button>
                    </div>
                </div>
                
                <div class="step-container">
                    <div class="step" id="s1"><div class="step-dot"><span class="material-icons-round" style="font-size:16px;">description</span></div><label>1. Pendiente Documentar</label></div>
                    <div class="step" id="s2"><div class="step-dot"><span class="material-icons-round" style="font-size:16px;">rule</span></div><label>2. Pendiente Verificado SGC</label></div>
                    <div class="step" id="s3"><div class="step-dot"><span class="material-icons-round" style="font-size:16px;">supervisor_account</span></div><label>3. Pendiente Aprob. Gerencia</label></div>
                    <div class="step" id="s4"><div class="step-dot"><span class="material-icons-round" style="font-size:16px;">policy</span></div><label>4. Pendiente Aprob. Final SGC</label></div>
                </div>

                <div id="m-display-final" style="display:none; margin-bottom:25px; background:#f0fdf4; padding:25px; border-radius:16px; border: 2px solid #bbf7d0;">
                    <h4 style="color:#166534; margin-bottom:20px; display:flex; align-items:center; gap:10px; font-size:18px;"><span class="material-icons-round" style="font-size:24px;">verified</span> Documento Oficial Publicado</h4>
                    <div class="grid-3" style="margin-bottom:20px;">
                        <div class="card" style="padding:15px; margin:0; border:none; background:rgba(255,255,255,0.6); box-shadow:none;"><label>Código Final</label><p id="m-disp-cod" style="font-weight:800; font-size:16px; color:var(--primary);"></p></div>
                        <div class="card" style="padding:15px; margin:0; border:none; background:rgba(255,255,255,0.6); box-shadow:none;"><label>Versión Oficial</label><p id="m-disp-ver" style="font-weight:800; font-size:16px; color:var(--primary);"></p></div>
                        <div class="card" style="padding:15px; margin:0; border:none; background:rgba(255,255,255,0.6); box-shadow:none;">
                            <label>Fecha de Vigencia</label>
                            <div style="display:flex; align-items:center; gap:10px;">
                                <p id="m-disp-fecha" style="font-weight:800; font-size:16px; margin:0;"></p>
                                <button id="btn-edit-fecha-final" style="display:none; background:white; border:1px solid var(--border); padding:4px; border-radius:6px; cursor:pointer; color:var(--accent);"><span class="material-icons-round" style="font-size:18px;">edit</span></button>
                            </div>
                            <div id="edit-fecha-final-container" style="display:none; margin-top:10px; background:white; padding:15px; border-radius:12px; border:1px solid var(--border); box-shadow: 0 4px 10px rgba(0,0,0,0.05);">
                                <label>Nueva Fecha</label>
                                <input type="date" id="in-edit-fecha-final" style="width:100%; margin-bottom:10px;">
                                <div style="display:flex; gap:5px;">
                                    <button class="btn btn-success" id="btn-save-fecha-final" style="padding:8px; font-size:12px; flex:1;">Guardar Cambio</button>
                                    <button class="btn btn-ghost" id="btn-cancel-fecha-final" style="padding:8px; font-size:12px; flex:1;">Cancelar</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div style="background: white; padding: 15px; border-radius: 12px; border: 1px solid #bbf7d0; display:flex; align-items:center; gap:15px;">
                         <span class="material-icons-round" style="font-size:32px; color:#166534;">description</span>
                         <div style="flex:1;">
                             <label style="margin-bottom:2px;">Archivo Oficial del Documento</label>
                             <div id="m-disp-file"></div>
                         </div>
                    </div>
                    <div style="margin-top:15px;">
                        <label>Nota de Cierre / Observaciones</label>
                        <p id="m-disp-com" style="font-style:italic; color:var(--text-light);"></p>
                    </div>
                </div>

                <div id="m-panel-update-sgc" style="display:none; margin-bottom:25px; background:#f0f9ff; padding:25px; border-radius:16px; border: 2px dashed var(--info);">
                    <h4 style="color:var(--info); margin-bottom:15px; display:flex; align-items:center; gap:10px; font-size:16px;"><span class="material-icons-round">edit_note</span> Revisión y Ajuste SGC (Pre-Gerencia)</h4>
                    <p style="font-size:12px; color:var(--text-light); margin-bottom:20px;">Si es necesario, ajusta los metadatos o reemplaza el archivo adjunto antes de enviarlo a aprobación gerencial.</p>
                    <div class="grid-2">
                        <div><label>Título Ajustado</label><input type="text" id="m-upd-tit" style="background:white;"></div>
                        <div><label>Código Propuesto</label><input type="text" id="m-upd-cod" style="background:white;"></div>
                        <div><label>Versión Propuesta</label><input type="text" id="m-upd-ver" style="background:white;"></div>
                        <div><label>Reemplazar Adjunto (Opcional)</label><input type="file" id="m-upd-file" accept=".pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx,.jpg,.png" style="background:white; padding:8px;"></div>
                    </div>
                    <button class="btn btn-info" onclick="actualizarDatosSGC()" style="width:100%; margin-top:15px; padding:15px;"><span class="material-icons-round">save_as</span> GUARDAR AJUSTES Y CONTINUAR</button>
                </div>

                <div id="m-panel-final-sgc" style="display:none; margin-bottom:25px; background:#eff6ff; padding:25px; border-radius:16px; border: 2px solid var(--primary);">
                    <h4 style="color:var(--primary); margin-bottom:20px; display:flex; align-items:center; gap:10px; font-size:18px;"><span class="material-icons-round">published_with_changes</span> Cierre Técnico y Publicación Oficial</h4>
                     <p style="font-size:13px; color:var(--text-light); margin-bottom:20px; background: white; padding: 10px; border-radius: 8px; border-left: 4px solid var(--primary);">
                        <span class="material-icons-round" style="vertical-align: middle; margin-right: 5px;">info</span>
                        Complete los datos finales y suba la versión definitiva (firmada/aprobada) para publicar el documento en el Listado Maestro y cerrar la solicitud.
                    </p>
                    <div class="grid-3">
                        <div><label>Código Final Asignado (Obligatorio)</label><input type="text" id="m-final-cod" placeholder="Ej: FCI-PRO-G-001" style="background:white; font-weight:700;"></div>
                        <div><label>Versión Final (Obligatorio)</label><input type="text" id="m-final-ver" placeholder="Ej: V-01" style="background:white; font-weight:700;"></div>
                        <div><label>Fecha de Vigencia (Obligatorio)</label><input type="date" id="m-final-fecha" style="background:white; font-weight:700;"></div>
                    </div>
                    <div style="margin-bottom:20px; background: white; padding: 15px; border-radius: 12px; border: 2px dashed var(--primary); text-align: center;">
                        <span class="material-icons-round" style="font-size:30px; color:var(--primary);">upload_file</span>
                        <label style="margin: 10px 0; color:var(--primary);">Adjuntar Documento Oficial Definitivo (Obligatorio)</label>
                        <input type="file" id="m-final-file" accept=".pdf,.doc,.docx,.xls,.xlsx" style="margin: auto; width: auto; padding: 10px;">
                    </div>
                    <label>Comentarios de Cierre / Observaciones Públicas</label>
                    <input type="text" id="m-final-comentario" placeholder="Ej: Se aprueba versión inicial..." style="background:white; margin-bottom:20px;">
                    <button class="btn btn-primary" onclick="guardarCierreFinal()" style="width:100%; padding:18px; font-size:15px; gap:10px;"><span class="material-icons-round">verified</span> PUBLICAR DOCUMENTO Y FINALIZAR SOLICITUD</button>
                </div>

                <div id="m-original-data">
                    <h4 id="m-orig-title" class="locked-title" style="display:none; margin-bottom:20px; padding-bottom:10px; border-bottom:1px solid var(--border);"><span class="material-icons-round">lock_clock</span> Histórico de la Solicitud Inicial</h4>
                    
                    <div class="grid-3" style="background: #f8fafc; padding: 20px; border-radius: 16px; border: 1px solid var(--border);">
                        <div><label>Solicitante</label><p id="m-sol" style="font-weight:500;"></p></div>
                        <div><label>Gerencia Destino</label><p id="m-ger" style="font-weight:500;"></p></div>
                        <div><label>Tipo y Acción</label><p><span id="m-tipo" style="font-weight:700;"></span> (<span id="m-accion"></span>)</p></div>
                    </div>

                    <div id="m-extra-panel" style="display:none; background:#fff7ed; padding:20px; border-radius:16px; border: 1px solid #fdba74; margin-top:20px;">
                        <h4 style="color:#c2410c; font-size:13px; margin-bottom:15px;">Datos del Documento Anterior (Referencia)</h4>
                        <div class="grid-3">
                            <div><label style="color:#9a3412">Código Anterior</label><p id="m-cod" style="font-weight:700; color:#c2410c;"></p></div>
                            <div><label style="color:#9a3412">Versión Anterior</label><p id="m-ver" style="font-weight:700; color:#c2410c;"></p></div>
                            <div><label style="color:#9a3412">Fecha Ult. Versión</label><p id="m-fecha-ult" style="font-weight:700; color:#c2410c;"></p></div>
                        </div>
                    </div>

                    <div style="margin-top:25px;">
                         <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                            <label style="margin-bottom:0;">Justificación / Motivo Inicial</label>
                            <div id="m-file-link"></div>
                        </div>
                        <div id="m-jus" style="padding: 20px; background: #f8fafc; border-radius: 12px; border: 1px solid var(--border); font-size: 14px; line-height: 1.5;"></div>
                    </div>

                    <div id="m-involucrados-container" style="background:#f0f9ff; padding:20px; border-radius:16px; margin-top:25px; border:1px solid #bae6fd;">
                        <div style="display:flex; align-items:center; gap:10px; margin-bottom:15px;">
                             <span class="material-icons-round" style="color:#0284c7">group</span>
                             <h4 style="color:#0284c7; font-size:14px; margin:0;">Personas Involucradas (Notificaciones)</h4>
                        </div>
                        
                        <div style="display:flex; flex-wrap:wrap; gap:10px; margin-bottom: 15px;" id="m-involucrados-tags">
                            </div>
                        
                        <div id="m-add-involucrado-section" style="display:flex; gap:10px; border-top: 1px dashed #bae6fd; padding-top: 15px; align-items: center;">
                            <span class="material-icons-round" style="color:#0284c7; font-size: 20px;">person_add</span>
                            <input type="email" id="m-new-involucrado" placeholder="Añadir nuevo correo para notificar (ej: usuario@fcipty.com)" style="margin:0; padding:10px; font-size:13px; flex:1; background:white; border-color:#bae6fd;">
                            <button class="btn btn-info" onclick="guardarNuevoInvolucrado()" style="padding:10px 20px;">Añadir</button>
                        </div>
                    </div>
                </div>

                <div id="m-actions" style="margin-top:35px; display:none; background: #f8fafc; padding: 25px; border-radius: 16px; border: 1px solid var(--border);">
                    <h4 style="margin-bottom:20px; color:var(--primary); display:flex; align-items:center; gap:10px;"><span class="material-icons-round">settings_applications</span> Acciones de Gestión Disponibles</h4>
                    <div style="display:flex; gap:15px; flex-wrap:wrap;">
                        <button class="btn btn-info" onclick="gestionar('Consulta')" style="flex:1; padding: 15px;"><span class="material-icons-round">live_help</span> Realizar Consulta</button>
                        <button class="btn btn-warning" onclick="gestionar('Reunión')" style="flex:1; padding: 15px;"><span class="material-icons-round">groups</span> Solicitar Reunión</button>
                        <button class="btn btn-danger" onclick="rechazar()" style="flex:1; padding: 15px;"><span class="material-icons-round">cancel</span> Rechazar / Devolver</button>
                        <button class="btn btn-primary" id="btn-firma-next" onclick="firmarPaso()" style="flex:1.5; padding: 15px; font-size: 15px;"><span class="material-icons-round">check_circle</span> APROBAR Y AVANZAR ETAPA</button>
                    </div>
                </div>

                <div id="applicant-actions" style="margin-top:35px; display:none; background: #f0fdf4; padding: 25px; border-radius: 16px; border: 1px solid #bbf7d0;">
                    <h4 style="margin-bottom:20px; color:#166534; display:flex; align-items:center; gap:10px;"><span class="material-icons-round">assignment_ind</span> Acciones del Solicitante</h4>
                    <button class="btn btn-success" style="width:100%; padding: 18px; font-size: 15px; gap:10px;" onclick="responderSolicitante()">
                        <span class="material-icons-round">rate_review</span> RESPONDER CONSULTA / ENVIAR CORRECCIÓN
                    </button>
                </div>

                <div id="m-input-area" style="display:none; margin-top:25px; background: white; padding: 25px; border-radius: 16px; border: 2px solid var(--accent); box-shadow: 0 10px 25px -5px rgba(59, 130, 246, 0.1);">
                    <h4 id="m-input-title" style="color:var(--accent); margin-bottom:15px; font-weight:800;">Completar Acción</h4>
                    
                    <div id="reunion-container" style="display:none; margin-bottom:15px; background: #fffbeb; padding: 15px; border-radius: 10px; border: 1px solid #fcd34d;">
                        <label style="color:#92400e; display:flex; align-items:center; gap:5px;"><span class="material-icons-round">event</span> Fecha y Hora Propuesta para Reunión</label>
                        <input type="datetime-local" id="m-date-meeting" style="background:white; border-color:#fcd34d;">
                    </div>
                    
                    <label>Detalle del Mensaje / Comentario / Motivo</label>
                    <div class="quill-wrapper">
                        <div id="quill-gestion" style="height: 120px;"></div>
                    </div>

                    <div style="background:#f8fafc; padding:15px; border-radius:12px; border:1px solid var(--border); margin-bottom:20px; display:flex; align-items:center; gap:15px;">
                            <span class="material-icons-round" style="font-size:24px; color:var(--text-light);">attach_file</span>
                            <div style="flex:1;">
                                <label style="margin-bottom:2px;">Adjuntar Archivo de Soporte / Corrección (Opcional)</label>
                                <input type="file" id="m-file-gestion" accept=".pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx,.jpg,.jpeg,.png" style="margin-bottom:0; padding:8px; background:white;">
                            </div>
                    </div>
                    <div style="display:flex; gap:10px;">
                         <button class="btn btn-primary" id="btnConfirmAction" style="flex:2; padding: 15px; font-size: 15px;">CONFIRMAR Y ENVIAR</button>
                         <button class="btn btn-ghost" onclick="document.getElementById('m-input-area').style.display='none'" style="flex:1; padding: 15px;">Cancelar</button>
                    </div>
                </div>

                <div id="general-comment-area" style="margin-top:40px; border-top:2px solid var(--border); padding-top:25px;">
                    <h4 style="margin-bottom:15px; color:var(--text-dark); display:flex; align-items:center; gap:10px;"><span class="material-icons-round">forum</span> Agregar Nota a la Bitácora</h4>
                    
                    <div class="quill-wrapper">
                        <div id="quill-comentario" style="height: 100px;"></div>
                    </div>

                    <div style="display:flex; gap:15px; align-items:flex-start; background: #f8fafc; padding: 15px; border-radius: 12px; border: 1px solid var(--border);">
                        <div style="flex:1;">
                            <label style="margin-bottom:5px;">Adjuntar Referencia (Opcional)</label>
                            <input type="file" id="m-file-comentario" accept=".pdf,.doc,.docx,.xls,.xlsx,.png,.jpg" style="margin-bottom:0; padding:10px; background:white;">
                        </div>
                        <button class="btn btn-success" onclick="enviarComentarioLibre()" style="height:fit-content; padding: 15px 25px; margin-top: 23px; gap:8px;"><span class="material-icons-round">send</span> PUBLICAR NOTA</button>
                    </div>
                </div>

            </div>
            
            <div class="modal-side">
                <div style="padding:20px 25px; border-bottom:1px solid var(--border); background: white; display:flex; align-items:center; gap:10px;">
                    <span class="material-icons-round" style="color:var(--primary);">history</span>
                    <h4 style="margin:0; font-size:16px; font-weight:800;">Bitácora de Eventos</h4>
                </div>
                <div id="chat-box">
                    </div>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="modal-form-listado">
        <div class="modal-content" style="max-width: 850px; display:block; padding: 0; height:auto; max-height:90vh; overflow-y:auto; border-radius: 24px;">
           <div style="padding:30px; background: white;">
               <h2 style="color:var(--primary); margin-bottom: 25px; display:flex; align-items:center; gap:12px; font-weight:800;">
                   <span class="material-icons-round" style="background:#e0f2fe; padding:8px; border-radius:12px;">edit_document</span> 
                   <span id="lm-modal-title">Gestionar Registro Maestro</span>
               </h2>
               
               <div class="grid-2" id="dinamic-form-maestro" style="gap:25px;"></div>
               
               <div style="background:#f0f9ff; padding:20px; border-radius:16px; margin-top:25px; border:2px dashed var(--info); display:flex; align-items:center; gap:20px;">
                   <span class="material-icons-round" style="font-size:36px; color:var(--info);">cloud_upload</span>
                   <div style="flex:1;">
                       <label style="color:var(--info); font-size:12px; margin-bottom:5px;">Herramienta Rápida: Subir archivo a la nube y obtener enlace</label>
                       <div style="display:flex; gap:10px;">
                           <input type="file" id="lm-generic-file" style="margin:0; background:white; flex:1; padding:10px;">
                           <button class="btn btn-info" onclick="subirArchivoGenericoLM()" style="padding:10px 20px;">Subir y Generar URL</button>
                       </div>
                   </div>
               </div>

               <div style="display:flex; gap:15px; margin-top:30px; border-top: 1px solid var(--border); padding-top: 25px;">
                   <button class="btn btn-primary" onclick="guardarRegistroMaestro()" style="flex:1; padding:15px; font-size:15px;">GUARDAR REGISTRO EN MAESTRO</button>
                   <button class="btn btn-ghost" onclick="document.getElementById('modal-form-listado').style.display='none'" style="flex:1; padding:15px; font-size:15px; background:var(--border); color:var(--text-dark);">Cancelar</button>
               </div>
           </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, getDoc, updateDoc, setDoc, query, where, getDocs, arrayUnion, runTransaction, deleteDoc } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";

        // --- Configuración de Servicios ---
        const firebaseConfig = {
          apiKey: "AIzaSyDdzCiachuhbE9jATz-TesPI2vUVIJrHjM",
          authDomain: "sistemadegestion-7400d.firebaseapp.com",
          projectId: "sistemadegestion-7400d",
          storageBucket: "sistemadegestion-7400d.firebasestorage.app",
          messagingSenderId: "709030283072",
          appId: "1:709030283072:web:5997837b36a448e9515ca5"
        };
        const EMAIL_SERVICE_ID = "service_a7yozqh"; 
        const EMAIL_TEMPLATE_ID = "template_7hlhnt8"; 
        const EMAIL_PUBLIC_KEY = "2jVnfkJKKG0bpKN-U"; 
        const EMAIL_ADMIN_SGC = "sistemadegestion@fcipty.com"; 
        const EMAIL_GRUPO_SGC = "actualizacion@fcipty.com"; 
        const CLOUD_NAME = "df79cjklp";
        const UPLOAD_PRESET = "fci_documentos";
        const appId = 'sgc-final-v7-kpis'; // ID de App actualizado para nueva estructura de datos

        // --- Inicialización ---
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        (function() { emailjs.init(EMAIL_PUBLIC_KEY); })();

        // --- Variables Globales ---
        let currentUser = null;
        let selectedId = null;
        let selectedDocData = null; 
        let tempAction = "";
        let allUsers = []; 
        let allDepartamentos = []; 
        let columnasMaestro = [];
        let estatusMaestro = [];
        let dataMaestro = [];
        let editandoMaestroId = null;
        let globalSolicitudes = [];
        let dashboardDateFilter = { from: null, to: null }; // Estado del filtro de fechas
        const PASOS_NOMBRES = ["Pendiente Documentado", "Pendiente Verificado", "Pendiente Aprobación Gerencia", "Pendiente Aprobación SGC"];

        // --- Inicialización de Editores de Texto Enriquecido (Quill) ---
        const quillOptions = {
            theme: 'snow',
            modules: {
                toolbar: [
                    ['bold', 'italic', 'underline'],
                    [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                    [{ 'color': [] }, { 'background': [] }],
                    ['clean']
                ]
            }
        };
        const quillMotivo = new Quill('#quill-motivo', quillOptions);
        const quillGestion = new Quill('#quill-gestion', quillOptions);
        const quillComentario = new Quill('#quill-comentario', quillOptions);

        // --- Funciones Utilitarias ---

        // Formatea fechas ISO a formato legible DD MMM YYYY
        window.formatearFechaAbreviada = (fechaStr) => {
            if (!fechaStr) return "N/A";
            let dateVal = fechaStr;
            // Intenta corregir fechas que solo son YYYY-MM-DD agregando hora para evitar problemas de zona horaria
            if (typeof fechaStr === 'string' && fechaStr.length === 10 && fechaStr.includes("-") && !fechaStr.includes("T")) {
                dateVal = fechaStr + "T12:00:00"; 
            }
            let dObj = new Date(dateVal);
            if (isNaN(dObj.getTime())) return fechaStr; // Si no es válida, retorna el string original

            const meses = ["ene.", "feb.", "mar.", "abr.", "may.", "jun.", "jul.", "ago.", "sep.", "oct.", "nov.", "dic."];
            const d = String(dObj.getDate()).padStart(2, '0');
            const m = meses[dObj.getMonth()];
            const y = dObj.getFullYear();
            return `${d} ${m} ${y}`;
        };

        // Calcula la diferencia en horas y días entre dos fechas
        function calcularDiferenciaTiempo(inicio, fin) {
            if (!inicio || !fin) return { horas: 0, dias: 0, texto: "N/A" };
            const dInicio = new Date(inicio);
            const dFin = new Date(fin);
            const diffMs = dFin - dInicio;
            if (diffMs < 0) return { horas: 0, dias: 0, texto: "N/A" }; // Evitar tiempos negativos

            const diffHoras = (diffMs / (1000 * 60 * 60)).toFixed(2);
            const diffDias = (diffMs / (1000 * 60 * 60 * 24)).toFixed(2);
            return { horas: diffHoras, dias: diffDias, texto: `${diffHoras} hrs (${diffDias} días)` };
        }

        // Añade campo de correo extra en el formulario de creación
        window.addInvolucrado = () => {
            const container = document.getElementById('lista-involucrados');
            const div = document.createElement('div');
            div.style.display = 'flex'; div.style.gap = '10px'; div.style.alignItems = 'center';
            div.innerHTML = `
                <span class="material-icons-round" style="color:var(--text-light); font-size:18px;">alternate_email</span>
                <input type="email" placeholder="ejemplo@fcipty.com" class="extra-email" style="margin-bottom:0; flex:1; border-radius:8px; padding:10px;">
                <button type="button" class="btn btn-ghost" onclick="this.parentElement.remove()" style="padding:8px; color:var(--danger);"><span class="material-icons-round" style="font-size:18px; margin:0;">close</span></button>
            `;
            container.appendChild(div);
        };

        // Añade involucrado desde el modal de detalle
        window.guardarNuevoInvolucrado = async () => {
            const newEmail = document.getElementById('m-new-involucrado').value.trim().toLowerCase();
            if(!newEmail || !newEmail.includes('@')) return alert('Ingresa un correo válido.');
            
            document.getElementById('loading-overlay').style.display = 'flex';
            let currentInv = selectedDocData.involucrados || [];
            if(currentInv.includes(newEmail)) {
                document.getElementById('loading-overlay').style.display = 'none';
                return alert('Este correo ya está en la lista de involucrados.');
            }
            currentInv.push(newEmail);
            await updateDoc(doc(db, "artifacts", appId, "public", "data", "Solicitudes", selectedId), {
                involucrados: currentInv,
                chat: arrayUnion({u: currentUser.nombre, m: `👥 Añadió a ${newEmail} a los notificados.`, t: new Date().toLocaleString()})
            });
            document.getElementById('m-new-involucrado').value = '';
            document.getElementById('loading-overlay').style.display = 'none';
            verDetalle(selectedId); // Recargar modal
        };

        // Función de filtrado rápido en tablas
        window.filtrarTabla = (inputId, tbodyId) => {
            const input = document.getElementById(inputId);
            if (!input) return;
            const filter = input.value.toLowerCase();
            const tbody = document.getElementById(tbodyId);
            if (!tbody) return;
            const trs = tbody.getElementsByTagName('tr');
            for (let i = 0; i < trs.length; i++) {
                let rowText = trs[i].textContent || trs[i].innerText;
                trs[i].style.display = rowText.toLowerCase().indexOf(filter) > -1 ? "" : "none";
            }
        };

        // Alternar menú lateral en móvil
        window.toggleMenu = () => {
            document.getElementById('sidebar').classList.toggle('open');
            document.getElementById('sidebar-overlay').classList.toggle('active');
        };

        // --- Funciones del Dashboard ---
        
        // Aplica el filtro de fechas al dashboard
        window.aplicarFiltroFechasDash = () => {
            const fFrom = document.getElementById('dash-date-from').value;
            const fTo = document.getElementById('dash-date-to').value;
            if(!fFrom || !fTo) return alert("Selecciona ambas fechas (Desde y Hasta).");
            if(fFrom > fTo) return alert("La fecha 'Desde' no puede ser mayor a 'Hasta'.");
            
            dashboardDateFilter = { 
                from: new Date(fFrom + "T00:00:00"), 
                to: new Date(fTo + "T23:59:59") 
            };
            // Forzar recarga de datos de solicitudes para aplicar el filtro
            cargarDatosSolicitudes(globalSolicitudes);
        };

        // Limpia el filtro de fechas
        window.limpiarFiltroFechasDash = () => {
            document.getElementById('dash-date-from').value = "";
            document.getElementById('dash-date-to').value = "";
            dashboardDateFilter = { from: null, to: null };
             // Forzar recarga sin filtros
            cargarDatosSolicitudes(globalSolicitudes);
        };

        // Maneja el clic en las tarjetas del dashboard para filtrar listas
        window.dashFilterClick = (filtroEstado) => {
            let targetSection = 'sec-hist';
            let targetNav = 'nav-hist';
            let targetSearchId = 'search-hist';
            const p = currentUser.permisos || {};

            // Si es gestor y el estado no es finalizado, llevar a bandeja de gestión
            if ((p.p_gest_sgc || p.p_ger_apr) && filtroEstado && filtroEstado !== 'APROBADO FINAL') {
                targetSection = 'sec-gest';
                targetNav = 'nav-gest';
                targetSearchId = 'search-gest';
            }

            cambiarVista(targetSection, document.getElementById(targetNav));
            const searchInput = document.getElementById(targetSearchId);
            searchInput.value = filtroEstado;
            // Disparar evento de teclado para filtrar
            searchInput.dispatchEvent(new KeyboardEvent('keyup')); 
        };

        // --- Exportación a Excel con KPIs ---
        window.exportarReporteSolicitudes = () => {
            if(globalSolicitudes.length === 0) { alert("No hay solicitudes para exportar."); return; }
            
            let dataExport = globalSolicitudes.map(s => {
                let estStr = (s.estado || '').toUpperCase();
                let estadoFormat = estStr.includes('APROBADO FINAL') ? 'APROBADO FINAL' : (estStr !== 'ANULADO' && estStr !== 'RECHAZADO' ? `${s.estado} (Etapa: ${PASOS_NOMBRES[s.idx] || ''})` : s.estado);
                let tf = s.tiempos_fases || {};

                // Cálculos de Tiempos (KPIs)
                let tE1 = calcularDiferenciaTiempo(tf.creacion, tf.entrada_etapa_2); // Tiempo en Etapa 1 (hasta entrar a 2)
                let tE2 = calcularDiferenciaTiempo(tf.entrada_etapa_2, tf.entrada_etapa_3); // Tiempo en Etapa 2
                let tE3 = calcularDiferenciaTiempo(tf.entrada_etapa_3, tf.entrada_etapa_4); // Tiempo en Etapa 3
                let tE4 = calcularDiferenciaTiempo(tf.entrada_etapa_4, tf.finalizacion); // Tiempo en Etapa 4 (hasta fin)
                let tTotal = calcularDiferenciaTiempo(tf.creacion, tf.finalizacion); // Tiempo de Ciclo Total

                return {
                    "ID Solicitud": s.customId || '',
                    "Título": s.titulo || '',
                    "Solicitante": s.solicitante || '',
                    "Gerencia": s.gerencia || '',
                    "Departamento": s.departamento || '',
                    "Tipo Doc.": s.tipoDoc || '',
                    "Acción": s.accion || '',
                    "Estado Actual": estadoFormat,
                    "Fecha Creación": s.fecha ? new Date(s.fecha).toLocaleString() : '',
                    "Fecha Finalización": s.fecha_final ? new Date(s.fecha_final).toLocaleString() : (tf.finalizacion ? new Date(tf.finalizacion).toLocaleString() : ''),
                    "Cód. Final": s.codigo_final || '',
                    "Ver. Final": s.version_final || '',
                    // Columnas de KPIs de Tiempo (Horas decimales para cálculos)
                    "Hrs. en E1 (Doc.)": tE1.horas,
                    "Hrs. en E2 (Verif. SGC)": tE2.horas,
                    "Hrs. en E3 (Aprob. Ger.)": tE3.horas,
                    "Hrs. en E4 (Final SGC)": tE4.horas,
                    "Hrs. Totales Ciclo": tTotal.horas,
                    // Columnas de Texto legible
                    "Tiempo E1 Texto": tE1.texto,
                    "Tiempo E2 Texto": tE2.texto,
                    "Tiempo E3 Texto": tE3.texto,
                    "Tiempo E4 Texto": tE4.texto,
                     "Tiempo Total Texto": tTotal.texto
                }
            });

            let wb = XLSX.utils.book_new();
            let ws = XLSX.utils.json_to_sheet(dataExport);
            // Ajuste de ancho de columnas básico
            const wscols = Object.keys(dataExport[0]).map(k => ({wch: k.length + 5}));
            ws['!cols'] = wscols;
            XLSX.utils.book_append_sheet(wb, ws, "Reporte y KPIs SGC");
            XLSX.writeFile(wb, "Reporte_Solicitudes_KPIs.xlsx");
        };

        // --- Funciones de Backend (Firebase/Cloudinary) ---
        
        // Obtiene correos para notificaciones
        async function getDatosEnvio(solicitudData) {
            let managerEmail = "";
            if(solicitudData.gerencia) {
                try {
                    const q = query(collection(db, "artifacts", appId, "public", "data", "Usuarios"), where("gerencia", "==", solicitudData.gerencia), where("permisos.p_ger_apr", "==", true));
                    const snap = await getDocs(q);
                    if(!snap.empty) managerEmail = snap.docs[0].data().email || "";
                } catch(e) { console.error("Error buscando gerente", e); }
            }
            const toEmails = new Set([EMAIL_ADMIN_SGC, EMAIL_GRUPO_SGC, solicitudData.solicitante_email]);
            if(solicitudData.involucrados && Array.isArray(solicitudData.involucrados)) {
                solicitudData.involucrados.forEach(e => { if(e && e.includes('@')) toEmails.add(e); });
            }
            const toList = Array.from(toEmails).join(',');
            return { to: toList, cc: managerEmail };
        }

        // Envía correo vía EmailJS
        function sendNotification(destinatarios, title, message) {
            if(!destinatarios.to) return;
            const templateParams = {
                title: title, name: "Sistema SGC", message: message,   
                to_email: destinatarios.to, cc_email: destinatarios.cc,   
                time: new Date().toLocaleString()
            };
            // emailjs.send(EMAIL_SERVICE_ID, EMAIL_TEMPLATE_ID, templateParams).catch(err => console.log('ERROR EMAIL', err));
            console.log("Simulación Envío Correo:", templateParams); // Simulación para desarrollo
        }

        // Autenticación Anónima Inicial
        const initAuth = async () => {
            try {
                await signInAnonymously(auth);
                const savedUser = localStorage.getItem('sgc_session_user');
                if(savedUser) {
                    const q = query(collection(db, "artifacts", appId, "public", "data", "Usuarios"), where("usuario", "==", savedUser));
                    const snap = await getDocs(q);
                    if(!snap.empty) {
                        currentUser = snap.docs[0].data();
                        setupUI();
                    }
                }
            } catch (e) { console.error("Auth Error", e); }
             document.getElementById('loading-overlay').style.display = 'none';
        };
        initAuth();

        // Subida de archivos a Cloudinary
        async function uploadToCloudinary(file) {
            if(!file) return null;
            const fd = new FormData(); 
            fd.append('file', file); fd.append('upload_preset', UPLOAD_PRESET);
            let fileName = file.name || "documento";
            let baseName = fileName.includes('.') ? fileName.substring(0, fileName.lastIndexOf('.')) : fileName;
            let cleanName = baseName.normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/[^a-zA-Z0-9\-_]/g, '_').replace(/_+/g, '_');
            if(!cleanName) cleanName = 'doc';
            fd.append('public_id', cleanName + '_' + Date.now().toString().slice(-4)); 
            try {
                const res = await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/upload`, { method: 'POST', body: fd });
                const data = await res.json();
                if (!res.ok) { console.error("Cloudinary Error:", data); return null; }
                return data.secure_url || null; 
            } catch(e) { console.error("Network Error Cloudinary:", e); return null; }
        }

        // Genera URL de descarga forzada
        function getDownloadUrl(cloudUrl) {
            if(!cloudUrl || !cloudUrl.includes('/upload/')) return cloudUrl || "#";
            let urlLimpia = cloudUrl.replace(/\/fl_attachment:[^/]+\//, '/').replace(/\/fl_attachment\//, '/');
            return urlLimpia.replace('/upload/', `/upload/fl_attachment/`);
        }

        // Obtiene siguiente ID correlativo
        async function getNextFCI() {
            const ref = doc(db, "artifacts", appId, "public", "data", "Contadores", "solicitudes");
            let id = "";
            await runTransaction(db, async (t) => {
                const snap = await t.get(ref);
                let count = 1;
                if (snap.exists()) count = snap.data().count + 1;
                t.set(ref, { count });
                id = `FCI-SOL-${String(count).padStart(4, '0')}`;
            });
            return id;
        }

        // Login
        document.getElementById('btnLogin').onclick = async () => {
            document.getElementById('loading-overlay').style.display = 'flex';
            const u = document.getElementById('login-user').value.toLowerCase().trim();
            const p = document.getElementById('login-pass').value.trim();

            // Creación automática de usuario admin inicial si no existe
            if(u === 'admin.sgc' && p === 'fci123.') {
                const adminRef = doc(db, "artifacts", appId, "public", "data", "Usuarios", "admin.sgc");
                const snap = await getDoc(adminRef);
                if(!snap.exists()) {
                    await setDoc(adminRef, {
                        nombre: "Administrador SGC", usuario: "admin.sgc", pass: "fci123.", gerencia: "SGC", email: EMAIL_ADMIN_SGC,
                        permisos: { can_solicit:true, p_gest_sgc:true, p_ger_apr:true, p_ver_propias:true, p_ver_ger:true, p_ver_all:true, p_users:true, p_struct:true, p_ver_listado:true, admin:true }
                    });
                }
            }

            const q = query(collection(db, "artifacts", appId, "public", "data", "Usuarios"), where("usuario", "==", u), where("pass", "==", p));
            const snap = await getDocs(q);
            document.getElementById('loading-overlay').style.display = 'none';
            
            if(!snap.empty) {
                localStorage.setItem('sgc_session_user', u);
                currentUser = snap.docs[0].data();
                setupUI();
            } else { alert("Credenciales incorrectas."); }
        };

        // Logout
        window.logout = () => {
            if(confirm("¿Cerrar sesión?")) {
                localStorage.removeItem('sgc_session_user');
                location.reload();
            }
        };

        // Configura la interfaz según permisos
        function setupUI() {
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('sidebar').style.display = 'flex';
            document.getElementById('main').style.display = 'block';
            document.getElementById('curr-name').innerText = currentUser.nombre;
            document.getElementById('curr-ger').innerText = currentUser.gerencia || "Sin Área";

            const p = currentUser.permisos || {};
            // Visibilidad de navegación
            if(p.can_solicit) document.getElementById('nav-crear').classList.add('visible');
            if(p.p_ver_propias || p.p_ver_ger || p.p_ver_all) document.getElementById('nav-hist').classList.add('visible');
            if(p.p_gest_sgc || p.p_ger_apr) document.getElementById('nav-gest').classList.add('visible');
            if(p.p_ver_listado || p.admin || p.p_gest_sgc) document.getElementById('nav-listado').classList.add('visible');
            if(p.p_users || p.p_struct) document.getElementById('admin-only').style.display = 'block';
            if(p.p_users) document.getElementById('nav-users').classList.add('visible');
            if(p.p_struct) document.getElementById('nav-struct').classList.add('visible');
            
            // Botones de acción admin en listado maestro
            const isGestorMaestro = p.p_gest_sgc || p.admin;
            document.getElementById('btn-nuevo-maestro').style.display = isGestorMaestro ? 'inline-flex' : 'none'; 
            document.getElementById('btn-import-maestro').style.display = isGestorMaestro ? 'inline-flex' : 'none'; 
            
            // Botones de exportación (Solo Admin Total)
            const isSuperAdmin = p.admin === true;
            document.getElementById('btn-export-hist').style.display = isSuperAdmin ? 'inline-flex' : 'none';
            document.getElementById('btn-export-gest').style.display = isSuperAdmin ? 'inline-flex' : 'none';
            document.getElementById('btn-export-list').style.display = isSuperAdmin ? 'inline-flex' : 'none';

            cargarDatosFirestore();

            // REDIRECCIÓN INICIAL INTELIGENTE: Si es gestor, va a la bandeja de gestión directamente.
            if (p.p_gest_sgc || p.p_ger_apr || p.admin) {
                 document.getElementById('nav-gest').click();
            } else {
                 document.getElementById('nav-dash').click();
            }
        }

        // Carga listeners de Firestore
        function cargarDatosFirestore() {
            const path = (c) => collection(db, "artifacts", appId, "public", "data", c);

            // Gerencias
            onSnapshot(path("Gerencias"), s => {
                let h = "<option value=''>-- Seleccionar --</option>", l = "";
                s.forEach(d => {
                    const g = d.data(); h += `<option value="${g.nombre}">${g.nombre}</option>`;
                    l += `<div class="settings-item"><span>${g.nombre}</span><button class="btn-icon-danger" onclick="del('Gerencias','${d.id}')"><span class="material-icons-round" style="font-size:16px;">delete</span></button></div>`;
                });
                ['sol-ger','lm-gerencia','u-ger-sel','d-ger-sel'].forEach(id => { if(document.getElementById(id)) document.getElementById(id).innerHTML = h; });
                document.getElementById('list-ger').innerHTML = l;
                if(document.getElementById('sol-ger').value) document.getElementById('sol-ger').dispatchEvent(new Event('change'));
            });

            // Departamentos
            onSnapshot(path("Departamentos"), s => {
                let l = ""; allDepartamentos = [];
                s.forEach(d => {
                    const dep = d.data(); dep.docId = d.id; allDepartamentos.push(dep);
                    l += `<div class="settings-item"><span>${dep.nombre} <small class="text-muted">(${dep.gerencia})</small></span><button class="btn-icon-danger" onclick="del('Departamentos','${d.id}')"><span class="material-icons-round" style="font-size:16px;">delete</span></button></div>`;
                });
                document.getElementById('list-dep').innerHTML = l;
                if(document.getElementById('sol-ger').value) document.getElementById('sol-ger').dispatchEvent(new Event('change'));
            });

            // Usuarios
            onSnapshot(path("Usuarios"), s => {
                const tb = document.getElementById('tbody-users'); if(!tb) return; tb.innerHTML = ""; allUsers = []; 
                s.forEach(d => {
                    const u = d.data(); u.docId = d.id; allUsers.push(u); 
                    tb.innerHTML += `<tr><td><b>${u.nombre}</b><br><span style="font-size:11px;color:var(--text-light)">${u.usuario}</span></td><td>${u.email || '-'}</td><td>${u.gerencia}<br><span class="badge badge-info">${u.role || 'N/A'}</span></td><td><div style="display:flex;gap:5px;"><button class="btn btn-info" style="padding:6px;" onclick="cargarUsuarioParaEditar('${u.usuario}')"><span class="material-icons-round" style="font-size:14px;">edit</span></button><button class="btn btn-danger" style="padding:6px;" onclick="del('Usuarios','${u.docId}')"><span class="material-icons-round" style="font-size:14px;">delete</span></button></div></td></tr>`;
                });
            });

            // Configuración Maestro
            onSnapshot(doc(db, "artifacts", appId, "public", "data", "Configuracion", "MaestroSettings"), d => {
                if(d.exists()) { columnasMaestro = d.data().columnas || []; estatusMaestro = d.data().estatus || []; }
                renderListasConfig(); renderTablaMaestro();
            });

            // Solicitudes (Principal)
            onSnapshot(path("Solicitudes"), s => {
                let solicitudesList = [];
                s.forEach(d => { let data = d.data(); data.docId = d.id; solicitudesList.push(data); });
                solicitudesList.sort((a, b) => (b.customId > a.customId ? 1 : -1)); // Orden descendente
                globalSolicitudes = solicitudesList; 
                cargarDatosSolicitudes(solicitudesList);
            });

            // Listado Maestro
            onSnapshot(path("ListadoMaestro"), s => {
                dataMaestro = []; s.forEach(d => { let data = d.data(); data.docId = d.id; dataMaestro.push(data); });
                renderTablaMaestro();
            });
        }

        // Procesa y renderiza las solicitudes en tablas y dashboard
        function cargarDatosSolicitudes(listaSolicitudes) {
            const tbHist = document.getElementById('tbody-historial');
            const tbGest = document.getElementById('tbody-gestionar');
            tbHist.innerHTML = ""; tbGest.innerHTML = "";
            
            let stats = { total:0, p1:0, p2:0, p3:0, p4:0, ok:0 };
            const p = currentUser.permisos || {};

            listaSolicitudes.forEach(sol => {
                // Filtro de fechas del dashboard
                if(dashboardDateFilter.from && dashboardDateFilter.to) {
                    const solDate = new Date(sol.fecha);
                    if(solDate < dashboardDateFilter.from || solDate > dashboardDateFilter.to) return; 
                }

                let estadoStr = (sol.estado || "").toUpperCase();
                let isAprobadoFinal = estadoStr.includes('APROBADO FINAL');
                let isActive = !isAprobadoFinal && estadoStr !== 'ANULADO' && estadoStr !== 'RECHAZADO';

                // Conteo de estadísticas para el dashboard
                stats.total++;
                if (isAprobadoFinal) stats.ok++;
                else if (isActive) {
                    if(sol.idx === 0) stats.p1++;
                    else if(sol.idx === 1) stats.p2++;
                    else if(sol.idx === 2) stats.p3++;
                    else if(sol.idx === 3) stats.p4++;
                }

                // Renderizado de Tabla "Mis Solicitudes"
                let ver = p.p_ver_all || (p.p_ver_ger && sol.gerencia === currentUser.gerencia) || (p.p_ver_propias && sol.uid === currentUser.usuario);
                if(ver) {
                    let badgeClass = isAprobadoFinal ? 'badge-success' : (estadoStr==='ANULADO'||estadoStr==='RECHAZADO' ? 'badge-danger' : 'badge-warning');
                    let estadoMostrar = isAprobadoFinal ? "APROBADO FINAL" : sol.estado;
                    let faseInfo = (isActive && PASOS_NOMBRES[sol.idx]) ? `<br><small style="opacity:0.8">Etapa: ${PASOS_NOMBRES[sol.idx]}</small>` : "";
                    
                    tbHist.innerHTML += `<tr><td><b>${sol.customId}</b><br><small class="text-muted">${formatearFechaAbreviada(sol.fecha)}</small></td><td>${sol.titulo}</td><td>${sol.gerencia}</td><td><span class="badge ${badgeClass}">${estadoMostrar}</span>${faseInfo}</td><td style="text-align:center;"><button class="btn btn-ghost" onclick="verDetalle('${sol.docId}')" style="padding:6px 12px;"><span class="material-icons-round" style="font-size:18px;">visibility</span></button></td></tr>`;
                }
                
                // Renderizado de Tabla "Bandeja de Gestión"
                let gestionar = false;
                if(isActive) {
                    if(p.p_gest_sgc && (sol.idx === 0 || sol.idx === 1 || sol.idx === 3)) gestionar = true; // SGC en etapas 1, 2, 4
                    if(p.p_ger_apr && sol.idx === 2 && sol.gerencia === currentUser.gerencia) gestionar = true; // Gerente en etapa 3
                }

                if(gestionar) {
                    let badgeClass = 'badge-warning';
                    tbGest.innerHTML += `<tr><td><b>${sol.customId}</b></td><td>${sol.solicitante}<br><small class="text-muted">${sol.gerencia}</small></td><td>${sol.titulo}</td><td><span class="badge ${badgeClass}">${sol.estado}</span><br><small style="font-weight:600;">Etapa: ${PASOS_NOMBRES[sol.idx]}</small></td><td style="text-align:center;"><button class="btn btn-primary" onclick="verDetalle('${sol.docId}')" style="padding:8px 15px; font-size:12px;">GESTIONAR</button></td></tr>`;
                }
            });
            
            // Actualizar contadores del dashboard
            document.getElementById('d-total').innerText = stats.total;
            document.getElementById('d-p1').innerText = stats.p1;
            document.getElementById('d-p2').innerText = stats.p2;
            document.getElementById('d-p3').innerText = stats.p3;
            document.getElementById('d-p4').innerText = stats.p4;
            document.getElementById('d-ok').innerText = stats.ok;
        }

        // --- Funciones de Configuración (Estructura y Maestro) ---
        window.renderListasConfig = () => {
            let hCol = "", hEst = "";
            columnasMaestro.forEach((c, idx) => { hCol += `<div class="settings-item"><span>${c}</span><button class="btn-icon-danger" onclick="eliminarColumna(${idx})"><span class="material-icons-round" style="font-size:16px;">delete</span></button></div>`; });
            estatusMaestro.forEach((e, idx) => { hEst += `<div class="settings-item"><span>${e}</span><button class="btn-icon-danger" onclick="eliminarEstatus(${idx})"><span class="material-icons-round" style="font-size:16px;">delete</span></button></div>`; });
            document.getElementById('list-columnas').innerHTML = hCol;
            document.getElementById('list-estatus').innerHTML = hEst;
        }
        window.agregarColumna = async () => { let v = document.getElementById('col-nom').value.trim(); if(!v || columnasMaestro.includes(v)) return; columnasMaestro.push(v); await updateConfigMaestro(); document.getElementById('col-nom').value=""; }
        window.eliminarColumna = async (idx) => { if(confirm("¿Eliminar columna?")) { columnasMaestro.splice(idx, 1); await updateConfigMaestro(); }}
        window.agregarEstatus = async () => { let v = document.getElementById('est-nom').value.trim(); if(!v || estatusMaestro.includes(v)) return; estatusMaestro.push(v); await updateConfigMaestro(); document.getElementById('est-nom').value=""; }
        window.eliminarEstatus = async (idx) => { if(confirm("¿Eliminar estatus?")) { estatusMaestro.splice(idx, 1); await updateConfigMaestro(); }}
        async function updateConfigMaestro() { await setDoc(doc(db, "artifacts", appId, "public", "data", "Configuracion", "MaestroSettings"), { columnas: columnasMaestro, estatus: estatusMaestro }, {merge: true}); }

        window.renderTablaMaestro = () => {
            const th = document.getElementById("thead-listado-maestro"), tb = document.getElementById("tbody-listado-maestro"); if(!th || !tb) return;
            let hh = "<tr>"; columnasMaestro.forEach(c => { hh += `<th>${c}</th>`; }); 
            if(currentUser?.permisos?.p_gest_sgc || currentUser?.permisos?.admin) hh += `<th class="no-export text-center">Acciones</th>`; hh += "</tr>"; th.innerHTML = hh;
            tb.innerHTML = "";
            let dataSort = [...dataMaestro]; if(columnasMaestro.length > 0) dataSort.sort((a,b) => (a[columnasMaestro[0]]||"").toString().localeCompare((b[columnasMaestro[0]]||"").toString()));
            dataSort.forEach(item => {
                let rh = "<tr>";
                columnasMaestro.forEach(col => {
                    let val = item[col] || "";
                    if(val.toString().startsWith("http")) {
                        let fName = item['Nombre del documento'] || "Documento"; let dUrl = getDownloadUrl(val);
                        rh += `<td><a href="${dUrl}" target="_blank" class="file-link" download="${fName}"><span class="material-icons-round" style="font-size:16px;">cloud_download</span> Descargar</a></td>`;
                    } else if(col.toLowerCase().includes('estatus')) {
                         let bc = val.toLowerCase().includes('vigente') ? 'badge-success' : (val.toLowerCase().includes('obsoleto') ? 'badge-danger' : 'badge-warning');
                         rh += `<td><span class="badge ${bc}">${val}</span></td>`;
                    } else if(col.toLowerCase().includes('fecha')) { rh += `<td>${formatearFechaAbreviada(val)}</td>`;
                    } else { rh += `<td>${val}</td>`; }
                });
                if(currentUser?.permisos?.p_gest_sgc || currentUser?.permisos?.admin) {
                    rh += `<td class="no-export text-center"><div style="display:flex;justify-content:center;gap:5px;"><button class="btn btn-info" style="padding:6px;" onclick="abrirModalListadoMaestro('${item.docId}')"><span class="material-icons-round" style="font-size:14px;">edit</span></button><button class="btn btn-danger" style="padding:6px;" onclick="del('ListadoMaestro','${item.docId}')"><span class="material-icons-round" style="font-size:14px;">delete</span></button></div></td>`;
                }
                rh += "</tr>"; tb.innerHTML += rh;
            });
        };

        // --- Funciones del Modal de Detalle y Gestión ---
        
        // Abre el modal principal con los detalles de la solicitud
        window.verDetalle = async (id) => {
            selectedId = id;
            document.getElementById('loading-overlay').style.display = 'flex';
            const docSnap = await getDoc(doc(db, "artifacts", appId, "public", "data", "Solicitudes", id));
            selectedDocData = docSnap.data();
            const s = selectedDocData;
            const p = currentUser.permisos;
            
            // Reset de UI del modal
            ['m-panel-final-sgc','m-panel-update-sgc','m-display-final','m-actions','applicant-actions','m-input-area','m-extra-panel'].forEach(id => document.getElementById(id).style.display = 'none');
            document.getElementById('m-original-data').classList.remove('locked-data');
            document.getElementById('m-orig-title').style.display = 'none';
            document.getElementById('general-comment-area').style.display = 'block';
            quillGestion.setText(''); quillComentario.setText('');

            // Datos básicos de cabecera
            document.getElementById('m-id').innerText = s.customId;
            document.getElementById('m-tit').innerText = s.titulo;
            
            let estadoStr = (s.estado || "").toUpperCase();
            let isAprobadoFinal = estadoStr.includes('APROBADO FINAL');
            let isActive = !isAprobadoFinal && estadoStr !== 'ANULADO' && estadoStr !== 'RECHAZADO';

            // Badge de Estado
            let badgeClass = 'badge-info';
            if(estadoStr.includes('APROBADO')) badgeClass = 'badge-success';
            if(estadoStr === 'ANULADO' || estadoStr === 'RECHAZADO') badgeClass = 'badge-danger';
            if(estadoStr.includes('PENDIENTE')) badgeClass = 'badge-warning';
            document.getElementById('m-est').className = `badge ${badgeClass}`;
            document.getElementById('m-est').innerText = isAprobadoFinal ? "APROBADO FINAL" : s.estado;

            // Steps visuales
            for(let i=1; i<=4; i++) {
                const st = document.getElementById('s'+i); st.className = 'step'; 
                if(estadoStr === 'ANULADO' || estadoStr === 'RECHAZADO') continue;
                if(i <= s.idx) st.classList.add('completed'); 
                if(i === s.idx + 1 && isActive) st.classList.add('active');
            }

            // Datos del histórico
            document.getElementById('m-sol').innerText = s.solicitante;
            document.getElementById('m-ger').innerText = s.gerencia;
            document.getElementById('m-tipo').innerText = s.tipoDoc || "N/A"; 
            document.getElementById('m-accion').innerText = s.accion;
            document.getElementById('m-jus').innerHTML = s.motivo || "Sin justificación detallada."; // Usar innerHTML por Rich Text

            let adjOrigName = s.adjunto_nombre || "Ver Archivo Adjunto";
            let dlUrl = getDownloadUrl(s.adjunto);
            document.getElementById('m-file-link').innerHTML = s.adjunto ? `<a href="${dlUrl}" target="_blank" class="file-link" download="${adjOrigName}"><span class="material-icons-round">attachment</span> ${adjOrigName}</a>` : "<span class='text-muted'>Sin adjunto inicial</span>";
            
            if(s.accion !== 'Creación') {
                document.getElementById('m-extra-panel').style.display = 'block';
                document.getElementById('m-cod').innerText = s.cod_ref || 'N/A';
                document.getElementById('m-ver').innerText = s.ver_ref || 'N/A';
                document.getElementById('m-fecha-ult').innerText = formatearFechaAbreviada(s.fecha_ref);
            }

            // Renderizado de Involucrados (Tags)
            const involucradosContainer = document.getElementById('m-involucrados-tags');
            involucradosContainer.innerHTML = '';
            if(s.involucrados && s.involucrados.length > 0) {
                s.involucrados.forEach(email => {
                    involucradosContainer.innerHTML += `<span class="badge badge-info" style="font-weight:500; letter-spacing:0; text-transform:none; padding: 6px 10px;"><span class="material-icons-round" style="font-size:14px; vertical-align:middle; margin-right:4px;">mail</span>${email}</span>`;
                });
            } else { involucradosContainer.innerHTML = '<span class="text-muted" style="font-size:13px;">No hay correos adicionales registrados.</span>'; }


            // --- LÓGICA DE PANELES SEGÚN ESTADO Y ROL ---
            const esSGC = p.p_gest_sgc;
            const esGer = p.p_ger_apr && s.gerencia === currentUser.gerencia;
            const esDuenio = s.uid === currentUser.usuario;

            // Botoneras de acción
            if(isActive) {
                 if((esSGC && (s.idx===0 || s.idx===1 || s.idx===3)) || (esGer && s.idx===2)) document.getElementById('m-actions').style.display = 'block';
                 if(esDuenio) document.getElementById('applicant-actions').style.display = 'block';
                 document.getElementById('btn-firma-next').innerHTML = `<span class="material-icons-round">check_circle</span> APROBAR ETAPA ${s.idx+1} Y AVANZAR`;
            }

            // Panel de Anulación
            document.getElementById('btn-anular').style.display = (isActive && (esSGC || esDuenio)) ? 'inline-flex' : 'none';
            if(estadoStr === 'ANULADO') document.getElementById('general-comment-area').style.display = 'none';

            // Panel SGC: Actualización en Etapa 2 (Pre-Gerencia)
            if (esSGC && s.idx === 1 && isActive) {
                document.getElementById('m-panel-update-sgc').style.display = 'block';
                document.getElementById('m-upd-tit').value = s.titulo || '';
                document.getElementById('m-upd-cod').value = s.cod_ref || '';
                document.getElementById('m-upd-ver').value = s.ver_ref || '';
            }
            
            // LÓGICA CRÍTICA: Mostrar Panel Final o Panel de Cierre
            // Si está aprobado final Y tiene los datos de cierre, mostrar panel de visualización.
            if (isAprobadoFinal && s.version_final && s.documento_final) {
                mostrarPanelDisplayFinal(s, p.admin);
            } 
            // Si está aprobado final PERO FALTAN datos (caso de migración o error), O si es SGC y está en la última etapa (3), mostrar panel de cierre.
            else if ((isAprobadoFinal || (esSGC && s.idx === 3)) && isActive) {
                 document.getElementById('m-panel-final-sgc').style.display = 'block';
                 if(s.cod_ref) document.getElementById('m-final-cod').value = s.cod_ref;
            }

            // Renderizar Chat (Bitácora)
            const cb = document.getElementById('chat-box');
            cb.innerHTML = s.chat ? s.chat.map(c => `
                <div class="chat-msg">
                    <b>${c.u}</b> <span class="text-muted" style="font-size:11px; float:right;">${c.t}</span>
                    <div style="margin-top:8px;">${c.m}</div>
                    ${c.archivo ? `<div style="margin-top:10px;"><a href="${getDownloadUrl(c.archivo)}" target="_blank" class="file-link download-link"><span class="material-icons-round">cloud_download</span> Ver Archivo Adjunto</a></div>` : ''}
                </div>
            `).join('') : '<p class="text-muted text-center">No hay eventos registrados.</p>';

            document.getElementById('loading-overlay').style.display = 'none';
            document.getElementById('modal').style.display = 'flex';
        };

        // Función auxiliar para mostrar el panel de documento finalizado
        function mostrarPanelDisplayFinal(s, isAdmin) {
            document.getElementById('m-original-data').classList.add('locked-data');
            document.getElementById('m-orig-title').style.display = 'flex';
            document.getElementById('m-display-final').style.display = 'block';
            
            document.getElementById('m-disp-cod').innerText = s.codigo_final || 'N/A';
            document.getElementById('m-disp-ver').innerText = s.version_final || 'N/A';
            document.getElementById('m-disp-fecha').innerText = formatearFechaAbreviada(s.fecha_final);
            document.getElementById('m-disp-com').innerText = s.comentario_final || "Sin observaciones de cierre.";
            
            let finName = s.documento_final_nombre || "Documento Oficial";
            let finUrl = getDownloadUrl(s.documento_final);
            document.getElementById('m-disp-file').innerHTML = s.documento_final ? `<a href="${finUrl}" target="_blank" class="file-link" style="font-size:15px; padding: 10px; background: white; border-radius: 8px; border: 1px solid var(--border); width: 100%; display: flex; gap: 10px;"><span class="material-icons-round" style="color:#166534;">picture_as_pdf</span> ${finName}</a>` : "N/A";

            // Edición de fecha final (Solo Admin)
            const btnEdit = document.getElementById('btn-edit-fecha-final');
            btnEdit.style.display = isAdmin ? 'inline-flex' : 'none';
            if(isAdmin) {
                btnEdit.onclick = () => {
                    document.getElementById('m-disp-fecha').style.display = 'none'; btnEdit.style.display = 'none';
                    document.getElementById('edit-fecha-final-container').style.display = 'block';
                    if(s.fecha_final) document.getElementById('in-edit-fecha-final').value = s.fecha_final.split('T')[0];
                };
                document.getElementById('btn-cancel-fecha-final').onclick = () => {
                    document.getElementById('m-disp-fecha').style.display = 'block'; btnEdit.style.display = 'inline-flex';
                    document.getElementById('edit-fecha-final-container').style.display = 'none';
                };
                document.getElementById('btn-save-fecha-final').onclick = async () => {
                    const nv = document.getElementById('in-edit-fecha-final').value; if(!nv) return;
                    document.getElementById('loading-overlay').style.display = 'flex';
                    // Actualiza solicitud
                    await updateDoc(doc(db, "artifacts", appId, "public", "data", "Solicitudes", selectedId), { fecha_final: nv });
                    // Intenta actualizar maestro si existe
                    if(s.codigo_final) {
                        const qM = query(collection(db, "artifacts", appId, "public", "data", "ListadoMaestro"), where("Código", "==", s.codigo_final));
                        const snapM = await getDocs(qM);
                        if(!snapM.empty) {
                            let colFech = columnasMaestro.find(c => c.toLowerCase().includes('fecha'));
                            if(colFech) await updateDoc(doc(db, "artifacts", appId, "public", "data", "ListadoMaestro", snapM.docs[0].id), { [colFech]: nv });
                        }
                    }
                    document.getElementById('loading-overlay').style.display = 'none';
                    document.getElementById('edit-fecha-final-container').style.display = 'none';
                    verDetalle(selectedId);
                };
            }
        }

        // --- Funciones de Acción en el Modal ---
        window.gestionar = (tipo) => {
            tempAction = tipo;
            document.getElementById('m-input-area').style.display = 'block';
            document.getElementById('m-input-title').innerText = `Realizar Acción: ${tipo}`;
            document.getElementById('reunion-container').style.display = tipo === 'Reunión' ? 'block' : 'none';
            quillGestion.setText('');
        };

        window.responderSolicitante = () => {
            tempAction = "Respuesta";
            document.getElementById('m-input-area').style.display = 'block';
            document.getElementById('m-input-title').innerText = "Enviar Respuesta o Corrección";
            document.getElementById('reunion-container').style.display = 'none';
             quillGestion.setText('');
        }
        window.rechazar = () => { gestioner('Rechazado'); };

        // Confirma acción de gestión (Consulta, Reunión, Rechazo, Respuesta)
        document.getElementById('btnConfirmAction').onclick = async () => {
            const txtHtml = quillGestion.root.innerHTML;
            const isDeltaEmpty = quillGestion.getContents().ops.length === 1 && typeof quillGestion.getContents().ops[0].insert === 'string' && quillGestion.getContents().ops[0].insert.trim() === '';
            
            if(isDeltaEmpty && tempAction !== 'Reunión') return alert("Escribe un mensaje de detalle.");

            document.getElementById('loading-overlay').style.display = 'flex';
            const f = document.getElementById('m-file-gestion');
            let fileUrl = null; if(f.files[0]) { fileUrl = await uploadToCloudinary(f.files[0]); if(!fileUrl) { document.getElementById('loading-overlay').style.display = 'none'; return alert("Error al subir adjunto."); }}
            
            let mensajeFinal = "", nEst = "";
            if (tempAction === "Respuesta") {
                mensajeFinal = `💬 <b>Respuesta del Solicitante:</b><br>${txtHtml}`; nEst = "Respuesta Recibida"; 
            } else {
                mensajeFinal = `⚠️ <b>Acción de Gestión (${tempAction}):</b><br>${txtHtml}`;
                if(tempAction === 'Reunión') {
                    const fr = document.getElementById('m-date-meeting').value; if(!fr) { document.getElementById('loading-overlay').style.display = 'none'; return alert("Selecciona fecha de reunión."); }
                    mensajeFinal += `<br>📅 <b>Fecha Propuesta:</b> ${new Date(fr).toLocaleString()}`;
                }
                nEst = tempAction === 'Rechazado' ? 'RECHAZADO' : `En ${tempAction}`;
            }

            let chatPayload = {u: currentUser.nombre, m: mensajeFinal, t: new Date().toLocaleString()};
            if (fileUrl) chatPayload.archivo = fileUrl;

            await updateDoc(doc(db, "artifacts", appId, "public", "data", "Solicitudes", selectedId), { estado: nEst, chat: arrayUnion(chatPayload) });
            const dest = await getDatosEnvio(selectedDocData);
            sendNotification(dest, `Actualización: ${selectedDocData.customId}`, `Nueva acción (${tempAction}) en la solicitud.`);

            document.getElementById('loading-overlay').style.display = 'none'; closeModal();
        };

        // Avanza de etapa (Firmar Paso)
        window.firmarPaso = async () => {
            if(!confirm("¿Confirmas que has revisado y apruebas avanzar a la siguiente etapa?")) return;
            document.getElementById('loading-overlay').style.display = 'flex';
            
            const s = selectedDocData; const nIdx = s.idx + 1;
            const nEst = nIdx < 4 ? PASOS_NOMBRES[nIdx] : "APROBADO FINAL PENDIENTE CIERRE"; // Estado intermedio si va a cierre
            const faseAprobada = PASOS_NOMBRES[s.idx]; 
            
            // Registrar timestamp de entrada a la nueva etapa
            let timeUpdate = {};
            if(nIdx < 4) timeUpdate[`tiempos_fases.entrada_etapa_${nIdx + 1}`] = new Date().toISOString();

            await updateDoc(doc(db, "artifacts", appId, "public", "data", "Solicitudes", selectedId), {
                idx: nIdx, estado: nEst,
                ...timeUpdate,
                chat: arrayUnion({u: currentUser.nombre, m: `✅ <b>FASE COMPLETADA:</b> ${faseAprobada}. Avanza a la siguiente etapa.`, t: new Date().toLocaleString()})
            });

            const dest = await getDatosEnvio(s);
            sendNotification(dest, `Avance de Etapa: ${s.customId}`, `La solicitud ha avanzado exitosamente a la etapa: ${nEst}.`);
            document.getElementById('loading-overlay').style.display = 'none'; closeModal();
        };

        // Guarda el cierre final y publica
        window.guardarCierreFinal = async () => {
            const cod = document.getElementById('m-final-cod').value.trim();
            const ver = document.getElementById('m-final-ver').value.trim();
            const fecha = document.getElementById('m-final-fecha').value;
            const f = document.getElementById('m-final-file');
            if(!cod || !ver || !fecha || !f.files[0]) return alert("Todos los campos del cierre técnico (Código, Versión, Fecha y Documento) son obligatorios.");
            
            if(!confirm("¿Publicar documento oficial? Esta acción es definitiva.")) return;
            document.getElementById('loading-overlay').style.display = 'flex';
            
            let fileUrl = await uploadToCloudinary(f.files[0]); if(!fileUrl) { document.getElementById('loading-overlay').style.display = 'none'; return alert("Error al subir el documento final."); }
            let com = document.getElementById('m-final-comentario').value.trim();

            // Actualiza Solicitud (Cierre y Timestamp Final)
            await updateDoc(doc(db, "artifacts", appId, "public", "data", "Solicitudes", selectedId), {
                estado: "APROBADO FINAL", idx: 4,
                codigo_final: cod, version_final: ver, fecha_final: fecha, comentario_final: com,
                documento_final: fileUrl, documento_final_nombre: f.files[0].name,
                'tiempos_fases.finalizacion': new Date().toISOString(),
                chat: arrayUnion({u: "SISTEMA SGC", m: `🏁 <b>PROCESO FINALIZADO.</b> Documento publicado oficialmente.<br>Código: ${cod}, Versión: ${ver}.`, t: new Date().toLocaleString(), archivo: fileUrl})
            });

            // Inserta en Listado Maestro
            let dm = { estatus: "Vigente", registrado_por: "Sistema (Cierre Automático)", fecha_registro: new Date().toISOString() };
            columnasMaestro.forEach(c => {
                let lc = c.toLowerCase();
                if(lc.includes('código')||lc==='codigo') dm[c] = cod;
                else if(lc.includes('gerencia')) dm[c] = selectedDocData.gerencia;
                else if(lc.includes('departamento')) dm[c] = selectedDocData.departamento;
                else if(lc.includes('tipo')) dm[c] = selectedDocData.tipoDoc;
                else if(lc.includes('nombre')||lc.includes('título')) dm[c] = selectedDocData.titulo;
                else if(lc.includes('vers')) dm[c] = ver;
                else if(lc.includes('ubicaci')||lc.includes('archivo')||lc.includes('link')) dm[c] = fileUrl;
                else if(lc.includes('fecha')) dm[c] = fecha;
            });
            await addDoc(collection(db, "artifacts", appId, "public", "data", "ListadoMaestro"), dm);

            const dest = await getDatosEnvio(selectedDocData);
            sendNotification(dest, `Documento Publicado: ${s.customId}`, `La solicitud ha sido finalizada y el documento oficial ya está disponible en el Listado Maestro.`);
            document.getElementById('loading-overlay').style.display = 'none'; closeModal();
        }

        // Anula la solicitud
        window.anularSolicitud = async () => {
            let motivo = prompt("Escribe el motivo de la anulación (Obligatorio):");
            if(!motivo || motivo.trim() === "") return alert("Se requiere un motivo para anular.");
            document.getElementById('loading-overlay').style.display = 'flex';
            await updateDoc(doc(db, "artifacts", appId, "public", "data", "Solicitudes", selectedId), {
                estado: "ANULADO",
                chat: arrayUnion({u: currentUser.nombre, m: `🚫 <b>SOLICITUD ANULADA.</b><br>Motivo: ${motivo}`, t: new Date().toLocaleString()})
            });
            const dest = await getDatosEnvio(selectedDocData);
            sendNotification(dest, `Cancelación: ${selectedDocData.customId}`, `La solicitud ha sido ANULADA por ${currentUser.nombre}. Motivo: ${motivo}`);
            document.getElementById('loading-overlay').style.display = 'none'; closeModal();
        }

        // Actualiza datos fase 2 (SGC)
        window.actualizarDatosSGC = async () => {
            const t = document.getElementById('m-upd-tit').value.trim();
            if(!t) return alert("El título es obligatorio.");
            document.getElementById('loading-overlay').style.display = 'flex';
            let upd = { titulo: t, cod_ref: document.getElementById('m-upd-cod').value, ver_ref: document.getElementById('m-upd-ver').value };
            let msj = `✏️ <b>Datos Actualizados por SGC:</b> Título: ${t}, Cód: ${upd.cod_ref}, Ver: ${upd.ver_ref}.`;
            const f = document.getElementById('m-upd-file');
            if(f.files[0]) {
                let url = await uploadToCloudinary(f.files[0]); if(!url) { document.getElementById('loading-overlay').style.display='none'; return alert("Error subiendo archivo."); }
                upd.adjunto = url; upd.adjunto_nombre = f.files[0].name; msj += ` (Archivo adjunto reemplazado).`;
            }
            await updateDoc(doc(db, "artifacts", appId, "public", "data", "Solicitudes", selectedId), { ...upd, chat: arrayUnion({u: currentUser.nombre, m: msj, t: new Date().toLocaleString()}) });
            document.getElementById('loading-overlay').style.display = 'none'; alert("Datos actualizados."); closeModal();
        }

        // Envía comentario libre a la bitácora
        window.enviarComentarioLibre = async () => {
            const txtHtml = quillComentario.root.innerHTML;
            const isDeltaEmpty = quillComentario.getContents().ops.length === 1 && typeof quillComentario.getContents().ops[0].insert === 'string' && quillComentario.getContents().ops[0].insert.trim() === '';
            const f = document.getElementById('m-file-comentario');
            if(isDeltaEmpty && !f.files[0]) return alert("Escribe un mensaje o adjunta un archivo.");
            
            document.getElementById('loading-overlay').style.display = 'flex';
            let fileUrl = null; if(f.files[0]) { fileUrl = await uploadToCloudinary(f.files[0]); if(!fileUrl) { document.getElementById('loading-overlay').style.display='none'; return alert("Error subiendo archivo."); }}
            
            let chatPayload = {u: currentUser.nombre, m: `💬 <b>Nota de Bitácora:</b><br>${txtHtml}`, t: new Date().toLocaleString()};
            if (fileUrl) chatPayload.archivo = fileUrl;
            await updateDoc(doc(db, "artifacts", appId, "public", "data", "Solicitudes", selectedId), { chat: arrayUnion(chatPayload) });
            
            // Notificar si es necesario (opcional, puede generar mucho spam)
            // const dest = await getDatosEnvio(selectedDocData); sendNotification(dest, `Nuevo Comentario: ${selectedDocData.customId}`, ...);

            quillComentario.setText(''); f.value = "";
            document.getElementById('loading-overlay').style.display = 'none'; closeModal();
        }

        // --- Funciones de Creación y Gestión General ---

        // Crear Nueva Solicitud
        document.getElementById('btnSendSol').onclick = async () => {
            const tit = document.getElementById('sol-tit').value.trim();
            const ger = document.getElementById('sol-ger').value;
            const motivoHtml = quillMotivo.root.innerHTML;
            const isMotivoEmpty = quillMotivo.getContents().ops.length === 1 && typeof quillMotivo.getContents().ops[0].insert === 'string' && quillMotivo.getContents().ops[0].insert.trim() === '';

            if(!tit || !ger || isMotivoEmpty) return alert("Título, Gerencia y Motivo son obligatorios.");

            document.getElementById('loading-overlay').style.display = 'flex';
            const f = document.getElementById('sol-file'); let url = null, fName = "";
            if(f.files[0]) { url = await uploadToCloudinary(f.files[0]); if(!url) { document.getElementById('loading-overlay').style.display='none'; return alert("Error subiendo archivo inicial."); } fName = f.files[0].name; }

            const extraEmails = Array.from(document.querySelectorAll('.extra-email')).map(e => e.value.trim().toLowerCase()).filter(e => e.includes('@'));
            const fci = await getNextFCI();
            const now Iso = new Date().toISOString();

            const data = {
                customId: fci, titulo: tit, accion: document.getElementById('sol-accion').value, tipoDoc: document.getElementById('sol-tipo-doc').value,
                gerencia: ger, departamento: document.getElementById('sol-dep').value, motivo: motivoHtml,
                cod_ref: document.getElementById('sol-cod-prev').value, ver_ref: document.getElementById('sol-ver-prev').value, fecha_ref: document.getElementById('sol-fecha-prev').value,
                solicitante: currentUser.nombre, solicitante_email: currentUser.email, uid: currentUser.usuario, involucrados: extraEmails,
                idx: 0, estado: "Pendiente Documentado", adjunto: url, adjunto_nombre: fName,
                fecha: nowIso,
                // Inicializar objeto de tiempos con la creación y entrada a etapa 1
                tiempos_fases: { creacion: nowIso, entrada_etapa_1: nowIso },
                chat: [{u: "SISTEMA", m: "✨ Solicitud creada exitosamente.", t: new Date().toLocaleString()}]
            };

            await addDoc(collection(db, "artifacts", appId, "public", "data", "Solicitudes"), data);
            document.getElementById('lista-involucrados').innerHTML = ""; quillMotivo.setText(''); document.getElementById('sol-tit').value="";
            
            const dest = await getDatosEnvio(data);
            sendNotification(dest, "Nueva Solicitud Creada", `Solicitud ${fci}: ${tit} creada para ${ger}.`);
            
            document.getElementById('loading-overlay').style.display = 'none';
            alert(`Solicitud ${fci} creada correctamente.`);
            document.getElementById('nav-hist').click();
        };

        // Listeners para selects de creación
        if(document.getElementById('sol-ger')) {
            document.getElementById('sol-ger').addEventListener('change', (e) => {
                const g = e.target.value;
                const mgr = allUsers.find(u => u.gerencia === g && u.permisos?.p_ger_apr);
                document.getElementById('sol-gerente-display').value = mgr ? mgr.nombre : "Sin Gerente Aprobador Asignado";
                document.getElementById('sol-email-gerente').value = mgr ? mgr.email : "";
                const ds = document.getElementById('sol-dep'); ds.innerHTML = "<option value=''>-- Seleccionar Depto --</option>";
                allDepartamentos.filter(d => d.gerencia === g).forEach(d => ds.innerHTML += `<option value="${d.nombre}">${d.nombre}</option>`);
            });
        }
        if(document.getElementById('u-ger-sel')) document.getElementById('u-ger-sel').addEventListener('change', (e) => { const g=e.target.value; const r=document.getElementById('u-rol'); if(g==='SGC') r.value='Especialista SGC'; else if(g) r.value='Colaborador'; });


        // Gestión de Usuarios
        document.getElementById('btnSaveUser').onclick = async () => {
            const u = document.getElementById('u-usr').value.toLowerCase().trim();
            const p = document.getElementById('u-pas').value;
            if(!u || !p) return alert("Usuario y Contraseña requeridos.");
            document.getElementById('loading-overlay').style.display = 'flex';
            const perms = { can_solicit: document.getElementById('p-solicitar').checked, p_ver_propias: document.getElementById('p-ver-propias').checked, p_ver_ger: document.getElementById('p-ver-ger').checked, p_gest_sgc: document.getElementById('p-gest-sgc').checked, p_ger_apr: document.getElementById('p-ger-apr').checked, p_users: document.getElementById('p-users').checked, p_struct: document.getElementById('p-struct').checked, p_ver_listado: document.getElementById('p-ver-listado').checked, admin: document.getElementById('p-admin').checked, p_ver_all: document.getElementById('p-admin').checked };
            await setDoc(doc(db, "artifacts", appId, "public", "data", "Usuarios", u), { nombre: document.getElementById('u-nom').value, usuario: u, pass: p, role: document.getElementById('u-rol').value, gerencia: document.getElementById('u-ger-sel').value, email: document.getElementById('u-email').value, permisos: perms }, {merge: true});
            document.getElementById('loading-overlay').style.display = 'none'; alert("Usuario Guardado."); resetUserForm();
        };

        // Funciones de Estructura
        document.getElementById('btnSaveGer').onclick = async () => { let v=document.getElementById('g-nom').value.trim(); if(v) await addDoc(collection(db, "artifacts", appId, "public", "data", "Gerencias"), {nombre:v}); document.getElementById('g-nom').value=""; };
        document.getElementById('btnSaveDep').onclick = async () => { let g=document.getElementById('d-ger-sel').value, v=document.getElementById('d-nom').value.trim(); if(g&&v) await addDoc(collection(db, "artifacts", appId, "public", "data", "Departamentos"), {nombre:v, gerencia:g}); document.getElementById('d-nom').value=""; };

        // Funciones del Modal Maestro
        window.abrirModalListadoMaestro = (id=null) => {
            editandoMaestroId = id; document.getElementById('lm-modal-title').innerText = id ? "Editar Registro" : "Nuevo Registro";
            const c = document.getElementById('dinamic-form-maestro'); c.innerHTML = "";
            let d = id ? dataMaestro.find(x => x.docId === id) || {} : {};
            columnasMaestro.forEach(col => {
                let val = d[col] || "", html = `<div><label>${col}</label>`;
                if(col.toLowerCase().includes('estatus')) { html += `<select id="in_dyn_${col}"><option value="">-Sel-</option>${estatusMaestro.map(e=>`<option value="${e}" ${val===e?'selected':''}>${e}</option>`).join('')}</select>`; }
                else if(col.toLowerCase().includes('fecha')) { html += `<input type="date" id="in_dyn_${col}" value="${val}">`; }
                else { html += `<input type="text" id="in_dyn_${col}" value="${val}">`; }
                c.innerHTML += html + "</div>";
            });
            document.getElementById('modal-form-listado').style.display = 'block';
        };
        window.guardarRegistroMaestro = async () => {
            document.getElementById('loading-overlay').style.display = 'flex';
            let data = {}; columnasMaestro.forEach(c => { let i=document.getElementById(`in_dyn_${c}`); if(i) data[c] = i.value; });
            if(editandoMaestroId) await updateDoc(doc(db, "artifacts", appId, "public", "data", "ListadoMaestro", editandoMaestroId), data);
            else { data.registrado_por = currentUser.nombre; data.fecha_registro = new Date().toISOString(); await addDoc(collection(db, "artifacts", appId, "public", "data", "ListadoMaestro"), data); }
            document.getElementById('loading-overlay').style.display = 'none'; document.getElementById('modal-form-listado').style.display = 'none';
        };
        window.subirArchivoGenericoLM = async () => {
            const f = document.getElementById('lm-generic-file').files[0]; if(!f) return alert("Selecciona archivo.");
            document.getElementById('loading-overlay').style.display = 'flex'; let url = await uploadToCloudinary(f); document.getElementById('loading-overlay').style.display = 'none'; if(!url) return alert("Error al subir.");
            const i = Array.from(document.querySelectorAll("#dinamic-form-maestro input")).find(el => el.id.toLowerCase().includes('ubicaci')||el.id.toLowerCase().includes('archivo')||el.id.toLowerCase().includes('link'));
            if(i) { i.value = url; alert("Enlace pegado automáticamente."); } else alert("Copia el enlace: " + url);
        };

        // Importación Excel Maestro
        if(document.getElementById('import-excel-file')) {
            document.getElementById('import-excel-file').addEventListener('change', async (e) => {
                const f = e.target.files[0]; if(!f) return; document.getElementById('loading-overlay').style.display = 'flex';
                const r = new FileReader(); r.onload = async (evt) => {
                    try {
                        const wb = XLSX.read(evt.target.result, {type:'array'}); const ws = wb.Sheets[wb.SheetNames[0]]; const json = XLSX.utils.sheet_to_json(ws, {defval:""});
                        if(json.length > 0) {
                            await setDoc(doc(db, "artifacts", appId, "public", "data", "Configuracion", "MaestroSettings"), { columnas: Object.keys(json[0]), estatus: estatusMaestro }, {merge: true});
                            for(let row of json) await addDoc(collection(db, "artifacts", appId, "public", "data", "ListadoMaestro"), { ...row, importado_por: currentUser.nombre, fecha_registro: new Date().toISOString() });
                            alert(`${json.length} registros importados.`);
                        }
                    } catch(err) { console.error(err); alert("Error leyendo Excel."); }
                    document.getElementById('loading-overlay').style.display = 'none'; e.target.value = '';
                }; r.readAsArrayBuffer(f);
            });
        }
        window.exportarExcelListado = () => {
            const t = document.getElementById("tabla-listado-maestro"); if(!t) return; const tc = t.cloneNode(true); tc.querySelectorAll('.no-export').forEach(e=>e.remove());
            XLSX.writeFile(XLSX.utils.table_to_book(tc, {sheet:"Listado Maestro"}), "Listado_Maestro_SGC.xlsx");
        };

        // --- Funciones Globales de UI ---
        window.cambiarVista = (id, btn) => {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
            document.getElementById(id).classList.add('active'); if(btn) btn.classList.add('active');
            if(window.innerWidth<=768) { document.getElementById('sidebar').classList.remove('open'); document.getElementById('sidebar-overlay').classList.remove('active'); }
        };
        window.toggleModPanel = v => document.getElementById('panel-mod').style.display = v==='Creación'?'none':'grid';
        window.closeModal = () => document.getElementById('modal').style.display = 'none';
        window.del = async (c, id) => { if(confirm("¿Eliminar registro?")) await deleteDoc(doc(db, "artifacts", appId, "public", "data", c, id)); };
        window.resetUserForm = () => {
             document.getElementById('u-usr').disabled=false; document.getElementById('u-usr').value=""; document.getElementById('u-nom').value=""; document.getElementById('u-pas').value="Fci2024."; document.getElementById('u-rol').value=""; document.getElementById('u-email').value=""; document.getElementById('u-ger-sel').value="";
             ['p-solicitar','p-ver-ger','p-gest-sgc','p-ger-apr','p-users','p-struct','p-ver-listado','p-admin'].forEach(id=>document.getElementById(id).checked=false); document.getElementById('p-ver-propias').checked=true;
             document.getElementById('btnSaveUser').innerText="GUARDAR USUARIO"; document.getElementById('btnCancelEdit').style.display="none"; document.getElementById('user-form-title').innerText="Registrar Nuevo / Editar Existente";
        };
        window.cargarUsuarioParaEditar = (uid) => {
             const u = allUsers.find(x=>x.usuario===uid); if(!u) return;
             document.getElementById('u-usr').value=u.usuario; document.getElementById('u-usr').disabled=true; document.getElementById('u-nom').value=u.nombre; document.getElementById('u-pas').value=u.pass; document.getElementById('u-rol').value=u.role||""; document.getElementById('u-email').value=u.email||""; document.getElementById('u-ger-sel').value=u.gerencia||"";
             const p=u.permisos||{}; ['p-solicitar','p-ver-propias','p-ver-ger','p-gest-sgc','p-ger-apr','p-users','p-struct','p-ver-listado','p-admin'].forEach(id=>document.getElementById(id).checked=p[id.replace(/-/g,'_')]||(id==='p-admin'?p.admin:false));
             document.getElementById('btnSaveUser').innerText="ACTUALIZAR USUARIO"; document.getElementById('btnCancelEdit').style.display="inline-flex"; document.getElementById('user-form-title').innerText=`Editando: ${u.usuario}`;
             window.scrollTo({top:0, behavior:'smooth'});
        };
    </script>
</body>
</html>
