<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>FCI | Sistema de GestiÃ³n Documental</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

<!-- EmailJS -->
<script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>

<style>
body{font-family:Arial;background:#f3f4f6;margin:0;padding:0}
header{background:#111827;color:#fff;padding:15px}
.card{background:#fff;padding:15px;margin:15px;border-radius:8px}
input,select,textarea,button{width:100%;margin-top:8px;padding:8px;border-radius:4px}
button{background:#2563eb;color:#fff;border:none;cursor:pointer}
table{width:100%;border-collapse:collapse}
td,th{border:1px solid #ccc;padding:6px;text-align:left}
.hidden{display:none}
h3{margin-top:0;}
.modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);display:none;justify-content:center;align-items:center}
.modal-content{background:#fff;padding:20px;border-radius:8px;width:90%;max-width:600px;position:relative;}
.modal-content button{width:auto;margin-top:10px;}
</style>
</head>
<body>

<header>
<h2>ðŸ“„ FCI â€“ Sistema de Solicitudes Documentales</h2>
</header>

<!-- LOGIN -->
<section id="loginPanel" class="card">
<h3>ðŸ”‘ Login</h3>
<input id="loginUsuario" placeholder="Usuario">
<input type="password" id="loginPassword" placeholder="ContraseÃ±a">
<button onclick="login()">Ingresar</button>
<p id="loginError" style="color:red;"></p>
</section>

<!-- PANEL PRINCIPAL -->
<section id="mainPanel" class="hidden">

<div class="card">
<h3>âž• Nueva Solicitud</h3>

<select id="tipoAccion">
<option>CreaciÃ³n</option>
<option>ModificaciÃ³n</option>
<option>InactivaciÃ³n</option>
</select>

<input id="nombreDocumento" placeholder="Nombre documento">
<select id="selectGerencia"></select>
<select id="selectDepartamento"></select>
<textarea id="motivo" placeholder="Motivo"></textarea>

<input id="codificacion" placeholder="CodificaciÃ³n actual">
<input id="ultimaVersion" placeholder="Ãšltima versiÃ³n">
<input type="date" id="fechaUltimaVersion">

<input type="file" id="archivo">
<button onclick="crearSolicitud()">Enviar Solicitud</button>
</div>

<div class="card">
<h3>ðŸ“‹ Solicitudes</h3>
<table>
<thead>
<tr>
<th>ID</th>
<th>Documento</th>
<th>Estado</th>
<th>AcciÃ³n</th>
</tr>
</thead>
<tbody id="tablaSolicitudes"></tbody>
</table>
</div>

<div class="card" id="adminPanel" class="hidden">
<h3>ðŸ‘¥ Panel de AdministraciÃ³n</h3>

<h4>Usuarios</h4>
<input id="nuevoUsuario" placeholder="Usuario">
<input id="nuevoCorreo" placeholder="Correo">
<input type="password" id="nuevoPassword" placeholder="ContraseÃ±a">
<select id="rolUsuario">
<option value="admin">Admin</option>
<option value="gerente">Gerente</option>
<option value="usuario">Usuario</option>
</select>
<select id="rolGerencia"></select>
<button onclick="crearUsuario()">Agregar Usuario</button>
<ul id="listaUsuarios"></ul>

<h4>Gerencias</h4>
<input id="nuevaGerencia" placeholder="Nombre Gerencia">
<button onclick="agregarGerencia()">Agregar Gerencia</button>
<ul id="listaGerencias"></ul>

<h4>Departamentos</h4>
<input id="nuevoDepartamento" placeholder="Nombre Departamento">
<button onclick="agregarDepartamento()">Agregar Departamento</button>
<ul id="listaDepartamentos"></ul>

</div>

<!-- Modal Detalles Solicitud -->
<div id="modalDetalles" class="modal">
  <div class="modal-content">
    <h3>Detalles de Solicitud</h3>
    <div id="detalleSolicitud"></div>
    <button onclick="cerrarModal()">Cerrar</button>
  </div>
</div>

<script>
// ================= CONFIG FIREBASE =================
const firebaseConfig = {
  apiKey: "AIzaSyDdzCiachuhbE9jATz-TesPI2vUVIJrHjM",
  authDomain: "sistemadegestion-7400d.firebaseapp.com",
  projectId: "sistemadegestion-7400d",
  storageBucket: "sistemadegestion-7400d.firebasestorage.app",
  messagingSenderId: "709030283072",
  appId: "1:709030283072:web:5997837b36a448e9515ca5"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// Inicializar EmailJS
emailjs.init("2jVnfkJKKG0bpKN-U");

// ================= VARIABLES =================
let usuarioActivo = null;

// ================= LOGIN =================
async function login(){
  const u = document.getElementById("loginUsuario").value;
  const p = document.getElementById("loginPassword").value;

  if(u==="Admin" && p==="123456"){
    usuarioActivo = { usuario:"Admin", rol:"admin", gerencia:"Todas" };
    abrirPanel();
    return;
  }

  const snap = await db.collection("usuarios").doc(u).get();
  if(snap.exists){
    const data = snap.data();
    if(data.password===p){
      usuarioActivo = data;
      abrirPanel();
    } else{
      document.getElementById("loginError").innerText="ContraseÃ±a incorrecta";
    }
  } else{
    document.getElementById("loginError").innerText="Usuario no encontrado";
  }
}

// ================= PANEL =================
function abrirPanel(){
  document.getElementById("loginPanel").classList.add("hidden");
  document.getElementById("mainPanel").classList.remove("hidden");

  if(usuarioActivo.rol==="admin") document.getElementById("adminPanel").classList.remove("hidden");

  cargarGerenciasDepartamentos();
  cargarUsuarios();
  cargarSolicitudes();
}

// ================= USUARIOS / GERENCIAS / DEPARTAMENTOS =================
async function crearUsuario(){
  const u=document.getElementById("nuevoUsuario").value;
  const c=document.getElementById("nuevoCorreo").value;
  const p=document.getElementById("nuevoPassword").value;
  const r=document.getElementById("rolUsuario").value;
  const g=document.getElementById("rolGerencia").value;
  if(!u||!c||!p) return alert("Completa todos los campos");
  await db.collection("usuarios").doc(u).set({usuario:u,correo:c,password:p,rol:r,gerencia:g});
  document.getElementById("nuevoUsuario").value="";
  document.getElementById("nuevoCorreo").value="";
  document.getElementById("nuevoPassword").value="";
  cargarUsuarios();
}

async function cargarUsuarios(){
  const snap = await db.collection("usuarios").get();
  const lista = document.getElementById("listaUsuarios");
  lista.innerHTML="";
  snap.forEach(d=>{
    const u=d.data();
    lista.innerHTML+=`<li>${u.usuario} (${u.rol} / ${u.gerencia}) <button onclick="eliminarUsuario('${u.usuario}')">Eliminar</button></li>`;
  });
}

async function eliminarUsuario(u){
  if(confirm("Eliminar usuario "+u+"?")) await db.collection("usuarios").doc(u).delete();
  cargarUsuarios();
}

// Gerencias
async function agregarGerencia(){
  const g=document.getElementById("nuevaGerencia").value;
  if(!g) return;
  await db.collection("gerencias").doc(g).set({nombre:g});
  document.getElementById("nuevaGerencia").value="";
  cargarGerenciasDepartamentos();
}

async function agregarDepartamento(){
  const d=document.getElementById("nuevoDepartamento").value;
  if(!d) return;
  await db.collection("departamentos").doc(d).set({nombre:d});
  document.getElementById("nuevoDepartamento").value="";
  cargarGerenciasDepartamentos();
}

// Cargar selects y listas
async function cargarGerenciasDepartamentos(){
  const gSnap=await db.collection("gerencias").get();
  const dSnap=await db.collection("departamentos").get();
  const selG=document.getElementById("selectGerencia");
  const selD=document.getElementById("selectDepartamento");
  const selGG=document.getElementById("rolGerencia");
  selG.innerHTML=""; selD.innerHTML=""; selGG.innerHTML="";
  const listaG=document.getElementById("listaGerencias"); listaG.innerHTML="";
  const listaD=document.getElementById("listaDepartamentos"); listaD.innerHTML="";
  gSnap.forEach(d=>{
    selG.innerHTML+=`<option>${d.data().nombre}</option>`;
    selGG.innerHTML+=`<option>${d.data().nombre}</option>`;
    listaG.innerHTML+=`<li>${d.data().nombre} <button onclick="eliminarGerencia('${d.data().nombre}')">Eliminar</button></li>`;
  });
  dSnap.forEach(d=>{
    selD.innerHTML+=`<option>${d.data().nombre}</option>`;
    listaD.innerHTML+=`<li>${d.data().nombre} <button onclick="eliminarDepartamento('${d.data().nombre}')">Eliminar</button></li>`;
  });
}

async function eliminarGerencia(g){if(confirm("Eliminar gerencia "+g+"?")){await db.collection("gerencias").doc(g).delete();cargarGerenciasDepartamentos();}}
async function eliminarDepartamento(d){if(confirm("Eliminar departamento "+d+"?")){await db.collection("departamentos").doc(d).delete();cargarGerenciasDepartamentos();}}

// ================= SOLICITUD =================

// Generar ID incremental
async function generarID(){
  const ref=db.collection("counters").doc("global");
  return db.runTransaction(async t=>{
    const doc=await t.get(ref);
    let n=doc.exists ? doc.data().solicitudes+1 : 1;
    t.set(ref,{solicitudes:n},{merge:true});
    return "FCI-SOL-"+String(n).padStart(4,"0");
  });
}

// Subir archivo a Cloudinary
async function subirArchivo(file){
  const form=new FormData();
  form.append("file",file);
  form.append("upload_preset","fci_documentos");
  const res=await fetch("https://api.cloudinary.com/v1_1/df79cjklp/auto/upload",{method:"POST",body:form});
  const data=await res.json();
  return data.secure_url;
}

// Crear solicitud
async function crearSolicitud(){
  const id=await generarID();
  let url="";
  const file=document.getElementById("archivo").files[0];
  if(file) url=await subirArchivo(file);

  const nuevaSolicitud={
    idSolicitud:id,
    tipoAccion:document.getElementById("tipoAccion").value,
    nombreDocumento:document.getElementById("nombreDocumento").value,
    gerencia:document.getElementById("selectGerencia").value,
    departamento:document.getElementById("selectDepartamento").value,
    motivo:document.getElementById("motivo").value,
    codificacionActual:document.getElementById("codificacion").value,
    ultimaVersion:document.getElementById("ultimaVersion").value,
    fechaUltimaVersion:document.getElementById("fechaUltimaVersion").value,
    documento:url||"",
    estado:"pendiente",
    solicitante:{usuario:usuarioActivo.usuario,correo:usuarioActivo.correo||""},
    fecha:firebase.firestore.FieldValue.serverTimestamp()
  };

  await db.collection("solicitudes").add(nuevaSolicitud);
  alert("Solicitud creada: "+id);
  cargarSolicitudes();
}

// Cargar solicitudes con botÃ³n de ver detalles
async function cargarSolicitudes(){
  const tabla=document.getElementById("tablaSolicitudes");
  tabla.innerHTML="";
  const snap=await db.collection("solicitudes").orderBy("fecha","desc").get();
  snap.forEach(d=>{
    const s=d.data();
    // Mostrar solo solicitudes del usuario si no es admin
    if(usuarioActivo.rol==="usuario" && s.solicitante.usuario!==usuarioActivo.usuario) return;
    if(usuarioActivo.rol==="gerente" && s.gerencia!==usuarioActivo.gerencia) return;

    tabla.innerHTML+=`<tr>
      <td>${s.idSolicitud}</td>
      <td>${s.nombreDocumento}</td>
      <td>${s.estado}</td>
      <td><button onclick='verDetalles(${JSON.stringify(s)})'>Ver Detalles</button></td>
    </tr>`;
  });
}

// Modal detalles
function verDetalles(solicitud){
  document.getElementById("detalleSolicitud").innerHTML=`
    <p><b>ID:</b> ${solicitud.idSolicitud}</p>
    <p><b>Documento:</b> ${solicitud.nombreDocumento}</p>
    <p><b>Tipo acciÃ³n:</b> ${solicitud.tipoAccion}</p>
    <p><b>Gerencia:</b> ${solicitud.gerencia}</p>
    <p><b>Departamento:</b> ${solicitud.departamento}</p>
    <p><b>Motivo:</b> ${solicitud.motivo}</p>
    <p><b>CodificaciÃ³n actual:</b> ${solicitud.codificacionActual || '-'}</p>
    <p><b>Ãšltima versiÃ³n:</b> ${solicitud.ultimaVersion || '-'}</p>
    <p><b>Fecha Ãºltima versiÃ³n:</b> ${solicitud.fechaUltimaVersion || '-'}</p>
    <p><b>Estado:</b> ${solicitud.estado}</p>
    <p><b>Documento:</b> ${solicitud.documento ? `<a href="${solicitud.documento}" target="_blank">Ver archivo</a>` : '-'}</p>
  `;
  document.getElementById("modalDetalles").style.display="flex";
}

function cerrarModal(){document.getElementById("modalDetalles").style.display="none";}

</script>

</body>
</html>
