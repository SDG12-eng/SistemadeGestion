<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sistema de Gestión Documental</title>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
body {font-family: Arial; margin: 20px; background:#f5f5f5;}
table {width:100%;border-collapse:collapse;margin-bottom:20px;}
th,td{border:1px solid #ccc;padding:8px;text-align:left;}
button{margin:2px;padding:5px 10px;}
#modalSolicitud{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);}
#detalleContenido{background:#fff;margin:50px auto;padding:20px;width:80%;border-radius:8px;}
</style>
</head>
<body>

<h1>Dashboard Sistema de Gestión Documental</h1>

<h2>Usuarios</h2>
<form id="formUsuario">
  <input type="text" id="usuarioNombre" placeholder="Nombre" required>
  <input type="email" id="usuarioCorreo" placeholder="Correo" required>
  <input type="password" id="usuarioClave" placeholder="Contraseña" required>
  <input type="text" id="usuarioGerencia" placeholder="Gerencia" required>
  <input type="text" id="usuarioDepartamento" placeholder="Departamento" required>
  <select id="usuarioPermisos" multiple>
    <option value="solicitudes">Realizar Solicitudes</option>
    <option value="verPropias">Ver Solicitudes Propias</option>
    <option value="verGerencia">Ver Solicitudes Gerencia</option>
    <option value="aprobar">Aprobar/Rechazar Solicitudes</option>
    <option value="gestionUsuarios">Gestionar Usuarios</option>
  </select>
  <button type="submit">Crear Usuario</button>
</form>
<table id="tablaUsuarios">
  <thead>
    <tr><th>Nombre</th><th>Correo</th><th>Gerencia</th><th>Departamento</th><th>Permisos</th><th>Acciones</th></tr>
  </thead>
  <tbody></tbody>
</table>

<h2>Solicitudes</h2>
<form id="formSolicitud">
  <input type="text" id="solTitulo" placeholder="Nombre Documento" required>
  <input type="text" id="solTipo" placeholder="Tipo (Procedimiento, Manual, etc)" required>
  <input type="text" id="solAccion" placeholder="Acción (Creación, Modificación, Inactivación)" required>
  <input type="text" id="solGerencia" placeholder="Gerencia" required>
  <input type="text" id="solDepartamento" placeholder="Departamento" required>
  <input type="text" id="solMotivo" placeholder="Motivo">
  <input type="text" id="solUltimaVersion" placeholder="Última versión">
  <input type="text" id="solCodificacion" placeholder="Codificación">
  <textarea id="solDescripcion" placeholder="Descripción"></textarea>
  <input type="file" id="solArchivos" multiple>
  <button type="submit">Crear Solicitud</button>
</form>

<table id="tablaSolicitudes">
  <thead>
    <tr><th>Título</th><th>Tipo</th><th>Acción</th><th>Estado</th><th>Acciones</th></tr>
  </thead>
  <tbody></tbody>
</table>

<div id="modalSolicitud">
  <div id="detalleContenido">
    <button onclick="cerrarModal()">Cerrar</button>
  </div>
</div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyDdzCiachuhbE9jATz-TesPI2vUVIJrHjM",
  authDomain: "sistemadegestion-7400d.firebaseapp.com",
  projectId: "sistemadegestion-7400d",
  storageBucket: "sistemadegestion-7400d.appspot.com",
  messagingSenderId: "709030283072",
  appId: "1:709030283072:web:5997837b36a448e9515ca5"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// Cloudinary
const cloudName = "df79cjklp";
const uploadPreset = "fci_documentos";

// Usuario admin fijo
const adminID = "admin";

async function cargarUsuarios() {
  let tbody = document.querySelector("#tablaUsuarios tbody");
  tbody.innerHTML = "";
  let snap = await db.collection("Usuarios").get();
  snap.forEach(doc => {
    let u = doc.data();
    tbody.innerHTML += `<tr>
      <td>${u.nombre}</td>
      <td>${u.correo}</td>
      <td>${u.gerencia}</td>
      <td>${u.departamento}</td>
      <td>${u.permisos.join(", ")}</td>
      <td><button onclick="eliminarUsuario('${doc.id}')">Eliminar</button></td>
    </tr>`;
  });
}

async function crearUsuario(e){
  e.preventDefault();
  let nombre=document.getElementById("usuarioNombre").value;
  let correo=document.getElementById("usuarioCorreo").value;
  let clave=document.getElementById("usuarioClave").value;
  let ger=document.getElementById("usuarioGerencia").value;
  let dep=document.getElementById("usuarioDepartamento").value;
  let permisos=[...document.getElementById("usuarioPermisos").selectedOptions].map(o=>o.value);
  await db.collection("Usuarios").add({nombre,correo,clave,gerencia:ger,departamento:dep,permisos});
  cargarUsuarios();
  e.target.reset();
}

function eliminarUsuario(id){ db.collection("Usuarios").doc(id).delete().then(cargarUsuarios); }

async function cargarSolicitudes() {
  let tbody=document.querySelector("#tablaSolicitudes tbody");
  tbody.innerHTML="";
  let snap=await db.collection("solicitudes").get();
  snap.forEach(doc=>{
    let s=doc.data();
    tbody.innerHTML+=`<tr>
      <td>${s.titulo}</td>
      <td>${s.tipo}</td>
      <td>${s.accion}</td>
      <td>${s.estado}</td>
      <td><button onclick="abrirModal('${doc.id}')">Detalles</button></td>
    </tr>`;
  });
}

async function crearSolicitud(e){
  e.preventDefault();
  let titulo=document.getElementById("solTitulo").value;
  let tipo=document.getElementById("solTipo").value;
  let accion=document.getElementById("solAccion").value;
  let ger=document.getElementById("solGerencia").value;
  let dep=document.getElementById("solDepartamento").value;
  let motivo=document.getElementById("solMotivo").value;
  let ultVersion=document.getElementById("solUltimaVersion").value;
  let codificacion=document.getElementById("solCodificacion").value;
  let descripcion=document.getElementById("solDescripcion").value;
  let archivos=document.getElementById("solArchivos").files;

  let usuarioActual=await db.collection("Usuarios").doc(adminID).get();
  let u=usuarioActual.data();
  let urls=[];
  for(let i=0;i<archivos.length;i++){
    let fd=new FormData();
    fd.append("file",archivos[i]);
    fd.append("upload_preset",uploadPreset);
    let res=await fetch(`https://api.cloudinary.com/v1_1/${cloudName}/upload`,{method:"POST",body:fd});
    let data=await res.json();
    urls.push(data.secure_url);
  }

  await db.collection("solicitudes").add({
    titulo,tipo,accion,gerencia:ger,departamento:dep,motivo,ultVersion,codificacion,descripcion,
    creador:{nombre:u.nombre,correo:u.correo,gerencia:u.gerencia,departamento:u.departamento},
    documentos:urls,
    estado:"Pendiente",
    historial:[],
    comentarios:[],
    fecha:new Date()
  });
  cargarSolicitudes();
  e.target.reset();
}

async function abrirModal(id){
  let modal=document.getElementById("modalSolicitud");
  let contenido=document.getElementById("detalleContenido");
  let doc=await db.collection("solicitudes").doc(id).get();
  let s=doc.data();
  contenido.innerHTML=`<button onclick="cerrarModal()">Cerrar</button>
    <p><strong>Título:</strong> ${s.titulo}</p>
    <p><strong>Tipo:</strong> ${s.tipo}</p>
    <p><strong>Acción:</strong> ${s.accion}</p>
    <p><strong>Gerencia:</strong> ${s.gerencia}</p>
    <p><strong>Departamento:</strong> ${s.departamento}</p>
    <p><strong>Motivo:</strong> ${s.motivo}</p>
    <p><strong>Documentos:</strong> ${s.documentos.map(u=>`<a href="${u}" target="_blank">Abrir</a>`).join(" | ")}</p>
    <p><strong>Historial:</strong><br>${s.historial.map(h=>`${h.estado} - ${new Date(h.fecha.seconds*1000||h.fecha).toLocaleString()} - ${h.comentario||""}`).join("<br>")}</p>`;

  let usuarioActual=await db.collection("Usuarios").doc(adminID).get();
  let permisos=usuarioActual.data().permisos;
  if(permisos.includes("aprobar")){
    contenido.innerHTML+=`<button onclick="aprobarSolicitud('${id}')">Aprobar</button>
    <button onclick="rechazarSolicitud('${id}')">Rechazar</button>`;
  }
}

function cerrarModal(){document.getElementById("modalSolicitud").style.display="none";}

async function aprobarSolicitud(id){
  let comentario=prompt("Comentario al aprobar:");
  await db.collection("solicitudes").doc(id).update({
    estado:"Finalizado",
    historial:firebase.firestore.FieldValue.arrayUnion({estado:"Finalizado",fecha:new Date(),comentario})
  });
  cargarSolicitudes(); cerrarModal();
}

async function rechazarSolicitud(id){
  let comentario=prompt("Motivo de rechazo:");
  await db.collection("solicitudes").doc(id).update({
    estado:"Rechazado",
    historial:firebase.firestore.FieldValue.arrayUnion({estado:"Rechazado",fecha:new Date(),comentario})
  });
  cargarSolicitudes(); cerrarModal();
}

document.getElementById("formUsuario").addEventListener("submit",crearUsuario);
document.getElementById("formSolicitud").addEventListener("submit",crearSolicitud);

cargarUsuarios();
cargarSolicitudes();
</script>
</body>
</html>