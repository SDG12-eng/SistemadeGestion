<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FCI - Sistema de Gesti贸n Documental</title>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>
<script src="https://widget.cloudinary.com/v2.0/global/all.js" type="text/javascript"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
    /* --- ESTILOS ANTERIORES + NUEVOS --- */
    body{font-family:'Segoe UI', sans-serif; margin:0; padding:0; background:#f0f2f5; color:#333;}
    .hidden { display: none !important; }
    .login-container { display: flex; justify-content: center; align-items: center; height: 100vh; background: #2D336B; }
    .login-card { background: white; padding: 40px; border-radius: 15px; width: 90%; max-width: 350px; text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
    .login-card h1 { color: #2D336B; margin-bottom: 20px; font-size: 24px; }
    .login-input { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; }
    .btn-login { width: 100%; padding: 12px; background: #5142E6; color: white; border: none; border-radius: 8px; font-size: 16px; cursor: pointer; font-weight: bold; }
    .app-container { max-width: 1200px; margin: 20px auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 0 15px rgba(0,0,0,0.05); }
    header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #f0f0f0; padding-bottom: 15px; margin-bottom: 20px; }
    h2 { color: #0056b3; margin-top: 30px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
    .btn-logout { background: #dc3545; color: white; padding: 8px 15px; border: none; border-radius: 5px; cursor: pointer; }
    .table-responsive { overflow-x: auto; margin-top: 15px; }
    table { width: 100%; border-collapse: collapse; min-width: 700px; }
    th, td { padding: 12px; text-align: left; border-bottom: 1px solid #ddd; }
    th { background: #0056b3; color: white; }
    input, select, textarea { width: 100%; padding: 8px; margin: 5px 0; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
    button.btn-action { padding: 8px 12px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
    .id-badge { background: #333; color: white; padding: 2px 6px; border-radius: 4px; font-family: monospace; font-size: 0.9em; }
    .permiso-tag { background: #e9ecef; padding: 2px 6px; border-radius: 4px; font-size: 0.85em; margin-right: 3px; }

    /* ESTADOS COLORES */
    .status-pendiente { background: #ffc107; color: black; }
    .status-revision { background: #17a2b8; color: white; }
    .status-aprobado { background: #28a745; color: white; }
    .status-finalizado { background: #6c757d; color: white; }
    .status-rechazado { background: #dc3545; color: white; }

    /* MODAL */
    .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 10000; }
    .modal-content { background: white; padding: 25px; border-radius: 10px; width: 90%; max-width: 800px; max-height: 90vh; overflow-y: auto; }
    .historial-item { font-size: 0.85em; padding: 5px; border-bottom: 1px solid #eee; }

    .stats-grid { display: flex; gap: 15px; flex-wrap: wrap; margin-bottom: 20px; }
    .stat-card { flex: 1; min-width: 150px; background: #e7f1ff; padding: 15px; border-radius: 8px; text-align: center; border: 1px solid #b3d7ff; }
</style>
</head>
<body>

<button onclick="crearPrimerAdmin()" style="position:fixed; top:10px; right:10px; z-index:9999; background:red; color:white; padding:10px; border:none; border-radius:5px; cursor:pointer;">ADMIN EMERGENCIA</button>

<div id="view-login" class="login-container">
    <div class="login-card">
        <h1>FCI System</h1>
        <p>Gesti贸n de Documentos</p>
        <input type="text" id="loginUser" class="login-input" placeholder="Usuario">
        <input type="password" id="loginPass" class="login-input" placeholder="Contrase帽a">
        <button onclick="login()" class="btn-login">Ingresar</button>
    </div>
</div>

<div id="view-app" class="app-container hidden">
    <header>
        <div>
            <h1>Panel de Control</h1>
            <small>Usuario: <span id="userNameDisplay"></span> | Gerencia: <span id="userGerenciaDisplay"></span></small>
        </div>
        <button onclick="logout()" class="btn-logout">Cerrar Sesi贸n</button>
    </header>

    <div class="stats-grid">
        <div class="stat-card"><h3>Total</h3><p id="stat-total">0</p></div>
        <div class="stat-card"><h3>Pendientes</h3><p id="stat-Pendiente">0</p></div>
        <div class="stat-card"><h3>Finalizados</h3><p id="stat-Finalizado">0</p></div>
    </div>

    <div id="adminSection">
        <h2>Gesti贸n de Organizaci贸n (Admin)</h2>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
            <div>
                <input type="text" id="gerenciaNombre" placeholder="Nueva Gerencia">
                <button onclick="crearGerencia()" class="btn-action">A帽adir Gerencia</button>
                <select id="departamentoGerencia" style="margin-top:10px;"></select>
                <input type="text" id="departamentoNombre" placeholder="Nuevo Departamento">
                <button onclick="crearDepartamento()" class="btn-action">A帽adir Depto</button>
            </div>
            <div style="background:#f9f9f9; padding:10px;">
                <h4>Nuevo Usuario</h4>
                <input type="text" id="usuarioNombre" placeholder="Login">
                <input type="text" id="usuarioCorreo" placeholder="Correo">
                <input type="password" id="usuarioPassword" placeholder="Pass">
                <select id="usuarioGerencia"></select>
                <select id="usuarioDepartamento"></select>
                <label><input type="checkbox" id="perm_ges"> Es Administrador</label>
                <button onclick="crearUsuario()" class="btn-action" style="width:100%">Guardar</button>
            </div>
        </div>
        <div class="table-responsive">
            <table id="tablaUsuarios">
                <thead><tr><th>Nombre</th><th>Correo</th><th>Acci贸n</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <section>
        <h2>Nueva Solicitud</h2>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; background:#eef2f7; padding:15px; border-radius:8px;">
            <input type="text" id="solTitulo" placeholder="T铆tulo Documento">
            <select id="solTipo"><option>Procedimiento</option><option>Gu铆a</option><option>Instructivo</option><option>Manual</option><option>Formato</option></select>
            <select id="solAccion"><option>Creaci贸n</option><option>Modificaci贸n</option><option>Inactivaci贸n</option></select>
            <input type="text" id="solMotivo" placeholder="Motivo breve">
            <textarea id="solDescripcion" placeholder="Descripci贸n detallada" style="grid-column: span 2"></textarea>
            <input type="file" id="solArchivos" multiple>
            <button onclick="crearSolicitud()" class="btn-action" style="background:#28a745; grid-column: span 2">ENVIAR SOLICITUD</button>
        </div>
    </section>

    <section>
        <h2>Solicitudes del Sistema</h2>
        <div class="table-responsive">
            <table id="tablaSolicitudes">
                <thead><tr><th>ID</th><th>T铆tulo</th><th>Estado</th><th>Solicitante</th><th>Acci贸n</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
    </section>
</div>

<div id="modalDetalle" class="modal hidden">
    <div class="modal-content">
        <div style="display:flex; justify-content:space-between">
            <h2 id="m-titulo">Detalles</h2>
            <button onclick="cerrarModal()" style="border:none; cursor:pointer; font-size:20px">&times;</button>
        </div>
        <hr>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;">
            <div>
                <p><strong>ID:</strong> <span id="m-id"></span></p>
                <p><strong>Tipo:</strong> <span id="m-tipo"></span></p>
                <p><strong>Solicitante:</strong> <span id="m-user"></span></p>
                <p><strong>Gerencia/Depto:</strong> <span id="m-ub"></span></p>
            </div>
            <div>
                <p><strong>Estado Actual:</strong> <span id="m-estado" class="permiso-tag"></span></p>
                <p><strong>Motivo:</strong> <span id="m-motivo"></span></p>
                <div id="m-archivos"></div>
            </div>
        </div>
        <div style="background:#f4f4f4; padding:10px; margin-top:10px; border-radius:5px">
            <strong>Descripci贸n:</strong> <p id="m-desc"></p>
        </div>

        <div id="panelAcciones" style="margin-top:20px; padding:15px; border: 2px dashed #007bff; border-radius:10px;">
            <h4>Acciones Disponibles</h4>
            <div id="botonesAccion" style="display:flex; gap:10px; flex-wrap:wrap"></div>
            
            <div id="formAdicional" class="hidden" style="margin-top:15px; background:#fff3cd; padding:10px;">
                <label id="lblAdicional"></label>
                <input type="text" id="inputMotivoAccion" placeholder="Escriba el motivo...">
                <input type="date" id="inputFechaAccion" class="hidden">
                <button id="btnConfirmarAccion" class="btn-action">Confirmar</button>
            </div>
        </div>

        <h4>Historial de Movimientos</h4>
        <div id="m-historial" style="max-height:150px; overflow-y:auto; background:#fafafa; border:1px solid #eee;"></div>
    </div>
</div>

<script>
// --- CONFIGURACIN ---
const firebaseConfig = {
  apiKey: "AIzaSyDdzCiachuhbE9jATz-TesPI2vUVIJrHjM",
  authDomain: "sistemadegestion-7400d.firebaseapp.com",
  projectId: "sistemadegestion-7400d",
  storageBucket: "sistemadegestion-7400d.appspot.com",
  messagingSenderId: "709030283072",
  appId: "1:709030283072:web:5997837b36a448e9515ca5"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const cloudName = "df79cjklp"; 
const uploadPreset = "fci_documentos"; 

let currentUser = null;
let currentSolId = null;

// --- INICIALIZACIN ---
function initApp() {
    const session = sessionStorage.getItem("userSession");
    if(session) {
        currentUser = JSON.parse(session);
        mostrarApp();
    } else {
        document.getElementById("view-login").classList.remove("hidden");
    }
}

async function login() {
    const u = document.getElementById("loginUser").value;
    const p = document.getElementById("loginPass").value;
    const snap = await db.collection("Users").where("nombre", "==", u).where("pass", "==", p).get();
    if(!snap.empty) {
        currentUser = { id: snap.docs[0].id, ...snap.docs[0].data() };
        sessionStorage.setItem("userSession", JSON.stringify(currentUser));
        mostrarApp();
    } else { alert("Credenciales incorrectas"); }
}

function mostrarApp() {
    document.getElementById("view-login").classList.add("hidden");
    document.getElementById("view-app").classList.remove("hidden");
    document.getElementById("userNameDisplay").innerText = currentUser.nombre;
    document.getElementById("userGerenciaDisplay").innerText = currentUser.gerencia || "S/G";
    if(!currentUser.permisos?.gestionar) document.getElementById("adminSection").style.display = "none";
    cargarDatos();
}

function logout() { sessionStorage.clear(); location.reload(); }

// --- SOLICITUDES ---
async function crearSolicitud() {
    const tit = document.getElementById("solTitulo").value;
    if(!tit) return alert("T铆tulo obligatorio");
    
    const idFci = await getNextID();
    let urls = [];
    const files = document.getElementById("solArchivos").files;

    for(let f of files) {
        let fd = new FormData(); fd.append("file", f); fd.append("upload_preset", uploadPreset);
        let res = await fetch(`https://api.cloudinary.com/v1_1/${cloudName}/upload`, {method:"POST", body:fd});
        let json = await res.json(); urls.push(json.secure_url);
    }

    const nuevaSol = {
        fciId: idFci,
        titulo: tit,
        tipo: document.getElementById("solTipo").value,
        accion: document.getElementById("solAccion").value,
        motivo: document.getElementById("solMotivo").value,
        descripcion: document.getElementById("solDescripcion").value,
        documentos: urls,
        estado: "Pendiente",
        fecha: new Date(),
        usuarioNom: currentUser.nombre,
        usuarioCorreo: currentUser.correo,
        usuarioGerencia: currentUser.gerencia,
        usuarioDepto: currentUser.departamento,
        historial: [{ fecha: new Date(), accion: "Creado", msg: "Solicitud iniciada por el usuario" }]
    };

    await db.collection("solicitudes").add(nuevaSol);
    alert("Solicitud Enviada: " + idFci);
    location.reload();
}

function cargarDatos() {
    // Selects
    db.collection("gerencias").onSnapshot(s => {
        let h = ""; s.forEach(d => h += `<option value="${d.data().nombre}">${d.data().nombre}</option>`);
        ["departamentoGerencia","usuarioGerencia"].forEach(id => { if(document.getElementById(id)) document.getElementById(id).innerHTML = h; });
    });
    db.collection("departamentos").onSnapshot(s => {
        let h = ""; s.forEach(d => h += `<option value="${d.data().nombre}">${d.data().nombre}</option>`);
        if(document.getElementById("usuarioDepartamento")) document.getElementById("usuarioDepartamento").innerHTML = h;
    });

    // Usuarios
    db.collection("Users").onSnapshot(s => {
        let h = "";
        s.forEach(doc => {
            h += `<tr><td>${doc.data().nombre}</td><td>${doc.data().correo}</td><td><button onclick="eliminar('Users','${doc.id}')">X</button></td></tr>`;
        });
        document.querySelector("#tablaUsuarios tbody").innerHTML = h;
    });

    // Solicitudes
    db.collection("solicitudes").orderBy("fecha", "desc").onSnapshot(s => {
        let h = "";
        let stats = {total:0, Pendiente:0, Finalizado:0};
        s.forEach(doc => {
            const d = doc.data();
            stats.total++; if(stats[d.estado] !== undefined) stats[d.estado]++;
            h += `<tr>
                <td><span class="id-badge">${d.fciId}</span></td>
                <td>${d.titulo}</td>
                <td><span class="permiso-tag status-${d.estado.toLowerCase()}">${d.estado}</span></td>
                <td>${d.usuarioNom}</td>
                <td><button onclick="verDetalle('${doc.id}')" class="btn-action">Ver Detalle</button></td>
            </tr>`;
        });
        document.querySelector("#tablaSolicitudes tbody").innerHTML = h;
        document.getElementById("stat-total").innerText = stats.total;
        document.getElementById("stat-Pendiente").innerText = stats.Pendiente;
        document.getElementById("stat-Finalizado").innerText = stats.Finalizado;
    });
}

// --- MODAL Y LGICA DE ESTADOS ---
async function verDetalle(id) {
    currentSolId = id;
    const doc = await db.collection("solicitudes").doc(id).get();
    const d = doc.data();

    document.getElementById("m-id").innerText = d.fciId;
    document.getElementById("m-titulo").innerText = d.titulo;
    document.getElementById("m-tipo").innerText = d.tipo;
    document.getElementById("m-user").innerText = d.usuarioNom;
    document.getElementById("m-ub").innerText = `${d.usuarioGerencia} / ${d.usuarioDepto}`;
    document.getElementById("m-estado").innerText = d.estado;
    document.getElementById("m-motivo").innerText = d.motivo;
    document.getElementById("m-desc").innerText = d.descripcion;
    
    let docsHtml = "";
    d.documentos.forEach((link, i) => docsHtml += `<a href="${link}" target="_blank"> Doc ${i+1}</a> `);
    document.getElementById("m-archivos").innerHTML = docsHtml;

    let histHtml = "";
    d.historial.forEach(h => {
        let f = h.fecha.seconds ? new Date(h.fecha.seconds * 1000).toLocaleString() : new Date().toLocaleString();
        histHtml += `<div class="historial-item"><strong>${f} - ${h.accion}:</strong> ${h.msg}</div>`;
    });
    document.getElementById("m-historial").innerHTML = histHtml;

    renderizarBotones(d.estado);
    document.getElementById("modalDetalle").classList.remove("hidden");
}

function renderizarBotones(estado) {
    const container = document.getElementById("botonesAccion");
    container.innerHTML = "";
    document.getElementById("formAdicional").classList.add("hidden");

    // Solo Admin o Gestores pueden mover estados
    if(!currentUser.permisos?.gestionar && estado !== "Rechazado Gerencia") return;

    if(estado === "Pendiente") {
        container.innerHTML += `<button onclick="cambiarEstado('Revisi贸n','Iniciando revisi贸n t茅cnica')" class="btn-action">Pasar a Revisi贸n</button>`;
    }
    
    if(estado === "Revisi贸n") {
        container.innerHTML += `<button onclick="prepararAccion('Consulta','Motivo de la consulta')" class="btn-action" style="background:#6f42c1">Realizar Consulta</button>`;
        container.innerHTML += `<button onclick="prepararAccion('Reuni贸n','Motivo y fecha')" class="btn-action" style="background:#fd7e14">Solicitar Reuni贸n</button>`;
        container.innerHTML += `<button onclick="cambiarEstado('Aprobado SGC','Documentaci贸n verificada y firmada')" class="btn-action" style="background:#28a745">Aprobar SGC</button>`;
    }

    if(estado === "Aprobado SGC") {
        container.innerHTML += `<button onclick="cambiarEstado('Solicitud Gerente','Enviando a firma de gerencia')" class="btn-action">Solicitar Firma Gerente</button>`;
    }

    if(estado === "Solicitud Gerente") {
        container.innerHTML += `<button onclick="cambiarEstado('Finalizado','Proceso completado exitosamente')" class="btn-action" style="background:#28a745">FINALIZAR</button>`;
        container.innerHTML += `<button onclick="prepararAccion('Rechazado Gerencia','Detalle del rechazo')" class="btn-action" style="background:#dc3545">RECHAZAR</button>`;
    }

    // Permitir reenviar si fue rechazado
    if(estado === "Rechazado Gerencia") {
        container.innerHTML += `<button onclick="cambiarEstado('Solicitud Gerente','Re-enviado tras correcciones')" class="btn-action">Re-enviar a Gerente</button>`;
    }
}

function prepararAccion(tipo, label) {
    document.getElementById("formAdicional").classList.remove("hidden");
    document.getElementById("lblAdicional").innerText = label;
    document.getElementById("inputFechaAccion").classList.toggle("hidden", tipo !== "Reuni贸n");
    
    document.getElementById("btnConfirmarAccion").onclick = () => {
        let msg = document.getElementById("inputMotivoAccion").value;
        let fecha = document.getElementById("inputFechaAccion").value;
        if(!msg) return alert("Debe ingresar un motivo");
        cambiarEstado(tipo, msg + (fecha ? " | Fecha: "+fecha : ""));
    };
}

async function cambiarEstado(nuevoEstado, comentario) {
    const snap = await db.collection("solicitudes").doc(currentSolId).get();
    let historial = snap.data().historial;
    historial.push({ fecha: new Date(), accion: nuevoEstado, msg: comentario });

    await db.collection("solicitudes").doc(currentSolId).update({
        estado: nuevoEstado,
        historial: historial
    });
    cerrarModal();
}

function cerrarModal() { document.getElementById("modalDetalle").classList.add("hidden"); }

// --- FUNCIONES AUXILIARES ---
async function getNextID() {
    const ref = db.collection("configuracion").doc("contadores");
    return db.runTransaction(async (t) => {
        const doc = await t.get(ref);
        let num = doc.exists ? doc.data().solicitudActual + 1 : 1;
        t.set(ref, { solicitudActual: num });
        return "FCI-SGD-" + num.toString().padStart(4, '0');
    });
}

function crearGerencia() {
    let n = document.getElementById("gerenciaNombre").value;
    if(n) db.collection("gerencias").add({nombre:n});
}

function crearDepartamento() {
    let n = document.getElementById("departamentoNombre").value;
    let g = document.getElementById("departamentoGerencia").value;
    if(n) db.collection("departamentos").add({nombre:n, gerencia:g});
}

async function crearUsuario() {
    await db.collection("Users").add({
        nombre: document.getElementById("usuarioNombre").value,
        pass: document.getElementById("usuarioPassword").value,
        correo: document.getElementById("usuarioCorreo").value,
        gerencia: document.getElementById("usuarioGerencia").value,
        departamento: document.getElementById("usuarioDepartamento").value,
        permisos: { gestionar: document.getElementById("perm_ges").checked, solicitudes: true }
    });
    alert("Usuario Creado");
}

function eliminar(col, id) { if(confirm("驴Seguro?")) db.collection(col).doc(id).delete(); }

async function crearPrimerAdmin() {
    await db.collection("Users").add({
        nombre: "Admin", pass: "123456", correo: "admin@fci.com",
        permisos: { gestionar: true, solicitudes: true }, gerencia: "SGC"
    });
    alert("Creado");
}

initApp();
</script>
</body>
</html>
