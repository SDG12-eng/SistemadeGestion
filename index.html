<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>FCI ‚Äì Sistema de Gesti√≥n Documental</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

<style>
body{font-family:Arial;background:#f4f6f8;margin:0}
header{background:#1f2937;color:#fff;padding:15px}
section{padding:15px}
.card{background:#fff;padding:15px;margin-bottom:15px;border-radius:8px}
h2{margin-top:0}
input,select,textarea,button{width:100%;margin:5px 0;padding:8px}
button{background:#2563eb;color:#fff;border:none;border-radius:5px;cursor:pointer}
table{width:100%;border-collapse:collapse}
th,td{border:1px solid #ddd;padding:6px;font-size:13px}
th{background:#e5e7eb}
small{color:#555}
.estado{font-weight:bold}
</style>
</head>

<body>

<header>
<h1>üìÅ FCI ‚Äì Gesti√≥n Documental</h1>
<small>Usuario activo: <b id="usuarioActivo"></b></small>
</header>

<section>

<!-- DASHBOARD -->
<div class="card">
<h2>üìä Dashboard</h2>
<div id="dashboard"></div>
</div>

<!-- ADMIN -->
<div class="card" id="adminPanel">
<h2>üõ†Ô∏è Administraci√≥n</h2>

<h3>Gerencias</h3>
<input id="nuevaGerencia" placeholder="Nombre gerencia">
<button onclick="crearGerencia()">Agregar</button>
<ul id="listaGerencias"></ul>

<h3>Departamentos</h3>
<input id="nuevoDepto" placeholder="Nombre departamento">
<select id="deptoGerencia"></select>
<button onclick="crearDepartamento()">Agregar</button>
<ul id="listaDeptos"></ul>

<h3>Usuarios</h3>
<input id="uUsuario" placeholder="Usuario">
<input id="uCorreo" placeholder="Correo">
<select id="uRol">
<option value="usuario">Usuario</option>
<option value="gerente">Gerente</option>
<option value="admin">Admin</option>
</select>
<select id="uGerencia"></select>
<select id="uDepto"></select>
<button onclick="crearUsuario()">Crear usuario</button>
<table id="tablaUsuarios"></table>
</div>

<!-- NUEVA SOLICITUD -->
<div class="card">
<h2>‚ûï Nueva Solicitud</h2>

<input id="docNombre" placeholder="Nombre del documento">
<select id="docTipo">
<option>Procedimiento</option>
<option>Gu√≠a</option>
<option>Instructivo</option>
<option>Manual</option>
<option>Formato</option>
</select>

<select id="accion">
<option>Creaci√≥n</option>
<option>Modificaci√≥n</option>
<option>Inactivaci√≥n</option>
</select>

<select id="sGerencia"></select>
<select id="sDepto"></select>

<textarea id="motivo" placeholder="Motivo"></textarea>

<div id="extraMod">
<input id="fechaVersion" placeholder="Fecha √∫ltima versi√≥n">
<input id="ultimaVersion" placeholder="√öltima versi√≥n">
<input id="codigoDoc" placeholder="C√≥digo documento">
</div>

<input type="file" id="archivo">
<button onclick="crearSolicitud()">Enviar Solicitud</button>
</div>

<!-- SOLICITUDES -->
<div class="card">
<h2>üìÑ Solicitudes</h2>
<table id="tablaSolicitudes"></table>
</div>

</section>

<script>
// =======================
// CONFIGURACI√ìN
// =======================
const firebaseConfig = {
  apiKey: "AIzaSyDdzCiachuhbE9jATz-TesPI2vUVIJrHjM",
  authDomain: "sistemadegestion-7400d.firebaseapp.com",
  projectId: "sistemadegestion-7400d"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

const CLOUDINARY_CLOUD = "df79cjklp";
const CLOUDINARY_PRESET = "fci_documentos";

// USUARIO ACTIVO (SIN LOGIN)
const CURRENT_USER = {
  usuario: "Admin",
  rol: "admin",
  correo: "admin@fcipty.com",
  gerencia: "Administraci√≥n",
  departamento: "Sistemas"
};

document.getElementById("usuarioActivo").innerText =
`${CURRENT_USER.usuario} (${CURRENT_USER.rol})`;

// =======================
// GERENCIAS / DEPTOS
// =======================
async function crearGerencia(){
  await db.collection("gerencias").add({nombre:nuevaGerencia.value});
  nuevaGerencia.value="";
  cargarGerencias();
}

async function crearDepartamento(){
  await db.collection("departamentos").add({
    nombre:nuevoDepto.value,
    gerencia:deptoGerencia.value
  });
  nuevoDepto.value="";
  cargarDepartamentos();
}

async function cargarGerencias(){
  const snap=await db.collection("gerencias").get();
  listaGerencias.innerHTML="";
  deptoGerencia.innerHTML="";
  uGerencia.innerHTML="";
  sGerencia.innerHTML="";
  snap.forEach(d=>{
    listaGerencias.innerHTML+=`<li>${d.data().nombre}</li>`;
    deptoGerencia.innerHTML+=`<option>${d.data().nombre}</option>`;
    uGerencia.innerHTML+=`<option>${d.data().nombre}</option>`;
    sGerencia.innerHTML+=`<option>${d.data().nombre}</option>`;
  });
}

async function cargarDepartamentos(){
  const snap=await db.collection("departamentos").get();
  listaDeptos.innerHTML="";
  uDepto.innerHTML="";
  sDepto.innerHTML="";
  snap.forEach(d=>{
    listaDeptos.innerHTML+=`<li>${d.data().nombre} (${d.data().gerencia})</li>`;
    uDepto.innerHTML+=`<option>${d.data().nombre}</option>`;
    sDepto.innerHTML+=`<option>${d.data().nombre}</option>`;
  });
}

// =======================
// USUARIOS
// =======================
async function crearUsuario(){
  await db.collection("usuarios").add({
    usuario:uUsuario.value,
    correo:uCorreo.value,
    rol:uRol.value,
    gerencia:uGerencia.value,
    departamento:uDepto.value,
    activo:true
  });
  cargarUsuarios();
}

async function cargarUsuarios(){
  const snap=await db.collection("usuarios").get();
  tablaUsuarios.innerHTML="<tr><th>Usuario</th><th>Rol</th><th>Gerencia</th></tr>";
  snap.forEach(d=>{
    const u=d.data();
    tablaUsuarios.innerHTML+=`
    <tr>
      <td>${u.usuario}</td>
      <td>${u.rol}</td>
      <td>${u.gerencia}</td>
    </tr>`;
  });
}

// =======================
// SOLICITUDES
// =======================
async function subirArchivo(file){
  const f=new FormData();
  f.append("file",file);
  f.append("upload_preset",CLOUDINARY_PRESET);
  const r=await fetch(`https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD}/auto/upload`,{method:"POST",body:f});
  return (await r.json()).secure_url;
}

async function crearSolicitud(){
  let url="";
  if(archivo.files.length){
    url=await subirArchivo(archivo.files[0]);
  }

  await db.collection("solicitudes").add({
    documento:docNombre.value,
    tipo:docTipo.value,
    accion:accion.value,
    gerencia:sGerencia.value,
    departamento:sDepto.value,
    motivo:motivo.value,
    version:{
      fecha:fechaVersion.value||null,
      ultima:ultimaVersion.value||null,
      codigo:codigoDoc.value||null
    },
    archivo:url,
    estado:"Pendiente",
    historial:[{
      estado:"Pendiente",
      usuario:CURRENT_USER.usuario,
      fecha:new Date(),
      comentario:"Solicitud creada"
    }],
    solicitante:CURRENT_USER,
    fecha:new Date()
  });
  cargarSolicitudes();
}

async function cargarSolicitudes(){
  const snap=await db.collection("solicitudes").get();
  tablaSolicitudes.innerHTML="<tr><th>Documento</th><th>Estado</th><th>Gerencia</th></tr>";
  snap.forEach(d=>{
    const s=d.data();
    tablaSolicitudes.innerHTML+=`
    <tr>
      <td>${s.documento}</td>
      <td class="estado">${s.estado}</td>
      <td>${s.gerencia}</td>
    </tr>`;
  });
}

// =======================
// INIT
// =======================
cargarGerencias();
cargarDepartamentos();
cargarUsuarios();
cargarSolicitudes();

</script>
</body>
</html>