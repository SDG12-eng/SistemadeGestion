<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Sistema de GestiÃ³n Documental - Admin</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

<style>
body { font-family: Arial; margin:0; background:#f4f6f8; }
header { background:#1f2937; color:white; padding:15px; }
.container { padding:20px; }
.card { background:white; padding:15px; border-radius:8px; margin-bottom:20px; box-shadow:0 2px 5px rgba(0,0,0,0.1);}
button { padding:6px 12px; cursor:pointer; margin-top:5px; }
select, input, textarea { width:100%; margin:5px 0; padding:6px; }
.grid { display:grid; grid-template-columns: repeat(2,1fr); gap:15px; }
h3 { margin-top:0; }
table { width:100%; border-collapse: collapse; }
th, td { border:1px solid #ddd; padding:8px; text-align:left; }
th { background:#f3f4f6; }
</style>
</head>

<body>

<header>
<h2>ðŸ“Š Dashboard Admin - Sistema de GestiÃ³n Documental</h2>
</header>

<div class="container">

<div class="grid">
  <!-- Crear Usuario -->
  <div class="card">
    <h3>âž• Crear Usuario</h3>
    <input id="uNombre" placeholder="Nombre">
    <input id="uCorreo" placeholder="Correo">
    <input id="uPass" placeholder="ContraseÃ±a">
    <select id="uGerencia">
      <option value="Finanzas">Finanzas</option>
      <option value="RRHH">RRHH</option>
      <option value="Compras">Compras</option>
      <option value="IT">IT</option>
      <option value="General">General</option>
    </select>
    <select id="uDepartamento">
      <option value="Archivos">Archivos</option>
      <option value="Contabilidad">Contabilidad</option>
      <option value="Operaciones">Operaciones</option>
      <option value="Compras">Compras</option>
      <option value="IT">IT</option>
    </select>
    <select id="uPermisos" multiple>
      <option value="realizar_solicitudes">Realizar solicitudes</option>
      <option value="ver_solicitudes_propias">Ver solicitudes propias</option>
      <option value="ver_solicitudes_gerencia">Ver solicitudes de gerencia</option>
      <option value="aprobar_solicitudes">Aprobar/Rechazar solicitudes</option>
      <option value="gestionar_usuarios">Gestionar usuarios</option>
    </select>
    <button onclick="crearUsuario()">Crear Usuario</button>
  </div>

  <!-- Crear Solicitud -->
  <div class="card">
    <h3>âž• Crear Solicitud</h3>
    <input id="titulo" placeholder="TÃ­tulo">
    <textarea id="descripcion" placeholder="DescripciÃ³n"></textarea>
    <input type="file" id="archivo">
    <select id="gerenciaSelect">
      <option value="Finanzas">Finanzas</option>
      <option value="RRHH">RRHH</option>
      <option value="Compras">Compras</option>
      <option value="IT">IT</option>
      <option value="General">General</option>
    </select>
    <button onclick="crearSolicitud()">Crear Solicitud</button>
  </div>
</div>

<!-- Lista de usuarios -->
<div class="card">
<h3>ðŸ‘¤ Usuarios</h3>
<div id="listaUsuarios"></div>
</div>

<!-- Lista de solicitudes -->
<div class="card">
<h3>ðŸ“‹ Solicitudes</h3>
<div id="listaSolicitudes"></div>
</div>

<div class="grid">
  <!-- GrÃ¡fica Estados -->
  <div class="card">
    <h3>Solicitudes por Estado</h3>
    <canvas id="chartEstados"></canvas>
  </div>

  <!-- GrÃ¡fica Gerencias -->
  <div class="card">
    <h3>Solicitudes por Gerencia</h3>
    <canvas id="chartGerencias"></canvas>
  </div>
</div>

<script>
// ðŸ”¥ FIREBASE
firebase.initializeApp({
  apiKey: "AIzaSyDdzCiachuhbE9jATz-TesPI2vUVIJrHjM",
  authDomain: "sistemadegestion-7400d.firebaseapp.com",
  projectId: "sistemadegestion-7400d",
  storageBucket: "sistemadegestion-7400d.appspot.com"
});
const db = firebase.firestore();

// â˜ï¸ CLOUDINARY
const CLOUDINARY_CLOUD = "df79cjklp";
const UPLOAD_PRESET = "fci_documentos";

// ðŸ”¹ Estados
const ESTADOS = [
  "pendiente",
  "solicitud de reuniÃ³n",
  "consulta",
  "documentado",
  "verificado",
  "codificado",
  "aprobaciÃ³n de gerente",
  "finalizado",
  "rechazado"
];

// ðŸ”¹ Subir archivo a Cloudinary
async function subirArchivo(file){
  if(!file) return "";
  let form = new FormData();
  form.append("file", file);
  form.append("upload_preset", UPLOAD_PRESET);
  let res = await fetch(`https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD}/upload`, { method:"POST", body:form });
  let data = await res.json();
  return data.secure_url;
}

// ðŸ”¹ Crear Usuario
async function crearUsuario(){
  let nombre = document.getElementById("uNombre").value;
  let correo = document.getElementById("uCorreo").value;
  let pass = document.getElementById("uPass").value;
  let gerencia = document.getElementById("uGerencia").value;
  let departamento = document.getElementById("uDepartamento").value;
  let permisos = Array.from(document.getElementById("uPermisos").selectedOptions).map(o=>o.value);

  if(!nombre || !correo || !pass) { alert("Completa todos los campos"); return; }

  await db.collection("usuarios").add({nombre, correo, pass, gerencia, departamento, permisos});
  document.getElementById("uNombre").value="";
  document.getElementById("uCorreo").value="";
  document.getElementById("uPass").value="";
  cargarUsuarios();
}

// ðŸ”¹ Cargar Usuarios
async function cargarUsuarios(){
  const lista = document.getElementById("listaUsuarios");
  lista.innerHTML = "";
  let snap = await db.collection("usuarios").get();
  lista.innerHTML = "<table><tr><th>Nombre</th><th>Correo</th><th>ContraseÃ±a</th><th>Gerencia</th><th>Departamento</th><th>Permisos</th><th>Acciones</th></tr>";
  snap.forEach(doc=>{
    let u = doc.data();
    lista.innerHTML += `<tr>
      <td>${u.nombre}</td>
      <td>${u.correo}</td>
      <td>${u.pass}</td>
      <td>${u.gerencia}</td>
      <td>${u.departamento}</td>
      <td>${u.permisos.join(", ")}</td>
      <td>
        <button onclick="eliminarUsuario('${doc.id}')">Eliminar</button>
      </td>
    </tr>`;
  });
  lista.innerHTML += "</table>";
}

// ðŸ”¹ Eliminar Usuario
async function eliminarUsuario(id){
  let motivo = prompt("Motivo de eliminaciÃ³n:");
  if(!motivo) return;
  await db.collection("usuarios").doc(id).delete();
  cargarUsuarios();
}

// ðŸ”¹ Crear Solicitud
async function crearSolicitud(){
  let url = "";
  let file = document.getElementById("archivo").files[0];
  if(file) url = await subirArchivo(file);

  let titulo = document.getElementById("titulo").value;
  let descripcion = document.getElementById("descripcion").value;
  let gerencia = document.getElementById("gerenciaSelect").value;

  await db.collection("solicitudes").add({
    titulo,
    descripcion,
    usuario: "Admin",
    gerencia,
    estado: "pendiente",
    fechaReunion: "",
    documentos: url ? [url] : [],
    comentarios: [],
    historial: [{estado:"pendiente", fecha:new Date()}],
    fecha: new Date()
  });

  document.getElementById("titulo").value="";
  document.getElementById("descripcion").value="";
  document.getElementById("archivo").value="";
  cargarSolicitudes();
}

// ðŸ”¹ Cargar Solicitudes
async function cargarSolicitudes(){
  const lista = document.getElementById("listaSolicitudes");
  lista.innerHTML = "";
  let snap = await db.collection("solicitudes").orderBy("fecha","desc").get();
  let estadosGrafica = {};
  let gerenciasGrafica = {};

  lista.innerHTML = "<table><tr><th>TÃ­tulo</th><th>Usuario</th><th>Gerencia</th><th>Estado</th><th>Documentos</th><th>Acciones</th></tr>";

  snap.forEach(doc=>{
    let d = doc.data();

    // Graficas
    estadosGrafica[d.estado] = (estadosGrafica[d.estado]||0)+1;
    gerenciasGrafica[d.gerencia] = (gerenciasGrafica[d.gerencia]||0)+1;

    // Documentos
    let docsHtml = d.documentos.map(u=>`<a href="${u}" target="_blank">ðŸ“Ž</a>`).join(" ");

    // Acciones
    let acciones = `
      <select onchange="cambiarEstado('${doc.id}', this.value)">
        ${ESTADOS.map(e=>`<option ${d.estado==e?"selected":""}>${e}</option>`).join("")}
      </select>
      <button onclick="eliminarSolicitud('${doc.id}')">Eliminar</button>
      <button onclick="verDetalles('${doc.id}')">Ver Detalles</button>
    `;

    lista.innerHTML += `<tr>
      <td>${d.titulo}</td>
      <td>${d.usuario}</td>
      <td>${d.gerencia}</td>
      <td>${d.estado}</td>
      <td>${docsHtml}</td>
      <td>${acciones}</td>
    </tr>`;
  });
  lista.innerHTML += "</table>";

  generarGraficas(estadosGrafica, gerenciasGrafica);
}

// ðŸ”¹ Cambiar Estado
async function cambiarEstado(id, estado){
  await db.collection("solicitudes").doc(id).update({
    estado,
    historial: firebase.firestore.FieldValue.arrayUnion({estado, fecha:new Date()})
  });
  cargarSolicitudes();
}

// ðŸ”¹ Ver Detalles Solicitud
async function verDetalles(id){
  let doc = await db.collection("solicitudes").doc(id).get();
  let d = doc.data();
  alert(`
TÃ­tulo: ${d.titulo}
Usuario: ${d.usuario}
Gerencia: ${d.gerencia}
Estado: ${d.estado}
DescripciÃ³n: ${d.descripcion}
Documentos: ${d.documentos.join(", ")}
Historial: ${d.historial.map(h=>h.estado+" ("+new Date(h.fecha.seconds*1000||h.fecha)+")").join("\n")}
Comentarios: ${d.comentarios.join("\n")}
  `);
}

// ðŸ”¹ Eliminar Solicitud
async function eliminarSolicitud(id){
  let motivo = prompt("Motivo de eliminaciÃ³n de la solicitud:");
  if(!motivo) return;
  await db.collection("solicitudes").doc(id).delete();
  cargarSolicitudes();
}

// ðŸ”¹ Generar grÃ¡ficas
function generarGraficas(estados, gerencias){
  new Chart(document.getElementById("chartEstados"), {
    type:"pie",
    data:{
      labels:Object.keys(estados),
      datasets:[{data:Object.values(estados), backgroundColor:["#f87171","#fb923c","#facc15","#4ade80","#22d3ee","#818cf8","#a78bfa","#f472b6","#cbd5e1"]}]
    }
  });

  new Chart(document.getElementById("chartGerencias"), {
    type:"bar",
    data:{
      labels:Object.keys(gerencias),
      datasets:[{label:"Solicitudes por Gerencia", data:Object.values(gerencias), backgroundColor:"#60a5fa"}]
    }
  });
}

// ðŸ”¹ Inicial
cargarUsuarios();
cargarSolicitudes();
</script>

</body>
</html>