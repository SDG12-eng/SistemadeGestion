<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>FCI | GestiÃ³n Documental</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

<!-- EmailJS -->
<script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>

<style>
body{font-family:Arial;background:#f3f4f6;margin:0}
header{background:#111827;color:#fff;padding:15px}
.card{background:#fff;padding:15px;margin:15px;border-radius:8px}
input,select,textarea,button{width:100%;margin-top:8px;padding:8px;border-radius:4px}
button{background:#2563eb;color:#fff;border:none;cursor:pointer}
table{width:100%;border-collapse:collapse}
td,th{border:1px solid #ccc;padding:6px;text-align:left}
.hidden{display:none}
</style>
</head>

<body>

<header>
<h2>ğŸ“„ FCI â€“ Sistema de Solicitudes Documentales</h2>
</header>

<!-- LOGIN -->
<section id="loginSection" class="card">
<h3>ğŸ”‘ Ingreso al Sistema</h3>
<input id="loginUsuario" placeholder="Usuario">
<input type="password" id="loginPassword" placeholder="ContraseÃ±a">
<button onclick="login()">Ingresar</button>
</section>

<!-- PANEL PRINCIPAL -->
<section id="panel" class="card hidden">

<div class="card">
<h3>â• Nueva Solicitud</h3>

<select id="tipoAccion">
<option>CreaciÃ³n</option>
<option>ModificaciÃ³n</option>
<option>InactivaciÃ³n</option>
</select>

<input id="nombreDocumento" placeholder="Nombre documento">
<select id="gerenciaSelect"></select>
<select id="departamentoSelect"></select>
<textarea id="motivo" placeholder="Motivo"></textarea>

<input id="codificacion" placeholder="CodificaciÃ³n actual">
<input id="ultimaVersion" placeholder="Ãšltima versiÃ³n">
<input type="date" id="fechaUltimaVersion">

<input type="file" id="archivo">
<button onclick="crearSolicitud()">Enviar Solicitud</button>
</div>

<div class="card">
<h3>ğŸ“‹ Solicitudes</h3>
<table>
<thead>
<tr>
<th>ID</th>
<th>Documento</th>
<th>Estado</th>
<th>AcciÃ³n</th>
</tr>
</thead>
<tbody id="tabla"></tbody>
</table>
</div>

<div class="card">
<h3>ğŸ‘¥ Panel de Usuarios</h3>
<input id="nuevoUsuario" placeholder="Usuario">
<input id="nuevoCorreo" placeholder="Correo">
<input id="nuevoPassword" placeholder="ContraseÃ±a">
<select id="nuevoRol">
<option value="user">Usuario</option>
<option value="gerente">Gerente</option>
<option value="admin">Admin</option>
</select>
<select id="nuevoGerencia"></select>
<button onclick="crearUsuario()">Agregar Usuario</button>

<h4>Lista de Usuarios</h4>
<ul id="listaUsuarios"></ul>
</div>

<div class="card">
<h3>ğŸ¢ Panel de Gerencias / Departamentos</h3>
<input id="inputGerencia" placeholder="Nombre gerencia">
<button onclick="agregarGerencia()">Agregar Gerencia</button>
<ul id="listaGerencias"></ul>

<input id="inputDepartamento" placeholder="Nombre departamento">
<button onclick="agregarDepartamento()">Agregar Departamento</button>
<ul id="listaDepartamentos"></ul>
</div>

</section>

<script>
// ================= CONFIG FIREBASE =================
const firebaseConfig = {
  apiKey: "AIzaSyDdzCiachuhbE9jATz-TesPI2vUVIJrHjM",
  authDomain: "sistemadegestion-7400d.firebaseapp.com",
  projectId: "sistemadegestion-7400d",
  storageBucket: "sistemadegestion-7400d.firebasestorage.app",
  messagingSenderId: "709030283072",
  appId: "1:709030283072:web:5997837b36a448e9515ca5"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// Inicializar EmailJS
emailjs.init("2jVnfkJKKG0bpKN-U");

// ================= USUARIOS =================
let usuarios = [
  { uid: "admin", usuario: "Admin", correo: "admin@fcipty.com", password:"123456", rol:"admin", gerencia:"Todas" }
];
let usuarioActual = null;

// ================= GERENCIAS Y DEPARTAMENTOS =================
let gerencias = ["Gerencia Demo"];
let departamentos = ["Departamento Demo"];

// ================= LOGIN =================
function login(){
  const u = document.getElementById("loginUsuario").value;
  const p = document.getElementById("loginPassword").value;

  const user = usuarios.find(x => x.usuario === u && x.password === p);
  if(!user){ alert("Usuario o contraseÃ±a incorrectos"); return; }

  usuarioActual = user;
  document.getElementById("loginSection").classList.add("hidden");
  document.getElementById("panel").classList.remove("hidden");

  cargarGerenciasDepartamentos();
  cargarUsuarios();
  cargarSolicitudes();
}

// ================= CREAR SOLICITUD =================
async function generarID(){
  const ref = db.collection("counters").doc("global");
  return db.runTransaction(async t=>{
    const d = await t.get(ref);
    let n = (d.exists ? d.data().solicitudes : 0) + 1;
    t.set(ref,{solicitudes:n},{merge:true});
    return "FCI-SOL-" + String(n).padStart(4,"0");
  });
}

async function subirArchivo(file){
  const form = new FormData();
  form.append("file", file);
  form.append("upload_preset", "fci_documentos");
  form.append("folder", "fci_documentos");

  const res = await fetch("https://api.cloudinary.com/v1_1/df79cjklp/upload", {method:"POST",body:form});
  const data = await res.json();
  if(data.error){ throw new Error(data.error.message); }
  return data.secure_url;
}

async function crearSolicitud(){
  if(!usuarioActual){ alert("Debes iniciar sesiÃ³n"); return; }

  const archivoFile = document.getElementById("archivo").files[0];
  let url = null;
  if(archivoFile){
    try { url = await subirArchivo(archivoFile); }
    catch(err){ console.error(err); alert("No se pudo subir el archivo"); return; }
  }

  const id = await generarID();
  const nuevaSolicitud = {
    idSolicitud: id,
    tipoAccion: document.getElementById("tipoAccion").value,
    nombreDocumento: document.getElementById("nombreDocumento").value,
    gerencia: document.getElementById("gerenciaSelect").value,
    departamento: document.getElementById("departamentoSelect").value,
    motivo: document.getElementById("motivo").value,
    codificacionActual: document.getElementById("codificacion").value || null,
    ultimaVersion: document.getElementById("ultimaVersion").value || null,
    fechaUltimaVersion: document.getElementById("fechaUltimaVersion").value || null,
    documento: url || null,
    estado: "pendiente",
    solicitante: { uid: usuarioActual.uid, correo: usuarioActual.correo },
    fecha: firebase.firestore.FieldValue.serverTimestamp()
  };

  await db.collection("solicitudes").add(nuevaSolicitud);
  alert("Solicitud creada: " + id);
  cargarSolicitudes();
}

// ================= CARGAR SOLICITUDES =================
async function cargarSolicitudes(){
  const tabla = document.getElementById("tabla");
  tabla.innerHTML="";
  const snap = await db.collection("solicitudes").get();
  snap.forEach(d=>{
    const s = d.data();
    tabla.innerHTML+=`
      <tr>
        <td>${s.idSolicitud}</td>
        <td>${s.nombreDocumento}</td>
        <td>${s.estado}</td>
        <td>-</td>
      </tr>`;
  });
}

// ================= USUARIOS =================
function crearUsuario(){
  const u = document.getElementById("nuevoUsuario").value;
  const c = document.getElementById("nuevoCorreo").value;
  const p = document.getElementById("nuevoPassword").value;
  const r = document.getElementById("nuevoRol").value;
  const g = document.getElementById("nuevoGerencia").value;

  usuarios.push({ uid:u, usuario:u, correo:c, password:p, rol:r, gerencia:g });
  cargarUsuarios();
}

function cargarUsuarios(){
  const ul = document.getElementById("listaUsuarios");
  ul.innerHTML="";
  usuarios.forEach((u,i)=>{
    ul.innerHTML+=`<li>${u.usuario} (${u.rol}) - ${u.gerencia} 
    <button onclick="eliminarUsuario(${i})">Eliminar</button></li>`;
  });

  // Cargar select de gerencia para nuevos usuarios
  const sel = document.getElementById("nuevoGerencia");
  sel.innerHTML="";
  gerencias.forEach(g=>{ sel.innerHTML+=`<option>${g}</option>` });
}

// ================= GERENCIAS Y DEPARTAMENTOS =================
function agregarGerencia(){
  const g = document.getElementById("inputGerencia").value;
  if(!g || gerencias.includes(g)) return;
  gerencias.push(g);
  cargarGerenciasDepartamentos();
}

function agregarDepartamento(){
  const d = document.getElementById("inputDepartamento").value;
  if(!d || departamentos.includes(d)) return;
  departamentos.push(d);
  cargarGerenciasDepartamentos();
}

function eliminarUsuario(idx){
  usuarios.splice(idx,1);
  cargarUsuarios();
}

function cargarGerenciasDepartamentos(){
  const gsel = document.getElementById("gerenciaSelect");
  const dsel = document.getElementById("departamentoSelect");
  gsel.innerHTML=""; dsel.innerHTML="";
  gerencias.forEach(g=> gsel.innerHTML+=`<option>${g}</option>`);
  departamentos.forEach(d=> dsel.innerHTML+=`<option>${d}</option>`);

  // Lista de gerencias y departamentos
  const lg = document.getElementById("listaGerencias");
  const ld = document.getElementById("listaDepartamentos");
  lg.innerHTML=""; ld.innerHTML="";
  gerencias.forEach((g,i)=> lg.innerHTML+=`<li>${g} <button onclick="gerencias.splice(${i},1);cargarGerenciasDepartamentos()">Eliminar</button></li>`);
  departamentos.forEach((d,i)=> ld.innerHTML+=`<li>${d} <button onclick="departamentos.splice(${i},1);cargarGerenciasDepartamentos()">Eliminar</button></li>`);
}

// ================= CARGAR INICIAL =================
cargarGerenciasDepartamentos();
cargarUsuarios();
cargarSolicitudes();

</script>
</body>
</html>
