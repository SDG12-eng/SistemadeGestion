<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>FCI | Sistema de GestiÃ³n Documental</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

<!-- EmailJS -->
<script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>

<style>
body{font-family:Arial;background:#f3f4f6;margin:0;padding:0}
.container{width:400px;margin:80px auto;background:#fff;padding:20px;border-radius:8px;box-shadow:0 0 10px rgba(0,0,0,0.1)}
input,select,textarea,button{width:100%;margin-top:8px;padding:8px;border-radius:4px;border:1px solid #ccc}
button{background:#2563eb;color:#fff;border:none;cursor:pointer}
header{background:#111827;color:#fff;padding:15px}
.card{background:#fff;padding:15px;margin:15px;border-radius:8px}
table{width:100%;border-collapse:collapse}
td,th{border:1px solid #ccc;padding:6px;text-align:left}
.hidden{display:none}
</style>
</head>

<body>

<!-- ===== LOGIN ===== -->
<div id="loginDiv" class="container">
  <h2>Login FCI</h2>
  <input id="usuarioInput" placeholder="Usuario o correo">
  <input id="passwordInput" type="password" placeholder="ContraseÃ±a">
  <button onclick="login()">Ingresar</button>
  <p id="error" style="color:red;"></p>
</div>

<!-- ===== PANEL PRINCIPAL ===== -->
<section id="panel" class="hidden">
<header>
<h2>ðŸ“„ FCI â€“ Sistema de Solicitudes Documentales</h2>
<button onclick="logout()" style="float:right;background:#ef4444;">Cerrar sesiÃ³n</button>
</header>

<div class="card">
<h3>âž• Nueva Solicitud</h3>
<select id="tipoAccion">
<option>CreaciÃ³n</option>
<option>ModificaciÃ³n</option>
<option>InactivaciÃ³n</option>
</select>
<input id="nombreDocumento" placeholder="Nombre documento">
<select id="gerencia"></select>
<select id="departamento"></select>
<textarea id="motivo" placeholder="Motivo"></textarea>
<input id="codificacion" placeholder="CodificaciÃ³n actual">
<input id="ultimaVersion" placeholder="Ãšltima versiÃ³n">
<input type="date" id="fechaUltimaVersion">
<input type="file" id="archivo">
<button onclick="crearSolicitud()">Enviar Solicitud</button>
</div>

<div class="card">
<h3>ðŸ“‹ Solicitudes</h3>
<table>
<thead>
<tr>
<th>ID</th>
<th>Documento</th>
<th>Estado</th>
<th>Solicitante</th>
<th>AcciÃ³n</th>
</tr>
</thead>
<tbody id="tabla"></tbody>
</table>
</div>
</section>

<script>
///////////////////// CONFIGURACIÃ“N /////////////////////
const firebaseConfig = {
  apiKey: "AIzaSyDdzCiachuhbE9jATz-TesPI2vUVIJrHjM",
  authDomain: "sistemadegestion-7400d.firebaseapp.com",
  projectId: "sistemadegestion-7400d",
  storageBucket: "sistemadegestion-7400d.firebasestorage.app",
  messagingSenderId: "709030283072",
  appId: "1:709030283072:web:5997837b36a448e9515ca5"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// Inicializar EmailJS
emailjs.init("2jVnfkJKKG0bpKN-U"); // Tu Public Key

///////////////////// USUARIOS HARD-CODE /////////////////////
let usuarios = [
  { uid:"1", usuario:"Admin", correo:"admin@fcipty.com", password:"123456", rol:"admin", gerencia:"General" },
  // Agregar mÃ¡s usuarios creados manualmente aquÃ­
];

///////////////////// LOGIN /////////////////////
function login(){
  const usuarioVal = document.getElementById("usuarioInput").value.trim();
  const passVal = document.getElementById("passwordInput").value.trim();
  const usuario = usuarios.find(u => (u.usuario === usuarioVal || u.correo === usuarioVal) && u.password === passVal);

  if(usuario){
    sessionStorage.setItem("usuario", JSON.stringify(usuario));
    document.getElementById("loginDiv").classList.add("hidden");
    document.getElementById("panel").classList.remove("hidden");
    cargarSelects();
    cargarSolicitudes();
    alert("Bienvenido " + usuario.usuario + " (" + usuario.rol + ")");
  }else{
    document.getElementById("error").innerText = "Usuario o contraseÃ±a incorrectos";
  }
}

function logout(){
  sessionStorage.removeItem("usuario");
  document.getElementById("panel").classList.add("hidden");
  document.getElementById("loginDiv").classList.remove("hidden");
}

///////////////////// CARGAR GERENCIAS Y DEPARTAMENTOS /////////////////////
async function cargarSelects(){
  const gerencias = await db.collection("gerencias").get();
  const departamentos = await db.collection("departamentos").get();

  const gSel = document.getElementById("gerencia");
  gSel.innerHTML="";
  gerencias.forEach(g=> gSel.innerHTML += `<option value="${g.id}">${g.data().nombre}</option>`);

  const dSel = document.getElementById("departamento");
  dSel.innerHTML="";
  departamentos.forEach(d=> dSel.innerHTML += `<option value="${d.id}">${d.data().nombre}</option>`);
}

///////////////////// GENERAR ID /////////////////////
async function generarID(){
  const ref = db.collection("counters").doc("global");
  return db.runTransaction(async t=>{
    const d = await t.get(ref);
    let n = (d.exists ? d.data().solicitudes : 0) + 1;
    t.set(ref,{solicitudes:n},{merge:true});
    return "FCI-SOL-" + String(n).padStart(4,"0");
  });
}

///////////////////// SUBIR ARCHIVO /////////////////////
async function subirArchivo(file){
  if(!file) return "";
  const form = new FormData();
  form.append("file", file);
  form.append("upload_preset", "fci_documentos"); // Tu preset
  const res = await fetch("https://api.cloudinary.com/v1_1/df79cjklp/auto/upload",{method:"POST", body:form});
  const data = await res.json();
  return data.secure_url;
}

///////////////////// CREAR SOLICITUD /////////////////////
async function crearSolicitud(){
  const usuario = JSON.parse(sessionStorage.getItem("usuario"));
  const id = await generarID();
  const archivoFile = document.getElementById("archivo").files[0];
  const url = await subirArchivo(archivoFile);

  const nuevaSolicitud = {
    idSolicitud: id,
    tipoAccion: document.getElementById("tipoAccion").value,
    nombreDocumento: document.getElementById("nombreDocumento").value,
    gerencia: document.getElementById("gerencia").value,
    departamento: document.getElementById("departamento").value,
    motivo: document.getElementById("motivo").value,
    codificacionActual: document.getElementById("codificacion").value || "",
    ultimaVersion: document.getElementById("ultimaVersion").value || "",
    fechaUltimaVersion: document.getElementById("fechaUltimaVersion").value || "",
    documento: url,
    estado: "pendiente",
    solicitante:{ uid: usuario.uid, usuario: usuario.usuario, correo: usuario.correo },
    fecha: firebase.firestore.FieldValue.serverTimestamp()
  };

  await db.collection("solicitudes").add(nuevaSolicitud);

  // Emails
  enviarCorreo(usuario.correo,id,"Pendiente","Tu solicitud fue registrada correctamente.");
  enviarCorreo("gerente@empresa.com",id,"Pendiente de aprobaciÃ³n","Tienes una solicitud pendiente.");

  alert("Solicitud creada: "+id);
  cargarSolicitudes();
}

///////////////////// CARGAR SOLICITUDES /////////////////////
async function cargarSolicitudes(){
  const usuario = JSON.parse(sessionStorage.getItem("usuario"));
  const tabla = document.getElementById("tabla");
  tabla.innerHTML="";

  const snap = await db.collection("solicitudes").orderBy("fecha","desc").get();
  snap.forEach(d=>{
    const s = d.data();

    // Filtrar segÃºn rol
    if(usuario.rol === "usuario" && s.solicitante.uid !== usuario.uid) return;
    if(usuario.rol === "gerente" && s.gerencia !== usuario.gerencia) return;

    tabla.innerHTML+=`
      <tr>
        <td>${s.idSolicitud}</td>
        <td>${s.nombreDocumento}</td>
        <td>${s.estado}</td>
        <td>${s.solicitante.usuario}</td>
        <td><button onclick='verDetalle("${d.id}")'>Ver Detalle</button></td>
      </tr>`;
  });
}

///////////////////// VER DETALLE /////////////////////
async function verDetalle(docId){
  const doc = await db.collection("solicitudes").doc(docId).get();
  const s = doc.data();
  alert(
    `ID: ${s.idSolicitud}\nDocumento: ${s.nombreDocumento}\nEstado: ${s.estado}\nSolicitante: ${s.solicitante.usuario}\nMotivo: ${s.motivo}`
  );
}

///////////////////// EMAILJS /////////////////////
function enviarCorreo(destino,id,estado,mensaje){
  emailjs.send("service_a7yozqh","template_2sy0hqh",{
    to_email: destino,
    id_solicitud: id,
    estado: estado,
    mensaje: mensaje
  }).catch(err=>console.log("Error email:",err));
}

</script>
</body>
</html>
