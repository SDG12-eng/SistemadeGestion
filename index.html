<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sistema de Gesti칩n</title>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>
<style>
body{font-family:sans-serif;padding:20px;}
input, select, button, textarea{margin:5px; padding:5px;}
.container{border:1px solid #ccc; padding:15px; margin-bottom:20px;}
table{border-collapse:collapse;width:100%; margin-top:10px;}
th, td{border:1px solid #ccc;padding:5px;text-align:left;}
button{cursor:pointer;}
</style>
</head>
<body>

<h2>Login</h2>
<div id="loginDiv">
  <input type="text" id="loginUser" placeholder="Usuario">
  <input type="password" id="loginPass" placeholder="Contrase침a">
  <button onclick="login()">Ingresar</button>
</div>

<div id="appDiv" style="display:none;">
  <h2>Bienvenido <span id="currentUser"></span> (<span id="currentRole"></span>)</h2>
  <button onclick="logout()">Cerrar Sesi칩n</button>

  <div class="container">
    <h3>Usuarios</h3>
    <input type="text" id="newUser" placeholder="Usuario">
    <input type="email" id="newEmail" placeholder="Correo">
    <input type="password" id="newPass" placeholder="Contrase침a">
    <select id="newRole">
      <option value="user">Usuario</option>
      <option value="gerente">Gerente</option>
      <option value="admin">Admin</option>
    </select>
    <button onclick="crearUsuario()">Agregar Usuario</button>
    <table id="usersTable">
      <tr><th>Usuario</th><th>Correo</th><th>Rol</th><th>Acciones</th></tr>
    </table>
  </div>

  <div class="container">
    <h3>Gerencias</h3>
    <input type="text" id="newGerencia" placeholder="Nombre Gerencia">
    <button onclick="crearGerencia()">Agregar Gerencia</button>
    <table id="gerenciasTable"><tr><th>Gerencia</th><th>Acciones</th></tr></table>
  </div>

  <div class="container">
    <h3>Departamentos</h3>
    <input type="text" id="newDepartamento" placeholder="Nombre Departamento">
    <button onclick="crearDepartamento()">Agregar Departamento</button>
    <table id="departamentosTable"><tr><th>Departamento</th><th>Acciones</th></tr></table>
  </div>

  <div class="container">
    <h3>Solicitudes</h3>
    <select id="selectGerencia"></select>
    <select id="selectDepartamento"></select>
    <textarea id="solMotivo" placeholder="Motivo"></textarea><br>
    <input type="file" id="solDocumento">
    <button onclick="crearSolicitud()">Crear Solicitud</button>

    <table id="solicitudesTable">
      <tr><th>ID</th><th>Usuario</th><th>Correo</th><th>Gerencia</th><th>Departamento</th><th>Motivo</th><th>Documento</th><th>Estado</th><th>Acciones</th></tr>
    </table>
  </div>
</div>

<script>
// 游댳 FIREBASE CONFIG
const firebaseConfig = {
  apiKey: "TU_API_KEY",
  authDomain: "TU_AUTH_DOMAIN",
  projectId: "TU_PROJECT_ID",
  storageBucket: "TU_STORAGE_BUCKET",
  messagingSenderId: "TU_MSG_SENDER_ID",
  appId: "TU_APP_ID"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const storage = firebase.storage();

// 游댳 VARIABLES
let currentUserData = null;

// 游댳 LOGIN INTERNO
async function login() {
  const usuario = document.getElementById("loginUser").value;
  const pass = document.getElementById("loginPass").value;

  if(usuario === "Admin" && pass === "123456") {
    currentUserData = {usuario:"Admin", correo:"admin@correo.com", role:"admin"};
    mostrarApp();
    return;
  }

  const snapshot = await db.collection("users").where("usuario","==",usuario).where("password","==",pass).get();
  if(!snapshot.empty){
    const data = snapshot.docs[0].data();
    currentUserData = {id:snapshot.docs[0].id,...data};
    mostrarApp();
  } else {
    alert("Usuario o contrase침a incorrectos");
  }
}

// 游댳 MOSTRAR APP
function mostrarApp() {
  document.getElementById("loginDiv").style.display = "none";
  document.getElementById("appDiv").style.display = "block";
  document.getElementById("currentUser").innerText = currentUserData.usuario;
  document.getElementById("currentRole").innerText = currentUserData.role;

  cargarUsuarios();
  cargarGerencias();
  cargarDepartamentos();
  cargarSolicitudes();
}

// 游댳 LOGOUT
function logout(){
  currentUserData = null;
  document.getElementById("appDiv").style.display = "none";
  document.getElementById("loginDiv").style.display = "block";
}

// 游댳 USUARIOS
async function crearUsuario(){
  const usuario = document.getElementById("newUser").value;
  const correo = document.getElementById("newEmail").value;
  const password = document.getElementById("newPass").value;
  const role = document.getElementById("newRole").value;

  if(!usuario || !correo || !password) { alert("Completa todos los campos"); return; }

  await db.collection("users").add({usuario, correo, password, role});
  cargarUsuarios();
}

async function cargarUsuarios(){
  const table = document.getElementById("usersTable");
  table.innerHTML = `<tr><th>Usuario</th><th>Correo</th><th>Rol</th><th>Acciones</th></tr>`;
  const snapshot = await db.collection("users").get();
  snapshot.forEach(doc => {
    const data = doc.data();
    table.innerHTML += `<tr>
      <td>${data.usuario}</td>
      <td>${data.correo}</td>
      <td>${data.role}</td>
      <td><button onclick="eliminarUsuario('${doc.id}')">Eliminar</button></td>
    </tr>`;
  });
}

async function eliminarUsuario(id){ await db.collection("users").doc(id).delete(); cargarUsuarios(); }

// 游댳 GERENCIAS
async function crearGerencia(){
  const nombre = document.getElementById("newGerencia").value;
  if(!nombre) return;
  await db.collection("gerencias").add({nombre});
  cargarGerencias();
}

async function cargarGerencias(){
  const table = document.getElementById("gerenciasTable");
  const select = document.getElementById("selectGerencia");
  table.innerHTML = `<tr><th>Gerencia</th><th>Acciones</th></tr>`;
  select.innerHTML = `<option value="">Seleccione Gerencia</option>`;
  const snapshot = await db.collection("gerencias").get();
  snapshot.forEach(doc=>{
    const data=doc.data();
    table.innerHTML += `<tr>
      <td>${data.nombre}</td>
      <td><button onclick="eliminarGerencia('${doc.id}')">Eliminar</button></td>
    </tr>`;
    select.innerHTML += `<option value="${doc.id}">${data.nombre}</option>`;
  });
}

async function eliminarGerencia(id){ await db.collection("gerencias").doc(id).delete(); cargarGerencias(); }

// 游댳 DEPARTAMENTOS
async function crearDepartamento(){
  const nombre = document.getElementById("newDepartamento").value;
  if(!nombre) return;
  await db.collection("departamentos").add({nombre});
  cargarDepartamentos();
}

async function cargarDepartamentos(){
  const table = document.getElementById("departamentosTable");
  const select = document.getElementById("selectDepartamento");
  table.innerHTML = `<tr><th>Departamento</th><th>Acciones</th></tr>`;
  select.innerHTML = `<option value="">Seleccione Departamento</option>`;
  const snapshot = await db.collection("departamentos").get();
  snapshot.forEach(doc=>{
    const data=doc.data();
    table.innerHTML += `<tr>
      <td>${data.nombre}</td>
      <td><button onclick="eliminarDepartamento('${doc.id}')">Eliminar</button></td>
    </tr>`;
    select.innerHTML += `<option value="${doc.id}">${data.nombre}</option>`;
  });
}

async function eliminarDepartamento(id){ await db.collection("departamentos").doc(id).delete(); cargarDepartamentos(); }

// 游댳 SOLICITUDES
async function crearSolicitud(){
  const gerenciaId = document.getElementById("selectGerencia").value;
  const departamentoId = document.getElementById("selectDepartamento").value;
  const motivo = document.getElementById("solMotivo").value;
  const file = document.getElementById("solDocumento").files[0];

  if(!gerenciaId || !departamentoId || !motivo){ alert("Completa todos los campos"); return; }

  let documentoUrl = "";
  if(file){
    const ref = storage.ref('documentos/'+Date.now()+"_"+file.name);
    await ref.put(file);
    documentoUrl = await ref.getDownloadURL();
  }

  // Generar ID tipo FCI-SOL-0001
  const counterRef = db.collection("counters").doc("solicitudes");
  const counterDoc = await counterRef.get();
  let numero = 1;
  if(counterDoc.exists) numero = counterDoc.data().count+1;
  await counterRef.set({count:numero});

  const solId = "FCI-SOL-"+String(numero).padStart(4,"0");

  await db.collection("solicitudes").doc(solId).set({
    solId,
    usuario: currentUserData.usuario,
    correo: currentUserData.correo,
    role: currentUserData.role,
    gerenciaId,
    departamentoId,
    motivo,
    documento: documentoUrl,
    estado: "normal",
    fecha: new Date()
  });

  cargarSolicitudes();
}

async function cargarSolicitudes(){
  const table = document.getElementById("solicitudesTable");
  table.innerHTML = `<tr><th>ID</th><th>Usuario</th><th>Correo</th><th>Gerencia</th><th>Departamento</th><th>Motivo</th><th>Documento</th><th>Estado</th><th>Acciones</th></tr>`;

  const snapshot = await db.collection("solicitudes").get();
  const gerenciasSnap = await db.collection("gerencias").get();
  const departamentosSnap = await db.collection("departamentos").get();
  const gerencias = {}; gerenciasSnap.forEach(d=>gerencias[d.id]=d.data().nombre);
  const departamentos = {}; departamentosSnap.forEach(d=>departamentos[d.id]=d.data().nombre);

  snapshot.forEach(doc=>{
    const data = doc.data();
    table.innerHTML += `<tr>
      <td>${data.solId}</td>
      <td>${data.usuario}</td>
      <td>${data.correo}</td>
      <td>${gerencias[data.gerenciaId]||''}</td>
      <td>${departamentos[data.departamentoId]||''}</td>
      <td>${data.motivo}</td>
      <td>${data.documento?`<a href="${data.documento}" target="_blank">Ver</a>`:""}</td>
      <td>${data.estado}</td>
      <td>${currentUserData.role=="admin"||currentUserData.role=="gerente"?`<button onclick="cambiarEstado('${doc.id}')">Cambiar Estado</button>`:""}</td>
    </tr>`;
  });
}

// Cambiar estado de solicitud
async function cambiarEstado(id){
  const nuevo = prompt("Ingrese nuevo estado (normal, pendiente, aprobado, verificado, codificado, finalizado):");
  if(!nuevo) return;
  await db.collection("solicitudes").doc(id).update({estado:nuevo});
  cargarSolicitudes();
}
</script>
</body>
</html>
