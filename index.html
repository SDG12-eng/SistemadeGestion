<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FCI - Sistema de Gesti√≥n Documental 2.0</title>
    
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <style>
        :root {
            --primary: #1a237e;
            --secondary: #3949ab;
            --accent: #00e5ff;
            --success: #2e7d32;
            --danger: #c62828;
            --warning: #f9a825;
            --bg: #f4f7f9;
            --white: #ffffff;
        }

        body { font-family: 'Segoe UI', Roboto, sans-serif; margin: 0; background: var(--bg); color: #333; overflow-x: hidden; }
        .hidden { display: none !important; }

        /* --- LOGIN --- */
        .login-screen { height: 100vh; display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, var(--primary), var(--secondary)); }
        .login-box { background: var(--white); padding: 40px; border-radius: 12px; box-shadow: 0 15px 35px rgba(0,0,0,0.2); width: 100%; max-width: 400px; text-align: center; }
        .input-group { margin-bottom: 15px; text-align: left; }
        .input-group label { display: block; margin-bottom: 5px; font-weight: 600; font-size: 14px; }
        .input-group input, .input-group select { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; }
        .btn-main { background: var(--primary); color: white; border: none; padding: 12px 25px; border-radius: 6px; cursor: pointer; font-weight: bold; width: 100%; transition: 0.3s; }
        .btn-main:hover { background: var(--secondary); }

        /* --- DASHBOARD ESTRUCTURA --- */
        header { background: var(--primary); color: white; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 1000; }
        
        .tabs-nav { background: var(--white); display: flex; padding: 0 20px; border-bottom: 1px solid #ddd; gap: 20px; }
        .tab-link { padding: 15px 20px; cursor: pointer; font-weight: 600; color: #666; border-bottom: 3px solid transparent; }
        .tab-link.active { color: var(--primary); border-bottom-color: var(--primary); }

        .content-area { padding: 25px; max-width: 1300px; margin: 0 auto; }
        .card { background: var(--white); padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 25px; }

        /* --- TABLAS --- */
        .table-res { overflow-x: auto; margin-top: 15px; }
        table { width: 100%; border-collapse: collapse; background: white; }
        th, td { padding: 15px; text-align: left; border-bottom: 1px solid #eee; }
        th { background: #f8f9fa; font-weight: 600; }
        
        /* --- ESTADOS --- */
        .badge { padding: 5px 12px; border-radius: 20px; font-size: 11px; font-weight: bold; text-transform: uppercase; }
        .st-pendiente { background: #fff3e0; color: #ef6c00; }
        .st-revision { background: #e3f2fd; color: #1565c0; }
        .st-finalizado { background: #e8f5e9; color: #2e7d32; }
        .st-rechazado { background: #ffebee; color: #c62828; }

        /* --- NOTIFICACIONES --- */
        .notif-bell { position: relative; cursor: pointer; font-size: 20px; }
        .notif-dot { position: absolute; top: -5px; right: -5px; background: red; width: 10px; height: 10px; border-radius: 50%; display: none; }
        
        /* --- MODAL --- */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 2000; }
        .modal-body { background: white; padding: 30px; border-radius: 12px; width: 90%; max-width: 800px; max-height: 90vh; overflow-y: auto; }

        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .full-col { grid-column: span 2; }
        
        .btn-del { background: var(--danger); color: white; padding: 5px 10px; border: none; border-radius: 4px; cursor: pointer; }
    </style>
</head>
<body>

<div id="view-login" class="login-screen">
    <div class="login-box">
        <h2 style="color:var(--primary)">FCI LOGISTIX</h2>
        <p>Sistema de Gesti√≥n Documental</p>
        <div class="input-group">
            <label>Usuario</label>
            <input type="text" id="logUser" placeholder="Ej: admin">
        </div>
        <div class="input-group">
            <label>Contrase√±a</label>
            <input type="password" id="logPass" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
        </div>
        <button class="btn-main" onclick="handleLogin()">INGRESAR</button>
    </div>
</div>

<div id="view-app" class="hidden">
    <header>
        <div style="display:flex; align-items:center; gap:15px;">
            <h3 style="margin:0;">FCI | SGD</h3>
            <span id="displayRole" class="badge" style="background:rgba(255,255,255,0.2); color:white;"></span>
        </div>
        <div style="display:flex; align-items:center; gap:25px;">
            <div class="notif-bell" onclick="toggleNotifs()">üîî <div id="notif-dot" class="notif-dot"></div></div>
            <div style="text-align:right">
                <div id="displayName" style="font-weight:bold; font-size:14px;"></div>
                <div id="displayGer" style="font-size:11px; opacity:0.8;"></div>
            </div>
            <button onclick="logout()" style="background:none; border:1px solid white; color:white; cursor:pointer; padding:5px 10px; border-radius:4px;">Salir</button>
        </div>
    </header>

    <nav class="tabs-nav">
        <div class="tab-link active" onclick="switchTab('dashboard')">Inicio</div>
        <div class="tab-link" onclick="switchTab('requests')">Solicitudes</div>
        <div class="tab-link admin-only hidden" onclick="switchTab('users')">Usuarios</div>
        <div class="tab-link admin-only hidden" onclick="switchTab('org')">Organizaci√≥n</div>
    </nav>

    <main class="content-area">
        
        <div id="tab-dashboard" class="tab-content">
            <div class="form-grid" style="grid-template-columns: repeat(4, 1fr);">
                <div class="card" style="text-align:center;"><h3>Total</h3><p id="count-total" style="font-size:24px; font-weight:bold; margin:0;">0</p></div>
                <div class="card" style="text-align:center; color:var(--warning)"><h3>Pendientes</h3><p id="count-pendiente" style="font-size:24px; font-weight:bold; margin:0;">0</p></div>
                <div class="card" style="text-align:center; color:var(--success)"><h3>Finalizados</h3><p id="count-finalizado" style="font-size:24px; font-weight:bold; margin:0;">0</p></div>
                <div class="card" style="text-align:center; color:var(--danger)"><h3>Rechazados</h3><p id="count-rechazado" style="font-size:24px; font-weight:bold; margin:0;">0</p></div>
            </div>
            <div class="card">
                <h3>Actividad Reciente</h3>
                <div id="recent-activity" style="font-size: 14px;"></div>
            </div>
        </div>

        <div id="tab-requests" class="tab-content hidden">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h2>Gesti√≥n de Solicitudes</h2>
                <button class="btn-main" onclick="openNewRequest()" style="width:auto;">+ Nueva Solicitud</button>
            </div>
            <div class="card">
                <div class="table-res">
                    <table id="table-sol">
                        <thead>
                            <tr>
                                <th>C√≥digo</th>
                                <th>Documento</th>
                                <th>Tipo</th>
                                <th>Solicitante</th>
                                <th>Estado</th>
                                <th>Acci√≥n</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="tab-users" class="tab-content hidden">
            <h2>Gesti√≥n de Usuarios</h2>
            <div class="card">
                <h4>Registrar Nuevo Usuario</h4>
                <div class="form-grid">
                    <input type="text" id="u-name" placeholder="Nombre completo">
                    <input type="text" id="u-user" placeholder="Usuario Login">
                    <input type="password" id="u-pass" placeholder="Contrase√±a">
                    <select id="u-role">
                        <option value="Solicitante">Solicitante</option>
                        <option value="Gerente">Gerente de √Årea</option>
                        <option value="Admin">Administrador SGC</option>
                    </select>
                    <select id="u-ger"></select>
                    <button class="btn-main" onclick="createUser()">Guardar Usuario</button>
                </div>
            </div>
            <div class="card">
                <table id="table-users">
                    <thead><tr><th>Nombre</th><th>Usuario</th><th>Rol</th><th>Gerencia</th><th>Acci√≥n</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <div id="tab-org" class="tab-content hidden">
            <h2>Estructura Organizacional</h2>
            <div class="form-grid">
                <div class="card">
                    <h4>Gerencias</h4>
                    <div style="display:flex; gap:10px;">
                        <input type="text" id="new-ger" placeholder="Nombre gerencia">
                        <button class="btn-main" onclick="createOrg('Gerencias', 'new-ger')" style="width:auto;">+</button>
                    </div>
                    <ul id="list-ger" style="margin-top:15px; padding:0; list-style:none;"></ul>
                </div>
                <div class="card">
                    <h4>Departamentos</h4>
                    <div style="display:flex; flex-direction:column; gap:10px;">
                        <select id="sel-ger-for-dep"></select>
                        <div style="display:flex; gap:10px;">
                            <input type="text" id="new-dep" placeholder="Nombre departamento">
                            <button class="btn-main" onclick="createOrg('Departamentos', 'new-dep', 'sel-ger-for-dep')" style="width:auto;">+</button>
                        </div>
                    </div>
                    <ul id="list-dep" style="margin-top:15px; padding:0; list-style:none;"></ul>
                </div>
            </div>
        </div>

    </main>
</div>

<div id="modal-req" class="modal hidden">
    <div class="modal-body">
        <h2 id="modal-title">Nueva Solicitud Documental</h2>
        <div class="form-grid">
            <div class="input-group full-col">
                <label>T√≠tulo del Documento</label>
                <input type="text" id="s-tit">
            </div>
            <div class="input-group">
                <label>Tipo de Documento</label>
                <select id="s-tipo">
                    <option>Procedimiento</option><option>Manual</option><option>Instructivo</option><option>Formato</option>
                </select>
            </div>
            <div class="input-group">
                <label>Acci√≥n a Realizar</label>
                <select id="s-acc" onchange="toggleModifyFields()">
                    <option value="Creaci√≥n">Creaci√≥n</option>
                    <option value="Modificaci√≥n">Modificaci√≥n</option>
                    <option value="Inactivaci√≥n">Inactivaci√≥n</option>
                </select>
            </div>
            <div id="group-modify" class="input-group full-col hidden">
                <label style="color:var(--danger)">C√≥digo del Documento a afectar</label>
                <input type="text" id="s-old-code" placeholder="Ej: PRO-SGC-001">
            </div>
            <div class="input-group full-col">
                <label>Motivo de la Solicitud</label>
                <input type="text" id="s-mot">
            </div>
            <div class="input-group full-col">
                <label>Descripci√≥n detallada</label>
                <textarea id="s-desc" rows="4" style="width:100%; border-radius:6px; border:1px solid #ddd;"></textarea>
            </div>
            <div class="input-group full-col">
                <label>Adjuntar Documentos (Borradores/Sustentos)</label>
                <input type="file" id="s-files" multiple>
            </div>
        </div>
        <div style="display:flex; gap:10px; margin-top:20px;">
            <button class="btn-main" onclick="submitRequest()">Enviar Solicitud</button>
            <button class="btn-main" onclick="closeModal()" style="background:#666;">Cancelar</button>
        </div>
    </div>
</div>

<div id="modal-view" class="modal hidden">
    <div class="modal-body">
        <div style="display:flex; justify-content:space-between;">
            <h2 id="v-id" style="margin:0;">FCI-XXXX</h2>
            <span id="v-est" class="badge"></span>
        </div>
        <hr>
        <div class="form-grid">
            <div>
                <p><strong>Documento:</strong> <span id="v-tit"></span></p>
                <p><strong>Tipo:</strong> <span id="v-tipo"></span></p>
                <p><strong>Acci√≥n:</strong> <span id="v-acc"></span></p>
            </div>
            <div>
                <p><strong>Solicitante:</strong> <span id="v-user"></span></p>
                <p><strong>√Årea:</strong> <span id="v-ger"></span></p>
                <p><strong>Fecha:</strong> <span id="v-date"></span></p>
            </div>
        </div>
        <div style="background:#f9f9f9; padding:15px; border-radius:8px;">
            <strong>Descripci√≥n:</strong>
            <p id="v-desc" style="font-size:14px;"></p>
        </div>
        <div id="v-links" style="margin-top:10px;"></div>

        <div id="admin-actions" class="card hidden" style="border: 2px dashed var(--primary); margin-top:20px;">
            <h4>Panel de Decisiones</h4>
            <div style="display:flex; gap:10px; flex-wrap:wrap;">
                <button class="btn-main" onclick="changeStatus('Revisi√≥n SGC', 'En proceso de validaci√≥n t√©cnica')" style="width:auto; background:var(--secondary)">Iniciar Revisi√≥n</button>
                <button class="btn-main" onclick="changeStatus('Aprobado Gerencia', 'Gerente aprueba contenido')" style="width:auto; background:var(--success)">Aprobaci√≥n Gerencia</button>
                <button class="btn-main" onclick="changeStatus('Finalizado', 'Publicado en el sistema')" style="width:auto; background:var(--primary)">Finalizar/Publicar</button>
                <button class="btn-main" onclick="promptRejection()" style="width:auto; background:var(--danger)">Rechazar</button>
            </div>
        </div>

        <h4>Historial de Trazabilidad</h4>
        <div id="v-hist" style="font-size:12px; max-height:150px; overflow-y:auto; background:#eee; padding:10px;"></div>
        
        <button class="btn-main" onclick="closeModal()" style="margin-top:20px; background:#666;">Cerrar</button>
    </div>
</div>

<script>
// --- CONFIGURACI√ìN FIREBASE ---
const firebaseConfig = {
    apiKey: "AIzaSyDdzCiachuhbE9jATz-TesPI2vUVIJrHjM",
    authDomain: "sistemadegestion-7400d.firebaseapp.com",
    projectId: "sistemadegestion-7400d",
    storageBucket: "sistemadegestion-7400d.appspot.com",
    messagingSenderId: "709030283072",
    appId: "1:709030283072:web:5997837b36a448e9515ca5"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// Cloudinary
const cloudName = "df79cjklp";
const uploadPreset = "fci_documentos";

let currentUser = null;
let currentSolId = null;

// --- AUTENTICACI√ìN ---
async function handleLogin() {
    const u = document.getElementById("logUser").value;
    const p = document.getElementById("logPass").value;
    
    const snap = await db.collection("Users").where("user", "==", u).where("pass", "==", p).get();
    if(!snap.empty) {
        currentUser = { id: snap.docs[0].id, ...snap.docs[0].data() };
        localStorage.setItem("fci_user", JSON.stringify(currentUser));
        startApp();
    } else { alert("Usuario o clave incorrectos"); }
}

function startApp() {
    document.getElementById("view-login").classList.add("hidden");
    document.getElementById("view-app").classList.remove("hidden");
    
    document.getElementById("displayName").innerText = currentUser.name;
    document.getElementById("displayGer").innerText = currentUser.gerencia;
    document.getElementById("displayRole").innerText = currentUser.role;

    if(currentUser.role === "Admin") {
        document.querySelectorAll(".admin-only").forEach(el => el.classList.remove("hidden"));
    }
    
    loadGlobalData();
    switchTab('dashboard');
}

function logout() { localStorage.clear(); location.reload(); }

// --- NAVEGACI√ìN ---
function switchTab(tabId) {
    document.querySelectorAll(".tab-link").forEach(l => l.classList.remove("active"));
    document.querySelectorAll(".tab-content").forEach(c => c.classList.add("hidden"));
    
    event?.target?.classList?.add("active");
    document.getElementById("tab-" + tabId).classList.remove("hidden");
}

// --- CARGA DE DATOS ---
function loadGlobalData() {
    // Escuchar Gerencias
    db.collection("Gerencias").onSnapshot(s => {
        let h = "";
        s.forEach(doc => {
            h += `<option value="${doc.data().nombre}">${doc.data().nombre}</option>`;
            if(currentUser.role === 'Admin') renderList("list-ger", doc.data().nombre, doc.id, "Gerencias");
        });
        document.getElementById("u-ger").innerHTML = h;
        document.getElementById("sel-ger-for-dep").innerHTML = h;
    });

    // Escuchar Solicitudes (Filtro por Rol)
    let query = db.collection("Solicitudes").orderBy("fecha", "desc");
    
    if(currentUser.role === "Solicitante") {
        query = query.where("userId", "==", currentUser.id);
    } else if (currentUser.role === "Gerente") {
        query = query.where("gerencia", "==", currentUser.gerencia);
    }

    query.onSnapshot(s => {
        const tbody = document.querySelector("#table-sol tbody");
        tbody.innerHTML = "";
        let stats = {t:0, p:0, f:0, r:0};

        s.forEach(doc => {
            const d = doc.data();
            stats.t++;
            if(d.estado === "Pendiente") stats.p++;
            else if(d.estado === "Finalizado") stats.f++;
            else if(d.estado === "Rechazado") stats.r++;

            tbody.innerHTML += `
                <tr>
                    <td><span class="badge" style="background:#333; color:white;">${d.fciId}</span></td>
                    <td><strong>${d.titulo}</strong></td>
                    <td>${d.tipo}</td>
                    <td>${d.userName}</td>
                    <td><span class="badge st-${d.estado.toLowerCase().replace(" ","")}">${d.estado}</span></td>
                    <td><button class="btn-main" style="width:auto; padding:5px 10px" onclick="viewDetail('${doc.id}')">Ver</button></td>
                </tr>
            `;
        });
        updateDashboard(stats);
    });

    // Si es admin, cargar usuarios
    if(currentUser.role === "Admin") {
        db.collection("Users").onSnapshot(s => {
            const tb = document.querySelector("#table-users tbody");
            tb.innerHTML = "";
            s.forEach(doc => {
                const u = doc.data();
                tb.innerHTML += `<tr><td>${u.name}</td><td>${u.user}</td><td>${u.role}</td><td>${u.gerencia}</td>
                <td><button class="btn-del" onclick="deleteDoc('Users','${doc.id}')">Eliminar</button></td></tr>`;
            });
        });
    }
}

function updateDashboard(s) {
    document.getElementById("count-total").innerText = s.t;
    document.getElementById("count-pendiente").innerText = s.p;
    document.getElementById("count-finalizado").innerText = s.f;
    document.getElementById("count-rechazado").innerText = s.r;
}

// --- ACCIONES CRUD ---
async function submitRequest() {
    const tit = document.getElementById("s-tit").value;
    if(!tit) return alert("T√≠tulo requerido");

    const idFci = await getNextID();
    let urls = [];
    const files = document.getElementById("s-files").files;

    for(let f of files) {
        let fd = new FormData(); fd.append("file", f); fd.append("upload_preset", uploadPreset);
        let res = await fetch(`https://api.cloudinary.com/v1_1/${cloudName}/upload`, {method:"POST", body:fd});
        let j = await res.json(); urls.push(j.secure_url);
    }

    await db.collection("Solicitudes").add({
        fciId: idFci,
        titulo: tit,
        tipo: document.getElementById("s-tipo").value,
        accion: document.getElementById("s-acc").value,
        oldCode: document.getElementById("s-old-code").value,
        motivo: document.getElementById("s-mot").value,
        descripcion: document.getElementById("s-desc").value,
        documentos: urls,
        estado: "Pendiente",
        fecha: new Date(),
        userId: currentUser.id,
        userName: currentUser.name,
        gerencia: currentUser.gerencia,
        historial: [{fecha: new Date(), msj: "Solicitud creada por " + currentUser.name}]
    });

    closeModal();
    alert("Solicitud Enviada con √âxito");
}

async function viewDetail(id) {
    currentSolId = id;
    const doc = await db.collection("Solicitudes").doc(id).get();
    const d = doc.data();

    document.getElementById("v-id").innerText = d.fciId;
    document.getElementById("v-tit").innerText = d.titulo;
    document.getElementById("v-tipo").innerText = d.tipo;
    document.getElementById("v-acc").innerText = d.accion + (d.oldCode ? ` (${d.oldCode})` : '');
    document.getElementById("v-user").innerText = d.userName;
    document.getElementById("v-ger").innerText = d.gerencia;
    document.getElementById("v-date").innerText = new Date(d.fecha.seconds*1000).toLocaleDateString();
    document.getElementById("v-desc").innerText = d.descripcion;
    document.getElementById("v-est").innerText = d.estado;
    document.getElementById("v-est").className = "badge st-" + d.estado.toLowerCase().replace(" ","");

    let h = "";
    d.historial.forEach(ev => h += `<div>‚Ä¢ ${new Date(ev.fecha.seconds*1000).toLocaleString()}: ${ev.msj}</div>`);
    document.getElementById("v-hist").innerHTML = h;

    // Mostrar panel de acciones si es Admin o Gerente
    if(currentUser.role !== "Solicitante") {
        document.getElementById("admin-actions").classList.remove("hidden");
    } else {
        document.getElementById("admin-actions").classList.add("hidden");
    }

    document.getElementById("modal-view").classList.remove("hidden");
}

async function changeStatus(newStatus, comment) {
    const snap = await db.collection("Solicitudes").doc(currentSolId).get();
    let hist = snap.data().historial;
    hist.push({fecha: new Date(), msj: `${newStatus} por ${currentUser.name}: ${comment}`});

    await db.collection("Solicitudes").doc(currentSolId).update({
        estado: newStatus,
        historial: hist
    });
    
    // Notificaci√≥n
    await db.collection("Notificaciones").add({
        target: snap.data().userId,
        text: `Tu solicitud ${snap.data().fciId} cambi√≥ a ${newStatus}`,
        read: false,
        fecha: new Date()
    });

    closeModal();
}

// --- UTILIDADES ---
async function getNextID() {
    const ref = db.collection("Config").doc("counts");
    return db.runTransaction(async (t) => {
        const d = await t.get(ref);
        const next = d.exists ? d.data().sol + 1 : 1;
        t.set(ref, {sol: next});
        return "FCI-SGD-" + next.toString().padStart(4, '0');
    });
}

function deleteDoc(col, id) {
    if(confirm("¬øEst√°s seguro de eliminar este registro de forma permanente?")) {
        db.collection(col).doc(id).delete();
    }
}

function createOrg(col, inpId, selId = null) {
    const val = document.getElementById(inpId).value;
    if(!val) return;
    const data = { nombre: val };
    if(selId) data.parent = document.getElementById(selId).value;
    db.collection(col).add(data);
    document.getElementById(inpId).value = "";
}

function renderList(listId, val, id, col) {
    const ul = document.getElementById(listId);
    const li = document.createElement("li");
    li.style = "display:flex; justify-content:space-between; margin-bottom:5px; background:#f0f0f0; padding:5px 10px; border-radius:4px;";
    li.innerHTML = `${val} <button class="btn-del" onclick="deleteDoc('${col}','${id}')">x</button>`;
    ul.appendChild(li);
}

function toggleModifyFields() {
    const acc = document.getElementById("s-acc").value;
    document.getElementById("group-modify").classList.toggle("hidden", acc === "Creaci√≥n");
}

async function createUser() {
    await db.collection("Users").add({
        name: document.getElementById("u-name").value,
        user: document.getElementById("u-user").value,
        pass: document.getElementById("u-pass").value,
        role: document.getElementById("u-role").value,
        gerencia: document.getElementById("u-ger").value
    });
    alert("Usuario Creado");
}

function openNewRequest() { document.getElementById("modal-req").classList.remove("hidden"); }
function closeModal() { 
    document.querySelectorAll(".modal").forEach(m => m.classList.add("hidden")); 
}

// Persistencia de sesi√≥n
const saved = localStorage.getItem("fci_user");
if(saved) {
    currentUser = JSON.parse(saved);
    startApp();
}
</script>
</body>
</html>
